"use strict";{const e=self,t=e,n=e.document;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["js_dlg_config-dialog_js"],{4429:(e,a,o)=>{o.r(a),a.default=async function(style){let bodyStyle,ucd,varsHash,varNames,vars,varsInitial,saving=!1;"number"==typeof style&&(style=await l.API.styles.getCore({id:style,vars:!0}));init(!1,!1);const isPopup="stylus-popup"===n.body.id,colorpicker=vars.some(e=>"color"===e.type)?(await Promise.all([o.e("js_color_color-picker_js"),o.e("js_color_color-picker_css")]).then(o.bind(o,8976))).default():null,elBody=s.$create(".config-body"),btnSave=s.$create("button[data-cmd=save]",{disabled:!0,onclick:save},u.t("confirmSave")),btnDefault=s.$create("button[data-cmd=default]",{disabled:!0,onclick:function(){for(const e of vars)e.value=null,onchange({target:e.input});renderValues()},title:u.t("optionsReset")},u.t("genericResetLabel")),btnClose=s.$create("button[data-cmd=close]",u.t("confirmClose"));return i.messageBox.show({title:`${style.customName||style.name} v${ucd.version}`,className:"config-dialog",contents:[s.$create(".config-heading",ucd.supportURL&&s.$createLink({className:".external-support",href:ucd.supportURL},u.t("externalFeedback"))),elBody],buttons:[btnSave,btnDefault,btnClose],onshow:function(box){n.querySelector("#message-box-buttons button").after(s.$create("label#config-autosave-wrapper",{title:u.t("configOnChangeTooltip")},[s.$create("input",{id:"config.autosave",type:"checkbox"}),u.t("configOnChange")])),i.setupLivePrefs(["config.autosave"]),box.on("change",onchange),init(null,box)}}).then(onhide);function getInitialValues(source){const data={};for(const name of varNames){const e=source[name];data[name]=isDefault(e)?e.default:e.value}return data}function init(newUCD,box=i.messageBox.element){var e;!newUCD&&ucd||(ucd=newUCD||style.usercssData,Object.defineProperty(style,"usercssData",{get:()=>ucd,set:init}),varsHash=u.deepCopy(ucd.vars)||{},varNames=Object.keys(varsHash),vars=varNames.map(name=>varsHash[name]),varsInitial=getInitialValues(varsHash)),box&&(elBody.textContent="",buildConfigForm(),renderValues(),vars.forEach(renderValueState),box.style.setProperty("--num",vars.length),isPopup&&!p.MOBILE&&adjustSizeForPopup(box),updateButtons(),(e=n.getElementById("message-box-contents")).classList.toggle("sb-overlay",e.offsetWidth===e.clientWidth&&e.scrollHeight>e.clientHeight))}function onhide(){Object.defineProperty(style,"usercssData",{value:ucd}),null!=bodyStyle&&(n.body.style.cssText=bodyStyle),colorpicker?.hide()}function onchange({target,justSaved=!1}){const e=target.va;if(e){if(e.dirty=varsInitial[e.name]!==(isDefault(e)?e.default:e.value),r.__values["config.autosave"]&&!justSaved)return void u.debounce(save,400,{anyChangeIsDirty:!0});renderValueState(e),justSaved||updateButtons()}}function updateButtons(){const someDirty=vars.some(e=>e.dirty);btnSave.disabled=!someDirty,btnDefault.disabled=vars.every(isDefault),btnClose.textContent=u.t(someDirty?"confirmCancel":"confirmClose")}async function save({anyChangeIsDirty=!1}={}){for(let delay=1;saving&&delay<1e3;delay*=2)await u.sleep(delay);if(saving)throw"Could not save: still saving previous results...";if(!vars.some(e=>e.dirty||anyChangeIsDirty&&e.value!==e.savedValue))return;const bgStyle=style.id&&await l.API.styles.getCore({id:style.id,vars:!0}).catch(()=>({}));style.enabled=!0;const styleVars=style.usercssData.vars,bgVars=style.id?bgStyle.usercssData?.vars||{}:styleVars,invalid=[];let numValid=0;for(const e of vars){const bgva=bgVars[e.name];let error;if(bgva)if(bgva.type!==e.type)error=["type ","*"+e.type," != ","*"+bgva.type];else{if("select"!==e.type&&"dropdown"!==e.type||isDefault(e)||!bgva.options.every(t=>t.name!==e.value)){if(e.dirty||anyChangeIsDirty&&e.value!==e.savedValue){styleVars[e.name].value=e.value,e.savedValue=e.value,numValid++;continue}continue}error=`'${e.value}' not in the updated '${e.type}' list`}else error="deleted",delete styleVars[e.name];invalid.push(["*"+e.name,": ",...error].map(e=>"*"===e[0]&&s.$create("b",e.slice(1))||e)),bgva&&(styleVars[e.name].value=u.deepCopy(bgva))}if(invalid.length&&(onhide(),i.messageBox.alert([s.$create("div",{style:"max-width: 34em"},u.t("usercssConfigIncomplete")),s.$create("ol",{style:"text-align: left"},invalid.map(msg=>s.$create("li",msg)))],"pre")),numValid){saving=!0;try{const newVars=style.id?await l.API.usercss.configVars(style.id,styleVars):styleVars;varsInitial=getInitialValues(newVars),vars.forEach(e=>onchange({target:e.input,justSaved:!0})),renderValues(),updateButtons(),n.querySelector(".config-error")?.remove()}catch(t){const e=i.messageBox.element.$(".config-error")||n.getElementById("message-box-buttons").insertAdjacentElement("afterbegin",s.$create(".config-error"));e.textContent=e.title=(Array.isArray(t)?t:[t]).map(e=>e.stack||e.message||`${e}`).join("\n")}saving=!1}}function isDefault(e){return null==e.value||e.value===e.default}function buildConfigForm(){const elements=[];let resetter=s.$create("a.config-reset-icon",{tabIndex:0,title:u.t("genericResetLabel")},s.$create("i.i-close"));for(const e of vars){let children;switch(e.type){case"color":children=[s.$create(".colorview-swatch.config-value",[e.input=s.$create("a.color-swatch",{va:e,tabIndex:0,onclick:showColorpicker})])];break;case"checkbox":children=[e.input=s.$create("input.slider.config-value",{va:e,type:"checkbox",onchange:updateVarOnChange})];break;case"select":case"dropdown":case"image":children=[s.$create(".select-wrapper.config-value",[e.input=s.$create("select",{va:e,onchange:updateVarOnChange},e.options.map(e=>s.$create("option",{value:e.name},e.label)))])];break;case"range":case"number":{const options={va:e,type:e.type,onfocus:"number"===e.type?selectAllOnFocus:null,onblur:"number"===e.type?updateVarOnBlur:null,onchange:updateVarOnChange,oninput:updateVarOnChange,required:!0};"number"==typeof e.min&&(options.min=e.min),"number"==typeof e.max&&(options.max=e.max),"number"==typeof e.step&&isFinite(e.step)&&(options.step=e.step),children=["range"===e.type&&s.$create("span.current-value"),e.input=s.$create("input.config-value",options)].filter(Boolean);break}default:children=[e.input=s.$create("input.config-value",{va:e,type:e.type,onchange:updateVarOnChange,oninput:updateVarOnChange,onfocus:selectAllOnFocus})]}resetter=resetter.cloneNode(!0),resetter.va=e,resetter.onclick=resetOnClick,elements.push(s.$create(`label.config-${e.type}`,[s.$create("span.config-name",c.breakWord(e.label)),...children,resetter])),e.savedValue=e.value}elBody.append(...elements)}function updateVarOnBlur(){this.value=isDefault(this.va)?this.va.default:this.va.value}function updateVarOnChange(e){let val;if("text"===this.type)val=this.value;else if("range"===this.type)val=this.valueAsNumber,updateRangeCurrentValue(this.va,this.value);else{if("number"!==this.type)return void(this.va.value="checkbox"!==this.type?this.value:this.checked?"1":"0");if(!this.reportValidity())return;val=this.valueAsNumber}Number.isNaN(val)||(this.va.value=val,"input"===e.type&&onchange(e))}function updateRangeCurrentValue(e,value){const span=e.input.closest(".config-range").$(".current-value");span&&(span.textContent=value+(e.units||""))}function selectAllOnFocus(){this.select()}function renderValues(varsToRender=vars){for(const e of varsToRender){if(e.input===n.activeElement)continue;const value=isDefault(e)?e.default:e.value;"color"===e.type?(e.input.style.backgroundColor=value,colorpicker.options.va===e&&colorpicker.setColor(value)):"checkbox"===e.type?e.input.checked=Number(value):"range"===e.type?(e.input.value=value,updateRangeCurrentValue(e,e.input.value)):e.input.value=value,r.__values["config.autosave"]||renderValueState(e)}}function renderValueState(e){const t=e.input.closest("label");t.classList.toggle("dirty",Boolean(e.dirty)),t.classList.toggle("nondefault",!isDefault(e)),t.$(".config-reset-icon").disabled=isDefault(e)}function resetOnClick(event){event.preventDefault(),this.va.value=null,renderValues([this.va]),onchange({target:this.va.input})}function showColorpicker(event){event.preventDefault(),t.off("keydown",i.messageBox.listeners.key,!0);const box=n.getElementById("message-box-contents"),e=this.getBoundingClientRect();colorpicker.show({va:this.va,color:this.va.value||this.va.default,top:Math.min(e.bottom,innerHeight-220),right:innerWidth-e.left-10,guessBrightness:box,callback:onColorChanged})}function onColorChanged(newColor){newColor&&(this.va.value=newColor,this.va.input.style.backgroundColor=newColor,this.va.input.dispatchEvent(new Event("change",{bubbles:!0}))),u.debounce(restoreEscInDialog)}function restoreEscInDialog(){!n.querySelector(".colorpicker-popup")&&i.messageBox.element&&t.on("keydown",i.messageBox.listeners.key,!0)}function adjustSizeForPopup(box){const contents=box.firstElementChild;contents.style=i.important("max-width: none; max-height: none;");let{offsetWidth:width,offsetHeight:height}=contents;contents.style="";const dpr=devicePixelRatio,elPicker=n.body.appendChild(s.$create(".colorpicker-popup",{style:"display: none!important"})),PADDING=50/dpr,MIN_WIDTH=parseFloat(getComputedStyle(elPicker).width)||350/dpr,MIN_HEIGHT=250/dpr+PADDING;elPicker.remove();const e=n.body.style;width=u.clamp(width+PADDING,MIN_WIDTH,798/dpr),height=u.clamp(height+PADDING,MIN_HEIGHT,parseInt(e.maxHeight)||598/dpr),bodyStyle=e.cssText,e.cssText=bodyStyle.replace(/((min|max)-width|min-height)\s*:[^;]+|;\s*$/g,"")+`;\n      min-width:${width}px !important;\n      min-height:${height}px !important;`}};var s=o(7986),i=o(3831),c=o(7501),l=o(4930),r=o(492),u=o(6940),p=o(8970)}}])}