"use strict";{const e=self,t=e,n=e.document,o=n.documentElement,i=o.classList;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["edit","js_color_color-picker_css"],{1095:(e,t,n)=>{t.default='<div><span class=rel><input id=ss-updatable type=checkbox><label i18n=installUpdateFromLabel for=ss-updatable></label></span><input id=ss-update-url type=url class=w100 i18n=placeholder:styleUpdateUrlLabel></div><div id=ss-scheme><div i18n=preferScheme><div><small id=ss-scheme-off i18n=preferSchemeAlways hidden></small></div></div><label i18n=+preferSchemeNone class=radio-wrapper><input name=ss-scheme type=radio value=none></label><label i18n=+preferSchemeDark class=radio-wrapper><input name=ss-scheme type=radio value=dark></label><label i18n=+preferSchemeLight class=radio-wrapper><input name=ss-scheme type=radio value=light></label></div><label i18n=styleIncludeLabel><textarea id=ss-inclusions spellcheck=false class=w100 placeholder=*://www.aaa.com/*></textarea></label><label i18n=styleExcludeLabel><textarea id=ss-exclusions spellcheck=false class=w100 placeholder=*://www.aaa.com/*></textarea></label><div class=buttons><button id=ss-save i18n=confirmSave disabled></button>&nbsp;<label i18n="+configOnChange, title:configOnChangeTooltip"><input id=config.autosave type=checkbox></label></div>'},8544:(e,o,i)=>{var s=i(6199),l=i(4849),r=i(8970),a=i(9920),c=i(492);const cms=new Set,cmDefaults=s.CodeMirror.defaults,cmFactory={create(place,options){const e=s.CodeMirror(place,options);return e.display.lineDiv.on("mousewheel",plusMinusOnWheel.bind(e),!0),105!==r.CHROME&&e.display.wrapper.style.removeProperty("clip-path"),e.lastActive=0,cms.add(e),e},destroy(e){cms.delete(e)},globalSetOption(key,value){cmDefaults[key]=value,cms.size>4&&lazyOpt.names.includes(key)?lazyOpt.set(key,value):cms.forEach(e=>e.setOption(key,value))}},onCmFocus=e=>{l.rerouteHotkeys.toggle(!1),e.display.wrapper.classList.add("CodeMirror-active"),e.lastActive=Date.now()},onCmBlur=e=>{setTimeout(()=>{l.rerouteHotkeys.toggle(!0);const{wrapper}=e.display;wrapper.classList.toggle("CodeMirror-active",wrapper.contains(n.activeElement))})};s.CodeMirror.defineInitHook(e=>{e.on("focus",onCmFocus),e.on("blur",onCmBlur)});const prefToCmOpt=e=>e.startsWith("editor.")&&e.slice(7),prefKeys=c.knownKeys.filter(e=>"editor.colorpicker"!==e&&"editor.arrowKeysTraverse"!==e&&prefToCmOpt(e)in s.CodeMirror.defaults),{insertTab,insertSoftTab}=s.CodeMirror.commands;c.ready.then(()=>{for(const key of prefKeys)cmDefaults[prefToCmOpt(key)]=c.__values[key];for(const[key,e]of Object.entries({"editor.tabSize"(e,value){e.setOption("indentUnit",Number(value))},"editor.indentWithTabs"(e,value){s.CodeMirror.commands.insertTab=value?insertTab:insertSoftTab},"editor.matchHighlight"(e,value){const showToken="token"===value&&/[#.\-\w]/;e.setOption("highlightSelectionMatches",(showToken||"selection"===value)&&{showToken,annotateScrollbar:!0,delay:0,onUpdate:updateMatchHighlightCount}||null)},"editor.selectByTokens"(e,value){e.setOption("configureMouse",value?configureMouseFn:null)}}))s.CodeMirror.defineOption(prefToCmOpt(key),c.__values[key],e),prefKeys.push(key)}),c.subscribe(prefKeys,(key,val)=>{key===s.THEME_KEY&&s.loadCmTheme(val),cmFactory.globalSetOption(prefToCmOpt(key),val)});const lazyOpt={names:["theme","lineWrapping"],set(key,value){const{observer,queue}=lazyOpt;for(const e of cms){let opts=queue.get(e);opts||queue.set(e,opts={}),opts[key]=value,observer.observe(e.display.wrapper)}},setNow({cm:e,data}){e.operation(()=>data.forEach(t=>e.setOption(...t)))},onView(entries){const{queue,observer}=lazyOpt,delayed=[];for(const e of entries){const n=e.intersectionRatio&&e.intersectionRect;if(!n)continue;const o=e.target.CodeMirror,data=Object.entries(queue.get(o)||{});queue.delete(o),observer.unobserve(e.target),data.every(([key,val])=>o.getOption(key)===val)||(n.bottom>0&&n.top<t.innerHeight?lazyOpt.setNow({cm:o,data}):delayed.push({cm:o,data}))}delayed.length&&setTimeout(()=>delayed.forEach(lazyOpt.setNow))},get observer(){return lazyOpt._observer||(lazyOpt._observer=new IntersectionObserver(lazyOpt.onView,{rootMargin:"150%"}),lazyOpt.queue=new WeakMap),lazyOpt._observer}};Object.assign(s.CodeMirror.commands,{commentSelection(e){e.blockComment(e.getCursor("from"),e.getCursor("to"),{fullLines:!1})},minus1:plusMinus.bind(null,-1),minus10:plusMinus.bind(null,-10),minus100:plusMinus.bind(null,-100),plus1:plusMinus.bind(null,1),plus10:plusMinus.bind(null,10),plus100:plusMinus.bind(null,100),toggleEditorFocus(e){e&&(e.hasFocus()?setTimeout(()=>e.display.input.blur()):e.focus())}});for(const cmd of["nextEditor","prevEditor","save","toggleStyle"])s.CodeMirror.commands[cmd]=(...args)=>a.default[cmd](...args);function plusMinusOne(delta,e,pos=e.getCursor(),inOp){const{line,ch:t}=pos,{text}=e.getLineHandle(line);let n=/[-+\d.%a-z]/iy,o=n.lastIndex=t;n.test(text)||(o+=!o||(n.lastIndex=o-1,n.test(text))?-1:1);do{n.lastIndex=o}while(o>t-20&&(n.test(text)?--o>=0:(++o,0)));if(n=/[-+]?(\d*\.)?(\d+)/y,n.lastIndex=o,n=n.exec(text),n)return n[0].includes(".")&&(delta/=10),inOp=inOp&&(e.curOp||(e.startOperation(),!0)),e.replaceRange((+n[0]+delta).toFixed(n[1]?n[2].length:0),{line,ch:o},{line,ch:o+n[0].length},"*incdec"+line+":"+o),inOp}function plusMinus(delta,e){let t;for(const sel of e.doc.sel.ranges)plusMinusOne(delta,e,sel.head,!t)&&(t=!0);!0===t&&e.endOperation()}function plusMinusOnWheel(e){e.altKey&&(e.preventDefault(),plusMinusOne((e.ctrlKey?100:e.shiftKey?10:1)*(e.wheelDeltaY>0?1:-1),this,this.coordsChar({left:e.clientX,top:e.clientY},"window")))}function updateMatchHighlightCount(e,state){e.display.wrapper.dataset.matchHighlightCount=state.matchesonscroll.matches.length}function configureMouseFn(e,repeat){return"double"===repeat?{unit:selectTokenOnDoubleclick}:{}}function selectTokenOnDoubleclick(e,pos){let{ch:t}=pos;const{line,sticky}=pos,{text,styles}=e.getLineHandle(line),execAt=(e,t)=>(e.lastIndex=t,e.exec(text)),n=(e,t)=>(e.lastIndex=t,e.test(text)),atWord=e=>n(/\w/y,e),atSpace=e=>n(/\s/y,e),atTokenEnd=styles.indexOf(t,1);t+=atTokenEnd<0||"before"===sticky&&atWord(t-1)||atSpace(t+1)?0:1,t=Math.min(text.length,t);const type=e.getTokenTypeAt({line,ch:t+("after"===sticky?1:0)});atTokenEnd>0&&t--;const isCss=type&&!/^(comment|string)/.test(type),isNumber="number"===type,isSpace=atSpace(t);let o,found,wordChars=isNumber?/[-+\w.%]/y:isCss?/[-\w@]/y:isSpace?/\s/y:atWord(t)?/\w/y:/[^\w\s]/y,i=t;for(;i&&n(wordChars,i);)i--;return i+=!i&&n(wordChars,i)||isCss&&n(/[.!#@]/y,i)?0:n(wordChars,i+1),isNumber&&(o=i+execAt(/[+-]?[\d.]+(e\d+)?|$/iy,i)[0].length,found=o>=t,found||(i=o,t=i)),found||(wordChars=isCss?/[-\w]*/y:new RegExp(wordChars.source+"*","uy"),o=t+execAt(wordChars,t)[0].length),{from:{line,ch:i},to:{line,ch:o}}}const BM_BRAND="sublimeBookmark",BM_CLICKER="CodeMirror-linenumbers",BM_DATA=Symbol("data"),tmProto=s.CodeMirror.TextMarker.prototype,tmProtoOvr={};for(const e of["clear","attachLine","detachLine"])tmProtoOvr[e]=function(line){const{cm:t}=this.doc,withOp=!t.curOp;withOp&&t.startOperation(),tmProto[e].apply(this,arguments),t.curOp.ownsGroup.delayedCallbacks.push(toggleMark.bind(this,this.lines[0],line)),withOp&&t.endOperation()};for(const name of["prevBookmark","nextBookmark"]){const cmdFn=s.CodeMirror.commands[name];s.CodeMirror.commands[name]=e=>{e.setSelection=e.jumpToPos,cmdFn(e),delete e.setSelection}}function onGutterClick(e,line,name,t){switch(name===BM_CLICKER&&t.button){case 0:{const[mark]=e.findMarks({line,ch:0},{line,ch:1e9},e=>e[BM_BRAND]);e.setCursor(mark?mark.find(-1):{line,ch:0}),e.execCommand("toggleBookmark");break}case 1:e.execCommand("selectBookmarks")}}function onGutterContextMenu(e,line,name,t){name===BM_CLICKER&&(e.execCommand(t.ctrlKey?"prevBookmark":"nextBookmark"),t.preventDefault())}function onMarkAdded(e,mark){mark[BM_BRAND]&&(mark.inclusiveRight=!0,Object.assign(mark,tmProtoOvr),toggleMark.call(mark,!0,mark[BM_DATA]=mark.lines[0]))}function toggleMark(state,line=this[BM_DATA]){if(this.doc[state?"addLineClass":"removeLineClass"](line,"gutter","gutter-bookmark"),state){const bms=this.doc.cm.state.sublimeBookmarks;bms.includes(this)||bms.push(this)}}s.CodeMirror.defineInitHook(e=>{e.on("gutterClick",onGutterClick),e.on("gutterContextMenu",onGutterContextMenu),e.on("markerAdded",onMarkAdded)});o.default=cmFactory},8304:(e,t,o)=>{t.default=function(){const{isUsercss}=a.default,elHeader=i.$create("div",{style:l.important("\n      top: 0;\n      height: 1px;\n      position: absolute;\n      visibility: hidden;\n    ")}),scroller=isUsercss?n.querySelector(".CodeMirror-scroll"):n.body,xoRoot=isUsercss?scroller:void 0,e=new IntersectionObserver(function(entries){sticky=!entries.pop().intersectionRatio,isUsercss||(scroller.style.paddingTop=sticky?c.offsetHeight+"px":"");toggleSticky(sticky)},{root:xoRoot}),elInfo=n.querySelector("h1 a");scroller.appendChild(elHeader),s.mqCompact(val=>{val?(e.observe(elHeader),n.getElementById("basic-info-name").after(elInfo)):(e.disconnect(),n.querySelector("h1").append(elInfo))})};var i=o(7986),s=o(9073),l=o(3831),r=o(7501),a=o(9920);const c=r.template.body.$("#header"),toggleSticky=val=>c.classList.toggle("sticky",val);let sticky;t.toggleSticky=toggleSticky,o.d(t,{sticky:()=>sticky})},9920:(e,o,s)=>{o.failRegexp=failRegexp;var dom=s(7986),prefs=s(492),util=s(6940),compact_header=s(8304);const dirty=function(){const data=new Map,listeners=new Set,dataListeners=new Set,notifyChange=wasDirty=>{const isDirty=data.size>0,flipped=isDirty!==wasDirty;flipped&&listeners.forEach(e=>e(isDirty)),(flipped||isDirty)&&dataListeners.forEach(e=>e(isDirty))};return{add(obj,value){const wasDirty=data.size>0,saved=data.get(obj);if(saved){if("remove"!==saved.type)return;saved.savedValue===value?data.delete(obj):(saved.newValue=value,saved.type="modify")}else data.set(obj,{type:"add",newValue:value});notifyChange(wasDirty)},clear(e){data.size&&(e?data.delete(e):(data.clear(),1))&&notifyChange(!0)},has:key=>data.has(key),isDirty:()=>data.size>0,modify(obj,oldValue,newValue){const wasDirty=data.size>0,saved=data.get(obj);if(saved)if("modify"===saved.type)saved.savedValue===newValue?data.delete(obj):saved.newValue=newValue;else{if("add"!==saved.type)return;saved.newValue=newValue}else{if(oldValue===newValue)return;data.set(obj,{type:"modify",savedValue:oldValue,newValue})}notifyChange(wasDirty)},onChange(e,add=!0){listeners[add?"add":"delete"](e)},onDataChange(e,add=!0){dataListeners[add?"add":"delete"](e)},remove(obj,value){const wasDirty=data.size>0,saved=data.get(obj);if(saved)if("add"===saved.type)data.delete(obj);else{if("modify"!==saved.type)return;saved.type="remove"}else data.set(obj,{type:"remove",savedValue:value});notifyChange(wasDirty)}}}(),regexps=new Set,toc=[];let style;toc.cls="current";let wasDirty=!1;const editor=self.editor={dirty,isUsercss:!1,isWindowed:!1,livePreviewLazy:e=>util.debounce(e,1e3*prefs.__values["editor.livePreview.delay"]),nameTarget:"name",ppDemo:{stylus:"https://stylus-lang.com/try.html",less:"https://lesscss.org/less-preview/"},regexps,saving:!1,scrollInfo:{},get style(){return style},set style(val){style=val},toc,applyScrollInfo(e,t=editor.scrollInfo.cms?.[0]){if(t&&t.sel){const bmOpts={sublimeBookmark:!0,clearWhenEmpty:!1},bms=e.state.sublimeBookmarks=[];for(const n of t.bookmarks)bms.push(e.markText(n.from,n.to,bmOpts));return e.setSelections(...t.sel,{scroll:!1}),Object.assign(e.display.scroller,t.scroll),Object.assign(e.doc,t.scroll),t}},cancel:()=>location.assign("/manage.html"),makeScrollInfo:()=>({sticky:compact_header.sticky,scrollY:t.scrollY,cms:editor.getEditors().map(e=>({bookmarks:(e.state.sublimeBookmarks||[]).map(e=>e.find()),focus:e.hasFocus(),height:e.display.wrapper.style.height.replace("100vh",""),parentHeight:e.display.wrapper.parentElement.offsetHeight,scroll:util.mapObj(e.doc,null,["scrollLeft","scrollTop"]),sel:[e.doc.sel.ranges,e.doc.sel.primIndex],viewTo:e.display.viewTo}))}),async save(){dirty.isDirty()&&(editor.saving=!0,await editor.saveImpl())},toggleRegexp(e,type){let hide;"regexp"===type?(e.on("input",validateRegexp),1===regexps.add(e).size&&(hide=!1)):(e.setCustomValidity(""),e.off("input",validateRegexp),regexps.delete(e)&&!regexps.size&&(hide=!0)),null!=hide&&(n.getElementById("testRE").hidden=hide)},toggleStyle(enabled=!style.enabled){n.getElementById("enabled").checked=enabled,editor.updateEnabledness(enabled)},updateClass(){i.toggle("is-new-style",!editor.style.id)},updateDirty(){const isDirty=dirty.isDirty();wasDirty!==isDirty&&(wasDirty=isDirty,n.body.classList.toggle("dirty",isDirty),n.getElementById("save-button").disabled=!isDirty),editor.updateTitle()},updateEnabledness(enabled){dirty.modify("enabled",style.enabled,enabled),style.enabled=enabled,editor.updateLivePreview()},updateName(isUserInput){if(editor){if(isUserInput){const{value}=n.getElementById("name");dirty.modify("name",style[editor.nameTarget]||style.name,value),style[editor.nameTarget]=value}editor.updateTitle()}},updateTitle(isDirty=editor.dirty.isDirty()){const{customName,name}=editor.style;n.title=`${isDirty?"* ":""}${customName||name||util.t("styleMissingName")} - Stylus`},updateToc(added){const{sections}=editor;toc.el||(toc.el=n.getElementById("toc"),toc.elDetails=toc.el.closest("details"),toc.title=n.getElementById("toc-title").dataset);let num=0;for(const sec of sections)num+=!sec.removed;if((+toc.title.num||1)!==num&&(num>1?toc.title.num=num:delete toc.title.num),!toc.elDetails.open)return;added||(added=sections);const first=sections.indexOf(added[0]),elFirst=toc.el.children[first];if(first>=0&&(!added.focus||!elFirst))for(let e=elFirst,t=first;t<sections.length;t++){const entry=sections[t].tocEntry;if(!util.deepEqual(entry,toc[t])){e||(e=toc.el.appendChild(dom.$create("li",{tabIndex:0}))),e.tabIndex=entry.removed?-1:0,toc[t]=Object.assign({},entry);const n=e.textContent=util.clipString(entry.label)||(null==entry.target?util.t("appliesToEverything"):util.clipString(entry.target)+(entry.numTargets>1?", ...":""));n.length>30&&(e.title=n)}e=e.nextElementSibling}for(;toc.length>sections.length;)toc.el.lastElementChild.remove(),toc.length--;if(added.focus){toc.i=first;const cls=toc.cls,old=toc.el.$("."+cls),e=elFirst||toc.el.children[first];old&&old!==e&&old.classList.remove(cls),e.classList.add(cls)}},useSavedStyle(newStyle){style.id!==newStyle.id&&history.replaceState({},"",`?id=${newStyle.id}`),util.sessionStore.justEditedStyleId=newStyle.id,Object.assign(style,newStyle),editor.updateClass(),editor.updateMeta()}};function failRegexp(e){try{new RegExp(e),e=""}catch(t){e=t.message.split("/:").pop().trim()}return e}function validateRegexp({target:e}){let err=failRegexp(e.value);err&&(err=util.t("styleBadRegexp")+"\n"+err),e.title!==err&&(e.title=err,e.setCustomValidity(err))}const edit_editor=editor;s.d(o,{default:()=>edit_editor})},9506:(e,s,l)=>{l(9073);var localization=l(7501),prefs=l(492),src_cm=l(6199),compact_header=l(8304),editor=l(9920),dom_util=l(3831),util=l(6940),dom=l(7986),edit_util=l(4849);let cssBeautifyMod;async function beautify(scope,e=!0){cssBeautifyMod||(cssBeautifyMod=(await l.e("vendor-overwrites_beautify_beautify-css-mod_js").then(l.bind(l,3256))).default);const tabs=prefs.__values["editor.indentWithTabs"],options=Object.assign(prefs.defaults["editor.beautify"],prefs.__values["editor.beautify"]);options.indent_size=tabs?1:prefs.__values["editor.tabSize"],options.indent_char=tabs?"\t":" ",e&&(e=createBeautifyUI(scope,options));for(const t of scope)setTimeout(beautifyEditor,0,t,options,e)}function beautifyEditor(e,options,n){const pos=options.translate_positions=[].concat.apply([],e.doc.sel.ranges.map(e=>[Object.assign({},e.anchor),Object.assign({},e.head)])),text=e.getValue(),newText=cssBeautifyMod(text,options);if(newText!==text){e.beautifyChange&&e.beautifyChange[e.changeGeneration()]||(e.beautifyChange={}),e.setValue(newText);const selections=[];for(let e=0;e<pos.length;e+=2)selections.push({anchor:pos[e],head:pos[e+1]});const{scrollX,scrollY}=t;e.setSelections(selections),t.scrollTo(scrollX,scrollY),e.beautifyChange[e.changeGeneration()]=!0,n&&(n.$('button[role="close"]').disabled=!1)}}function createBeautifyUI(scope,options){const popup=edit_util.helpPopup.show(util.t("styleBeautify"),dom.$create("div",[dom.$create(".beautify-options",[e(".selector1,","selector_separator_newline"),e(".selector2","newline_before_open_brace"),e("{","newline_after_open_brace"),e("border: none;","newline_between_properties",!0),e("display: block;","newline_before_close_brace",!0),e("}","newline_between_rules"),o("space_around_combinator","","selector + selector","selector+selector"),o("space_around_cmp","",'[attribute = "1"]','[attribute="1"]'),o("preserve_newlines","styleBeautifyPreserveNewlines"),o("indent_conditional","styleBeautifyIndentConditional"),editor.default.isUsercss&&o("indent_mozdoc","","... @-moz-document")].filter(Boolean)),dom.$create("p.beautify-hint",[dom.$create("span",util.t("styleBeautifyHint")+" "),edit_util.createHotkeyInput("editor.beautify.hotkey",{buttons:!1,onDone:()=>dom_util.moveFocus(popup,0)})]),dom.$create(".buttons",[dom.$create("button[role=close]",{onclick:edit_util.helpPopup.close},util.t("confirmClose")),dom.$create("button[role=undo]",{onclick(){let undoable=!1;for(const e of scope){const data=e.beautifyChange;if(!data||!data[e.changeGeneration()])continue;delete data[e.changeGeneration()];const{scrollX,scrollY}=t;e.undo(),e.scrollIntoView(e.getCursor()),t.scrollTo(scrollX,scrollY),undoable|=data[e.changeGeneration()]}this.disabled=!undoable}},util.t(1===scope.length?"undo":"undoGlobal"))])]),{className:"wide"});return n.querySelector(".beautify-options").onchange=({target})=>{const value="checkbox"===target.type?target.checked:target.selectedIndex>0,elLine=target.closest("[newline]");elLine?elLine.setAttribute("newline",value):target._&&(target._.node.textContent=target._[value?"text":"textOff"]),options[target.dataset.option]=value,prefs.set("editor.beautify",Object.assign({},options,{translate_positions:void 0})),beautify(scope,!1)},popup;function e(label,optionName,indent){const value=options[optionName];return dom.$create(`div[newline=${value}]`,[dom.$create("span"+(indent?"[indent]":""),label),dom.$create("div.select-wrapper",[dom.$create(`select[data-option=${optionName}]`,[dom.$create("option",{selected:!value}," "),dom.$create("option",{selected:value},"\\n")])])])}function o(optionName,i18nKey,text,textOff){const checked=!1!==options[optionName],textNode=textOff&&n.createTextNode(checked?text:textOff);return dom.$create("label",{style:"display: block; clear: both;"},[dom.$create(`input[data-option=${optionName}]`,{type:"checkbox",_:textOff&&{node:textNode,text,textOff},checked}),i18nKey?util.t(i18nKey):textNode||text])}}function initBeautifyButton(btn,scope){btn.onclick=btn.oncontextmenu=e=>{e.preventDefault(),beautify(scope||editor.default.getEditors(),"click"===e.type)}}function EditorHeader(){initBeautifyButton(n.getElementById("beautify")),initNameArea(),dom_util.setupLivePrefs(),t.on("load",()=>{prefs.subscribe("editor.keyMap",showHotkeyInTooltip,!0),t.on("showHotkeyInTooltip",showHotkeyInTooltip)},{once:!0});for(const e of n.querySelectorAll("#header summary"))e.on("contextmenu",peekDetails)}function findKeyForCommand(command,map){"string"==typeof map&&(map=src_cm.CodeMirror.keyMap[map]);let key=Object.keys(map).find(e=>map[e]===command);if(key)return key;for(const e of Array.isArray(map.fallthrough)?map.fallthrough:[map.fallthrough])if(key=e&&findKeyForCommand(command,e),key)return key;return""}function initNameArea(){const nameEl=n.getElementById("name"),resetEl=n.getElementById("reset-name"),isCustomName=editor.default.style.updateUrl||editor.default.isUsercss;editor.default.nameTarget=isCustomName?"customName":"name",nameEl.placeholder=util.t(editor.default.isUsercss?"usercssEditorNamePlaceholder":"styleMissingName"),nameEl.title=isCustomName?util.t("customNameHint"):"",nameEl.on("input",()=>{editor.default.updateName(!0),resetEl.hidden=!editor.default.style.customName}),resetEl.hidden=!editor.default.style.customName,resetEl.onclick=()=>{dom_util.setInputValue(nameEl,editor.default.style.name),editor.default.style.customName=null,resetEl.hidden=!0};const enabledEl=n.getElementById("enabled");enabledEl.onchange=()=>editor.default.updateEnabledness(enabledEl.checked)}async function peekDetails(evt){evt.preventDefault();const elDetails=this.parentNode;if(elDetails.open=!elDetails.open){for(;elDetails.matches(":hover, :active");)await util.sleep(500),await new Promise(e=>elDetails.on("mouseleave",e,{once:!0}));elDetails.open=!1}}function showHotkeyInTooltip(e,mapName=prefs.__values["editor.keyMap"]){for(const e of n.querySelectorAll("[data-hotkey-tooltip]"))if(e._hotkeyTooltipKeyMap!==mapName){e._hotkeyTooltipKeyMap=mapName;const title=e._hotkeyTooltipTitle=e._hotkeyTooltipTitle||e.title,cmd=e.dataset.hotkeyTooltip,key="="===cmd[0]?cmd.slice(1):findKeyForCommand(cmd,mapName)||findKeyForCommand(cmd,src_cm.extraKeys),newTitle=title+(title&&key?"\n":"")+(key||"");e.title!==newTitle&&(e.title=newTitle)}}src_cm.CodeMirror.commands.beautify=e=>{beautify(e.display.wrapper.parentElement.contains(n.activeElement)?[e]:editor.default.getEditors(),!1)},prefs.subscribe("editor.beautify.hotkey",(e,value)=>{for(const[key,cmd]of Object.entries(src_cm.extraKeys))if("beautify"===cmd){delete src_cm.extraKeys[key];break}value&&(src_cm.extraKeys[value]="beautify")},!0);var linter=l(2414),sections_util=l(2013);location.hash&&history.replaceState(history.state,"",location.href.split("#")[0]);const params=new URLSearchParams(location.search);let r=+params.get("id");const load_style=loadStyle(prefs.clientData);function loadStyle({style=makeNewStyleObj(),isUC,si:e,template}){if(Object.assign(editor.default,{style,template,isUsercss:isUC,scrollInfo:e||{}}),editor.default.updateClass(),editor.default.updateTitle(!1),i.add(isUC?"usercss":"sectioned"),util.sessionStore.justEditedStyleId=r||"",null===r){params.delete("id");const str=`${params}`;history.replaceState({},"",location.pathname+(str?"?":"")+str)}return src_cm.loadCmTheme()}function makeNewStyleObj(){r=null;const prefix=util.tryURL(params.get("url-prefix")),name=params.get("name")||prefix.hostname,e=prefix.pathname||"/",section={code:""};for(let[e,t]of params)(e=sections_util.FROM_CSS[e])&&(section[e]=[t]);return{id:r,enabled:!0,name:name?name+("/"===e?"":util.clipString(e.replace(/\.(html?|aspx?|cgi|php)$/,""))):params.get("domain")||"?",sections:[section]}}var msg=l(3619),msg_api=l(4930),util_webext=l(1480);async function handleExternalUpdate({style,reason}){if("editPreview"!==reason&&"editPreviewEnd"!==reason)if("editSave"===reason&&editor.default.saving)editor.default.saving=!1;else{if("toggle"===reason)return editor.default.dirty.isDirty()?editor.default.toggleStyle(style.enabled):(Object.assign(editor.default.style,style),editor.default.updateLivePreview()),void editor.default.updateMeta();if(style=await msg_api.API.styles.getCore({id:style.id,vars:!0}),"config"===reason){for(const key in editor.default.style)"sourceCode"===key||"sections"===key||key in style||delete editor.default.style[key];delete style.name,delete style.enabled,Object.assign(editor.default.style,style),editor.default.updateLivePreview()}else await editor.default.replaceStyle(style);t.dispatchEvent(new Event("styleSettings"))}}msg.onMessage.set(request=>{const{style}=request;switch(request.method){case"styleUpdated":editor.default.style.id===style.id&&handleExternalUpdate(request);break;case"styleDeleted":editor.default.style.id===style.id&&util_webext.closeCurrentTab()}});const editor_settings='<section><label id=lineWrapping-label i18n=+cm_lineWrapping><input id=editor.lineWrapping type=checkbox></label><label id=smartIndent-label i18n=+cm_smartIndent><input id=editor.smartIndent type=checkbox></label><label id=indentWithTabs-label i18n=+cm_indentWithTabs><input id=editor.indentWithTabs type=checkbox></label><label i18n="+cm_autoCloseBrackets, title:cm_autoCloseBracketsTooltip"><input id=editor.autoCloseBrackets type=checkbox></label><label i18n=+cm_autocompleteOnTyping><input id=editor.autocompleteOnTyping type=checkbox></label><label i18n="+cm_selectByTokens, title:cm_selectByTokensTooltip"><input id=editor.selectByTokens type=checkbox></label><label i18n=+cm_arrowKeysTraverse class=sectioned-only><input id=editor.arrowKeysTraverse type=checkbox></label><div><label i18n=+cm_colorpicker><input id=editor.colorpicker type=checkbox></label><a id=colorpicker-settings class=icon i18n=title:shortcutsNote tabindex=0><i class=i-config></i></a></div><label i18n="+appliesLineWidgetLabel, title:appliesLineWidgetWarning" class=usercss-only><input id=editor.appliesToLineWidget type=checkbox></label><label i18n=+editTargetsFirst class=sectioned-only><input id=editor.targetsFirst type=checkbox></label></section><section class=aligned><div><label id=tabSize-label for=editor.tabSize i18n=cm_tabSize></label><input id=editor.tabSize type=number min=0></div><div><label id=keyMap-label for=editor.keyMap i18n=cm_keyMap></label><div class=select-wrapper><select id=editor.keyMap></select></div><a id=keyMap-help class=icon tabindex=0><i class=i-info></i></a></div><div><label id=theme-label for=editor.theme i18n=cm_theme></label><div class=select-wrapper><select id=editor.theme></select></div></div><div><label id=highlight-label for=editor.matchHighlight i18n=cm_matchHighlight></label><div class=select-wrapper><select id=editor.matchHighlight><option i18n=cm_matchHighlightToken value=token><option i18n=cm_matchHighlightSelection value=selection><option i18n=genericDisabledLabel value=""></select></div></div><div><label id=linter-label for=editor.linter i18n=cm_linter></label><div class=select-wrapper><select id=editor.linter><option value=csslint selected>CSSLint</option><option value=stylelint>Stylelint</option><option value="" i18n=genericDisabledLabel></option></select></div><a id=linter-settings class=icon i18n=title:linterConfigTooltip tabindex=0><i class=i-config></i></a></div></section>';var style_settings=l(1095);for(const[e,init,tpl,html]of[["#options",function(e){const maps=Object.keys(src_cm.CodeMirror.keyMap).map(name=>({value:name,name:name.replace(/^(pc|mac)(.+)/,(e,arch,baseName)=>baseName.toLowerCase()+"-"+("mac"===arch?"Mac":"PC"))})).sort((e,t)=>e.name<t.name?-1:e.name>t.name&&1),fragment=n.createDocumentFragment();let groupName,bin=fragment;maps.forEach(({value,name},e)=>{groupName=name.includes("-")?groupName:name;const groupWithNext=maps[e+1]&&maps[e+1].name.startsWith(groupName);groupWithNext&&bin===fragment&&(bin=fragment.appendChild(dom.$create("optgroup",{label:name.split("-")[0]})));const t=bin.appendChild(dom.$create("option",{value},name));value===prefs.defaults["editor.keyMap"]&&(t.dataset.default="",t.title=util.t("defaultTheme")),groupWithNext||(bin=fragment)});const selector=e.$("#editor\\.keyMap");selector.textContent="",selector.appendChild(fragment),e.$("#editor\\.theme").append(dom.$create("option",{value:"default"},util.t("defaultTheme")),...Object.keys(src_cm.THEMES).map(e=>dom.$create("option",e))),e.$("#colorpicker-settings").onclick=function(event){event.preventDefault();const bounds=this.getBoundingClientRect(),input=edit_util.createHotkeyInput("editor.colorpicker.hotkey",{onDone:edit_util.helpPopup.close}),popup=edit_util.helpPopup.show(util.t("helpKeyMapHotkey"),input);popup.style=`top: ${bounds.bottom}px; left: ${bounds.left}px; right: auto;`,popup.$("input").focus()},e.$("#keyMap-help").onclick=async function(){(this.onclick=(await l.e("edit_keymap-help_js").then(l.bind(l,5479))).keymapHelp)()},e.$("#linter-settings").onclick=async function(){(this.onclick=(await l.e("edit_linter_dialogs_js").then(l.bind(l,3253))).showLintConfig)()},dom_util.setupLivePrefs(e),prefs.subscribe("editor.linter",editor.default.updateLinterSwitch,!0)},"editorSettings",editor_settings],["#styleOpts",function(e){const AUTOSAVE_DELAY=500,PASS=val=>val,{style}=editor.default,elAuto=e.$("#config\\.autosave"),elSave=e.$("#ss-save"),elUpd=e.$("#ss-updatable"),pendingSetters=new Map,updaters=[initCheckbox(elUpd,"updatable",util.tryURL(style.updateUrl).href),initInput("#ss-update-url","updateUrl","",{validate:e=>(elUpd.disabled=!e.value||!e.validity.valid,e.validity.valid)}),initRadio("ss-scheme","preferScheme","none"),initArea("inclusions"),initArea("exclusions")];function autosave(t,setter){pendingSetters.set(t,setter),e.classList.add("dirty"),elSave.disabled=!1,elAuto.checked&&util.debounce(save,AUTOSAVE_DELAY)}function initArea(type){return initInput(`#ss-${type}`,type,[],{get:textToList,set:list=>list.join("\n"),validate(e){const val=e.value;e.rows=val.match(/^/gm).length+!val.endsWith("\n")}})}function initCheckbox(e,key,defVal){return initInput(e,key,Boolean(defVal),{dom:"checked"})}function initInput(t,key,defVal,{dom="value",get=PASS,set=PASS,validate=PASS}={}){return"string"==typeof t&&(t=e.$(t)),t.oninput=()=>{!1!==validate(t)&&autosave(t,{dom,get,key})},()=>{let val=style[key];val=set(null!=val?val:defVal),t[dom]!==val&&(t[dom]=val,validate(t))}}function initRadio(name,key,defVal){return e.$(`#${name}`).oninput=e=>{e.target.checked&&autosave(e.target,{key})},()=>{e.$(`[name="${name}"][value="${style[key]||defVal}"]`).checked=!0}}function save(){pendingSetters.forEach(saveValue),pendingSetters.clear(),e.classList.remove("dirty"),elSave.disabled=!0}function saveValue({dom="value",get=PASS,key},e){return msg_api.API.styles.config(style.id,key,get(e[dom]))}function textToList(text){return text.split(/\n/).map(e=>e.trim()).filter(Boolean)}function update(){updaters.forEach(e=>e())}update(),prefs.subscribe("schemeSwitcher.enabled",(t,val)=>{e.$("#ss-scheme-off").hidden="never"!==val},!0),t.on("styleSettings",update),elSave.onclick=save,dom_util.setupLivePrefs(e)},"styleSettings",style_settings.default]]){const t=localization.template.body.$(e),n=new MutationObserver(()=>{n.disconnect(),localization.templateCache[tpl]=t.appendChild(dom.$create("main",localization.templateCache[tpl]??=localization.htmlToTemplate(html))),init(t)});n.observe(t,{attributes:!0,attributeFilter:["open"]})}var codemirror_factory=l(8544);const RX_META1=/^!?\s*==userstyle==\s*$/i;class EditorSection{constructor(sectionData,genId,e){const t=this,n=this.el=localization.templateCache.section.cloneNode(!0),elLabel=this.elLabel=n.$(".code-label"),o=this.targetsEl=n.$(".applies-to"),i=this.cm=n.CodeMirror=codemirror_factory.default.create(wrapper=>{const t=wrapper.style,i=editor.default.loading?t.height=e?e.height:"100vh":t.height;n.style.setProperty("--cm-height",i),o[prefs.__values["editor.targetsFirst"]?"after":"before"](wrapper)},{value:sectionData.code,finishInit(t){editor.default.applyScrollInfo(t,e)}});this.elLabelText=elLabel.lastChild,i.el=n,i.editorSection=this,n.me=this,i.setSize=EditorSection.onSetSize,this.genId=genId,this.id=genId(),this.changeListeners=new Set,this.changeGeneration=i.changeGeneration(),this.removed=!1,this.tocEntry={label:"",get removed(){return t.removed}},this.targets=[],this.targetsListEl=n.$(".applies-to-list"),this.targetsEl.on("change",this),this.targetsEl.on("input",this),this.targetsEl.on("click",this),i.on("changes",EditorSection.onCmChanges);for(const propName in sections_util.TO_CSS){const arr=sectionData[propName],cssName=sections_util.TO_CSS[propName];if(cssName&&arr)for(const e of arr)this.addTarget(cssName,e)}this.targets.length||this.addTarget(),initBeautifyButton(n.$(".beautify-section"),[i]),prefs.subscribe("editor.toc.expanded",this.updateTocPrefToggled.bind(this),!0),new ResizeGrip(i),this.updateTocEntry()}getModel(){const res={code:this.cm.getValue()};for(const{type,value}of this.targets)type&&(res[sections_util.FROM_CSS[type]]??=[]).push(value);return res}remove(){linter.disableForEditor(this.cm),this.el.classList.add("removed"),this.removed=!0,this.targets.forEach(e=>e.remove())}render(){this.cm.refresh()}destroy(){codemirror_factory.default.destroy(this.cm)}restore(){linter.enableForEditor(this.cm),this.el.classList.remove("removed"),this.removed=!1,this.targets.forEach(e=>e.restore()),this.cm.refresh()}onChange(e){this.changeListeners.add(e)}emitChange(origin){for(const e of this.changeListeners)e.call(this,origin)}off(e){this.changeListeners.delete(e)}updateTocEntry(origin,sec=this){const e=sec.tocEntry;let changed;if("code"===origin||!origin){const label=sec.getLabelFromComment();e.label!==label&&(e.label=sec.elLabelText.textContent=label,changed=!0)}if(!e.label){const first=sec.targets[0],target=first.type?first.value:null;e.target!==target&&(e.target=target,changed=!0),e.numTargets!==sec.targets.length&&(e.numTargets=sec.targets.length,changed=!0)}changed&&editor.default.updateToc([sec])}updateTocEntryLazy(){util.debounce(this.updateTocEntry,0,"",this)}updateTocFocus(evt){editor.default.updateToc({focus:!0,0:evt?this.me:this})}updateTocPrefToggled(key,val){this.el[val?"on":"off"]("focusin",this.updateTocFocus),val&&this.el.contains(n.activeElement)&&this.updateTocFocus()}getLabelFromComment(){let inCmt,elUC,cmt="";return this.cm.eachLine(({text})=>{let e=0;if(!inCmt){if(e=text.search(/\S/),e<0)return;if(inCmt="/"===text[e]&&"*"===text[e+1],!inCmt)return!0;e+=2}const t=text.indexOf("*/",e);return text=text.slice(e,t>=0?t:text.length),cmt=edit_util.trimCommentLabel(text),elUC=this.elUC,cmt&&RX_META1.test(text)?elUC?elUC=null:this.elLabelText.after(elUC=this.elUC=localization.templateCache.usercssSection.cloneNode(!0)):elUC&&(elUC.remove(),elUC=this.elUC=!1),null!=elUC&&this.elLabel.classList.toggle("warn",elUC),t>=0||cmt}),cmt}handleEvent(evt){const e=evt.target,cls=e.classList,trgEl=e.closest(".applies-to-item"),trg=trgEl&&trgEl.me;let tmp;switch(evt.type){case"click":if(cls.contains("add-applies-to"))this.addTarget(trg.type,"",trg).el.$("input").focus();else if(cls.contains("remove-applies-to"))this.removeTarget(trg);else if(!this.ati&&(tmp=e.closest("label"))){const chkLabel=(localization.templateCache.editorSettings??=localization.htmlToTemplate(editor_settings)).$("#editor\\.targetsFirst").closest("label").cloneNode(!0);(this.ati=edit_util.helpPopup.show(chkLabel,tmp.title,{},"ati")).onClose.add(()=>delete this.ati),dom_util.setupLivePrefs(chkLabel)}break;case"change":e===trg.selectEl&&trg.onSelectChange();break;case"input":e===trg.valueEl&&trg.onValueChange()}}addTarget(type,value,base){const{targets}=this,res=new SectionTarget(this,type,value);return targets.splice(base?targets.indexOf(base)+1:targets.length,0,res),this.targetsListEl.insertBefore(res.el,base?base.el.nextSibling:null),editor.default.dirty.add(res,res),targets.length>1&&!targets[0].type&&this.removeTarget(targets[0]),base&&requestAnimationFrame(()=>this.shrinkBy1()),this.el.style.setProperty("--targets",targets.length),this.emitChange("apply"),res}removeTarget(target){const{targets}=this;targets.splice(targets.indexOf(target),1),editor.default.dirty.remove(target,target),target.remove(),target.el.remove(),targets.length||this.addTarget(),this.el.style.setProperty("--targets",targets.length),this.emitChange("apply")}shrinkBy1(){const{cm:e,el:t}=this,cmEl=e.display.wrapper,cmH=cmEl.offsetHeight,viewH=t.parentElement.offsetHeight;t.offsetHeight>viewH&&cmH>Math.min(viewH/2,e.display.sizer.offsetHeight+30)&&(cmEl.style.height=(cmH-this.targetsEl.offsetHeight/(this.targets.length||1)|0)+"px")}static onCmChanges(e){const cur=e.changeGeneration(),sec=e.editorSection;editor.default.dirty.modify(`section.${sec.id}.code`,sec.changeGeneration,cur),sec.changeGeneration=cur,sec.emitChange("code"),sec.updateTocEntryLazy()}static onSetSize(e,t){const n=this;src_cm.CodeMirror.prototype.setSize.call(n,e,t),n.el.style.setProperty("--cm-height",n.display.wrapper.style.height)}}class SectionTarget{constructor(section,type="",value=""){this.id=section.genId(),this.el=(localization.templateCache.appliesTo??=localization.htmlToTemplate(edit_util.htmlAppliesTo)).cloneNode(!0),this.el.me=this,this.section=section,this.dirt=`section.${section.id}.apply.${this.id}`,this.selectEl=this.el.$(".applies-type"),this.valueEl=this.el.$(".applies-value"),editor.default.toggleRegexp(this.valueEl,type),this.type=this.selectEl.value=type,this.value=this.valueEl.value=value,this.restore(),this.toggleAll()}remove(){this.type&&(editor.default.toggleRegexp(this.valueEl),editor.default.dirty.remove(`${this.dirt}.type`,this.type),editor.default.dirty.remove(`${this.dirt}.value`,this.value))}restore(){this.type&&(editor.default.dirty.add(`${this.dirt}.type`,this.type),editor.default.dirty.add(`${this.dirt}.value`,this.value))}toggleAll(){dom.$toggleDataset(this.section.targetsEl,"all",!this.type)}onSelectChange(){const sec=this.section,val=this.selectEl.value;editor.default.dirty.modify(`${this.dirt}.type`,this.type,val),editor.default.toggleRegexp(this.valueEl,val),this.type=val,this.toggleAll(),sec.emitChange("apply"),sec.updateTocEntry("apply")}onValueChange(){const val=this.valueEl.value;editor.default.dirty.modify(`${this.dirt}.value`,this.value,val),this.value=val,this.section.emitChange("apply"),this.section.updateTocEntry("apply")}}class ResizeGrip{constructor(e){const wrapper=this.wrapper=e.display.wrapper,t=localization.template.resizeGrip.cloneNode(!0);wrapper.classList.add("resize-grip-enabled"),wrapper.appendChild(t),this.cm=e,this.lastClickTime=0,this.lastHeight=0,this.minHeight=0,this.lastY=0,t.on("mousedown",{me:this,handleEvent:ResizeGrip.onMouseDown}),this.onResize={me:this,handleEvent:ResizeGrip.resize},this.onStop={me:this,handleEvent:ResizeGrip.resizeStop}}static onMouseDown(evt){const e=this.me;if(e.lastHeight=e.wrapper.offsetHeight,e.lastY=evt.clientY,0===evt.button){if(evt.preventDefault(),Date.now()-e.lastClickTime<500)return e.lastClickTime=0,void e.toggleSectionHeight();e.lastClickTime=Date.now(),e.minHeight=e.cm.defaultTextHeight()+e.cm.display.lineDiv.offsetParent.offsetTop+e.wrapper.offsetHeight-e.wrapper.clientHeight,n.body.classList.add("resizing-v"),n.on("mousemove",e.onResize),n.on("mouseup",e.onStop)}}static resize(evt){const e=this.me,height=Math.max(e.minHeight,e.lastHeight+evt.clientY-e.lastY);height!==e.lastHeight&&(e.cm.setSize(null,height),e.lastHeight=height,e.lastY=evt.clientY)}static resizeStop(){const e=this.me;n.off("mouseup",e.onStop),n.off("mousemove",e.onResize),n.body.classList.remove("resizing-v")}toggleSectionHeight(){const{cm:e,wrapper}=this;if(e.state.toggleHeightSaved)e.setSize(null,e.state.toggleHeightSaved),e.state.toggleHeightSaved=0;else{const pageExtrasHeight=n.getElementById("sections").getBoundingClientRect().top+t.scrollY+parseFloat(getComputedStyle(n.getElementById("sections")).paddingBottom),sectionEl=wrapper.parentNode,sectionExtrasHeight=sectionEl.clientHeight-wrapper.offsetHeight;e.state.toggleHeightSaved=wrapper.clientHeight,e.setSize(null,t.innerHeight-sectionExtrasHeight-pageExtrasHeight);const bounds=sectionEl.getBoundingClientRect();(bounds.top<0||bounds.bottom>t.innerHeight)&&t.scrollBy(0,bounds.top)}}}function SectionsEditor(){localization.htmlToTemplateCache('<template data-id=section><div class=section><label class=code-label><span i18n=sectionCode></span><span></span></label><div class=applies-to><label i18n="appliesLabel, title:appliesHelp"><a tabindex=0><i class=i-info></i></a></label><ul class=applies-to-list></ul></div><div class=edit-actions><button class=remove-section i18n=sectionRemove></button><button class=add-section i18n="long-text:sectionAdd, short-text:genericAdd"></button><button class=clone-section i18n=genericClone></button><button class=move-section-up></button><button class=move-section-down></button><button class=beautify-section i18n=styleBeautify></button></div></div></template><template data-id=deletedSection><p class=deleted-section><button i18n=sectionRestore></button></p></template><template data-id=usercssSection><a data-cmd=note i18n=title:sectionUserCSS class=icon><i class=i-info></i></a></template>');const{style,dirty}=editor.default,container=n.getElementById("sections"),sections=[],e=new IntersectionObserver(function(entries){for(const n of entries){const o=n.intersectionRatio&&n.intersectionRect;if(o){e.unobserve(n.target);const i=n.target.CodeMirror;o.bottom>0&&o.top<t.innerHeight?refreshOnViewNow(i):setTimeout(refreshOnViewNow,0,i)}}},{rootMargin:"100%"}),updateLivePreview=editor.default.livePreviewLazy.bind(null,function(){editor.default.livePreview(getModel())});let headerOffset,cmExtrasHeight,upDownJumps,INC_ID=0,sectionOrder="";return updateMeta(),edit_util.rerouteHotkeys.toggle(!0),n.getElementById("to-mozilla").on("click",function(){edit_util.showCodeMirrorPopup(util.t("styleToMozillaFormatTitle"),"",{readOnly:!0,value:editor.default.getValue()}).codebox.execCommand("selectAll")}),n.getElementById("to-mozilla-help").on("click",function(event){event.preventDefault(),edit_util.helpPopup.show(util.t("styleMozillaFormatHeading"),util.t("styleToMozillaFormatHelp"))}),n.getElementById("from-mozilla").on("click",()=>showMozillaFormatImport()),n.on("wheel",function(event){event.shiftKey&&event.ctrlKey&&!event.altKey&&!event.metaKey&&(t.scrollBy(0,event.deltaX||event.deltaY),event.preventDefault())},{passive:!1}),src_cm.extraKeys["Shift-Ctrl-Wheel"]="scrollWindow",prefs.subscribe("editor.arrowKeysTraverse",(e,val)=>{for(const{cm:e}of sections)handleKeydownSetup(e,val);upDownJumps=val},!0),prefs.subscribe("editor.targetsFirst",(e,val)=>{for(const sec of sections)(val?sec.elLabel:sec.targetsEl.nextSibling).after(sec.targetsEl)}),Object.assign(editor.default,{sections,closestVisible:function(e){const lineHeight=sections[0].cm.defaultTextHeight(),margin=2*lineHeight,o=e instanceof src_cm.CodeMirror?e:e instanceof Node&&getAssociatedEditor(e)||getLastActivatedEditor();e===o&&(e=n.body);if(e instanceof Node&&o){const{wrapper}=o.display;if(!container.contains(e)||wrapper.closest(".section").contains(e)){const rect=wrapper.getBoundingClientRect();if(rect.top<t.innerHeight-margin&&rect.bottom>margin)return o}}const scrollY=t.scrollY,windowBottom=scrollY+t.innerHeight-margin,allSectionsContainerTop=scrollY+container.getBoundingClientRect().top,distances=[];return o&&0===offscreenDistance()?o:function(){const editors=editor.default.getEditors(),last=editors.length-1;let e,distance,t=0,n=last;for(;t<n-1&&(e=(t+n)/2|0,distance=offscreenDistance(e),distance&&e);){const distancePrev=offscreenDistance(e-1),distanceNext=e<last?offscreenDistance(e+1):1e20;distancePrev<=distance&&distance<=distanceNext?n=e:t=e}for(;n&&offscreenDistance(n-1)<=offscreenDistance(n);)n--;const closest=editors[n];distances[n]>0&&editor.default.scrollToEditor(closest);return closest}();function offscreenDistance(index){if(index>=0&&void 0!==distances[index])return distances[index];const section=o&&o.display.wrapper.closest(".section");if(!section)return 1e9;const top=allSectionsContainerTop+section.offsetTop;if(top<scrollY+lineHeight)return Math.max(0,scrollY-top-lineHeight);if(top<windowBottom)return 0;const distance=top-windowBottom+section.offsetHeight;return index>=0&&(distances[index]=distance),distance}},updateLivePreview,updateMeta,getCurrentLinter:()=>prefs.__values["editor.linter"],getEditors:()=>sections.filter(e=>!e.removed).map(e=>e.cm),getEditorTitle(e){const index=editor.default.getEditors().indexOf(e)+1;return{textContent:`#${index}`,title:`${util.t("sectionCode")} ${index}`}},getValue(asObject){const e=getModel();return asObject?e:sections_util.styleToCss(e)},getSearchableInputs(e){const sec=sections.find(t=>t.cm===e);return sec?sec.targets.map(e=>e.valueEl).filter(Boolean):[]},isSame:styleObj=>sections_util.styleSectionsEqual(styleObj,getModel()),jumpToEditor(e){const{cm:t}=sections[e]||{};t&&(editor.default.scrollToEditor(t),t.focus())},nextEditor:(e,upDown)=>upDown&&e===findLast(sections,e=>!e.removed).cm?null:nextPrevEditor(e,1,upDown),prevEditor:(e,upDown)=>upDown&&e===sections.find(e=>!e.removed).cm?null:nextPrevEditor(e,-1,upDown),async replaceStyle(newStyle,draft){const sameCode=editor.default.isSame(newStyle);(sameCode||draft||await dom_util.messageBox.confirm(util.t("styleUpdateDiscardChanges")))&&(draft||dirty.clear(),sameCode||await initSections(newStyle.sections,{keepDirty:draft,replace:!0,si:draft&&draft.si}),editor.default.useSavedStyle(newStyle),updateLivePreview())},async saveImpl(){try{if(!n.getElementById("name").reportValidity())throw util.t("styleMissingName");const res=await msg_api.API.styles.editSave(getModel());dirty.clear(),editor.default.useSavedStyle(res)}catch(e){dom_util.messageBox.alert(e.message||e)}},scrollToEditor(e,partial){const n=partial&&e.cursorCoords(!0,"window"),{top:o,bottom:i}=e.el.getBoundingClientRect(),s=container.getBoundingClientRect(),rcY1=Math.max(s.top,0),rcY2=Math.min(s.bottom,innerHeight);(partial?n.top<rcY1||n.top>rcY2-30:o>=rcY1^i<=rcY2)&&t.scrollBy(0,(o+i-rcY2+rcY1)/2|0)}}),initSections(style.sections);function fitToContent(section){const{cm:e,cm:{display:{wrapper,sizer}}}=section;function resize(){let contentHeight=sizer.offsetHeight;if(contentHeight<e.defaultTextHeight())return;null==headerOffset&&(headerOffset=Math.ceil(container.getBoundingClientRect().top+scrollY)),null==cmExtrasHeight&&(cmExtrasHeight=wrapper.offsetHeight-wrapper.clientHeight),contentHeight+=cmExtrasHeight,e.off("update",resize);const cmHeight=wrapper.offsetHeight,appliesToHeight=Math.min(section.el.offsetHeight-cmHeight,t.innerHeight/2),maxHeight=Math.floor(t.innerHeight-headerOffset-appliesToHeight),fit=Math.min(contentHeight,maxHeight);Math.abs(fit-cmHeight)>1&&e.setSize(null,fit)}e.display.renderedView?resize():e.on("update",resize)}function fitToAvailableSpace(){const lastSectionBottom=container.getBoundingClientRect().bottom,delta=Math.floor((t.innerHeight-lastSectionBottom)/sections.length);delta>1&&sections.forEach(({cm:e})=>{e.setSize(null,e.display.lastWrapHeight+delta)})}function genId(){return INC_ID++}function setGlobalProgress(done,total){const progressElement=n.getElementById("global-progress")||total&&n.body.appendChild(dom.$create("#global-progress"));if(total){const progress=(done/Math.max(done,total)*100).toFixed(1);progressElement.style.borderLeftWidth=progress+"vw",setTimeout(()=>{progressElement.title=progress+"%"})}else progressElement.remove()}function getAssociatedEditor(nearbyElement){for(let e=nearbyElement;e;e=e.parentElement)if(e.CodeMirror)return e.CodeMirror}function findLast(arr,match){for(let e=arr.length-1;e>=0;e--)if(match(arr[e]))return arr[e]}function handleKeydown(event){if(event.shiftKey||event.altKey||event.metaKey||"ArrowUp"!==event.key&&"ArrowDown"!==event.key)return;let pos,e=this.CodeMirror;const{line,ch:t}=e.getCursor();"ArrowUp"===event.key?(e=0===line&&editor.default.prevEditor(e,!0),pos=e&&[e.doc.size-1,t]):(e=line===e.doc.size-1&&editor.default.nextEditor(e,!0),pos=e&&[0,0]),e&&(e.setCursor(...pos),event.preventDefault(),event.stopPropagation())}function handleKeydownSetup(e,state){e.display.wrapper[state?"on":"off"]("keydown",handleKeydown,!0)}function nextPrevEditor(e,direction,upDown){const editors=editor.default.getEditors();return e=editors[(editors.indexOf(e)+direction+editors.length)%editors.length],editor.default.scrollToEditor(e,upDown),e.focus(),e}function getLastActivatedEditor(){let result;for(const section of sections)section.removed||(!result||section.cm.lastActive>result.lastActive)&&(result=section.cm);return result}function showMozillaFormatImport(text=""){const popup=edit_util.showCodeMirrorPopup(util.t("styleFromMozillaFormatPrompt"),dom.$create(".buttons",[dom.$create("button",{name:"import-replace",textContent:util.t("importReplaceLabel"),title:"Ctrl-Shift-Enter:\n"+util.t("importReplaceTooltip"),onclick:()=>doImport({replaceOldStyle:!0})}),dom.$create("button",{name:"import-append",textContent:util.t("importAppendLabel"),title:"Ctrl-Enter:\n"+util.t("importAppendTooltip"),onclick:doImport})])),contents=popup._contents;async function doImport({replaceOldStyle=!1}){lockPageUI(!0);try{const code=popup.codebox.getValue().trim();if(!code.match(util.RX_META)?.[0].includes("@preprocessor")||!await getPreprocessor(code)||await dom_util.messageBox.confirm(util.t("importPreprocessor"),"pre-line",util.t("importPreprocessorTitle"))){const{sections:newSections,errors}=await edit_util.worker.parseMozFormat({code});newSections.length&&!errors.some(e=>!e.recoverable)||await Promise.reject(errors),await initSections(newSections,{replace:replaceOldStyle,focusOn:replaceOldStyle?0:sections.length,keepDirty:!0}),edit_util.helpPopup.close()}}catch(e){errors=e,dom_util.messageBox.show({className:"center danger",title:util.t("styleFromMozillaFormatError"),contents:dom.$create("pre",(Array.isArray(errors)?errors:[errors]).map(e=>e.message||e).join("\n")),buttons:[util.t("confirmClose")]})}var errors;lockPageUI(!1)}async function getPreprocessor(code){try{return(await msg_api.API.usercss.buildMeta({sourceCode:code})).usercssData.preprocessor}catch{}}function lockPageUI(locked){o.style.pointerEvents=locked?"none":"",popup.codebox&&(popup.classList.toggle("ready",!locked&&!popup.codebox.isBlank()),popup.codebox.options.readOnly=locked,popup.codebox.display.wrapper.style.opacity=locked?".5":"")}contents.insertBefore(popup.codebox.display.wrapper,contents.firstElementChild),popup.codebox.focus(),popup.codebox.on("changes",e=>{popup.classList.toggle("ready",!e.isBlank()),e.markClean()}),text&&(popup.codebox.setValue(text),popup.codebox.clearHistory(),popup.codebox.markClean()),popup.codebox.options.extraKeys={"Ctrl-Enter":doImport,"Shift-Ctrl-Enter":()=>doImport({replaceOldStyle:!0})}}function updateSectionOrder(){const oldOrder=sectionOrder,validSections=sections.filter(e=>!e.removed);sectionOrder=validSections.map(e=>e.id).join(","),dirty.modify("sectionOrder",oldOrder,sectionOrder),container.dataset.sectionCount=validSections.length,linter.refreshReport(),editor.default.updateToc()}function getModel(){return Object.assign({},style,{sections:sections.filter(e=>!e.removed).map(e=>e.getModel())})}function updateMeta(){n.getElementById("name").value=style.customName||style.name||"",n.getElementById("enabled").checked=!1!==style.enabled,n.getElementById("url").href=style.url||"",editor.default.updateName()}async function initSections(src,{focusOn=0,replace=!1,keepDirty=!1,si:e=editor.default.scrollInfo}={}){Object.assign(editor.default,{loading:!0}),replace&&(sections.forEach(e=>e.remove()),sections.length=0,container.textContent=""),e&&e.cms&&e.cms.length===src.length?(e.scrollY2=e.scrollY+t.innerHeight,container.style.height=e.scrollY2+"px",scrollTo(0,e.scrollY),focusOn=e.cms[0].focus&&0):e=null;let tPrev,forceRefresh=!0,n=0;for(let t=0,iSec=sections.length;t<src.length;t++,iSec++){const now=performance.now();tPrev?now-tPrev>100&&(tPrev=0,forceRefresh=!1,await util.sleep()):tPrev=now,e&&(forceRefresh=n<e.scrollY2&&(n+=e.cms[t].parentHeight)>e.scrollY),insertSectionAfter(src[t],null,forceRefresh,e&&e.cms[t]),setGlobalProgress(t,src.length),keepDirty||dirty.clear(),iSec===focusOn&&setTimeout(editor.default.jumpToEditor,0,iSec)}e&&!e.cms.every(e=>!e.height)||requestAnimationFrame(fitToAvailableSpace),container.style.removeProperty("height"),setGlobalProgress(),editor.default.loading=!1}function removeSection(section){if(sections.every(e=>e.removed||e===section))throw new Error("Cannot remove last section");if(section.cm.isBlank()){const index=sections.indexOf(section);sections.splice(index,1),section.el.remove(),section.remove(),section.destroy()}else{const lines=[],MAX_LINES=10;section.cm.doc.iter(0,MAX_LINES+1,({text})=>lines.push(text)&&!1);const title=util.t("sectionCode")+"\n"+"-".repeat(20)+"\n"+lines.slice(0,MAX_LINES).map(e=>util.clipString(e,100)).join("\n")+(lines.length>MAX_LINES?"\n...":""),del=section.elDel=localization.templateCache.deletedSection.cloneNode(!0);del.$("button").onclick=()=>restoreSection(section),del.title=title,section.el.prepend(del),section.remove()}dirty.remove(section,section),updateSectionOrder(),section.off(updateLivePreview),updateLivePreview()}function restoreSection(section){section.elDel.remove(),section.restore(),updateSectionOrder(),section.onChange(updateLivePreview),updateLivePreview()}function insertSectionAfter(init,base,forceRefresh,e){init||(init={code:"",urlPrefixes:["https://example.com/"]});const section=new EditorSection(init,genId,e),{cm:t}=section,{code}=init,index=base?sections.indexOf(base)+1:sections.length;sections.splice(index,0,section),container.insertBefore(section.el,base?base.el.nextSibling:null),refreshOnView(t,{code,force:base||forceRefresh}),registerEvents(section),e&&e.height||base&&!code||fitToContent(section),base&&(t.focus(),editor.default.scrollToEditor(t)),upDownJumps&&handleKeydownSetup(t,!0),updateSectionOrder(),updateLivePreview(),section.onChange(updateLivePreview)}function moveSectionUp(section){const index=sections.indexOf(section);0!==index&&(container.insertBefore(section.el,sections[index-1].el),sections[index]=sections[index-1],sections[index-1]=section,updateSectionOrder(),editor.default.scrollToEditor(section.cm))}function moveSectionDown(section){const index=sections.indexOf(section);index!==sections.length-1&&(container.insertBefore(sections[index+1].el,section.el),sections[index]=sections[index+1],sections[index+1]=section,updateSectionOrder(),editor.default.scrollToEditor(section.cm))}function registerEvents(section){const{el:e,cm:t}=section;e.$(".remove-section").onclick=()=>removeSection(section),e.$(".add-section").onclick=()=>insertSectionAfter(void 0,section),e.$(".clone-section").onclick=()=>insertSectionAfter(section.getModel(),section),e.$(".move-section-up").onclick=()=>moveSectionUp(section),e.$(".move-section-down").onclick=()=>moveSectionDown(section),t.on("paste",maybeImportOnPaste)}function maybeImportOnPaste(e,event){const text=event.clipboardData.getData("text")||"";/@-moz-document/i.test(text)&&/@-moz-document\s+(url|url-prefix|domain|regexp)\(/i.test(text.replace(/\/\*([^*]+|\*(?!\/))*(\*\/|$)/g,""))&&(event.preventDefault(),showMozillaFormatImport(text))}function refreshOnView(t,{code,force}={}){code&&linter.enableForEditor(t,code),force?refreshOnViewNow(t):e.observe(t.display.wrapper)}async function refreshOnViewNow(e){linter.enableForEditor(e),e.refresh()}}var chrome_sync=l(7033);function MozSectionFinder(e){const KEY="MozSectionFinder",rxDOC=/@-moz-document(\s+|$)/gi,rxVOID=/\s*}/y,rxFUNC=/([-a-z]+)\(/iy,rxNEXT=/(\s*)(.)?/y,rxSPACE=/\s+/y,rxTokDOC=/^(?!comment|string)/,rxTokCOMMENT=/^comment(\s|$)/,rxTokSTRING=/^string(\s|$)/,{cmpPos}=src_cm.CodeMirror,minPos=(e,t)=>cmpPos(e,t)<0?e:t,maxPos=(e,t)=>cmpPos(e,t)>0?e:t,keptAlive=new Map,state={listeners:new Set,sections:[]};let updFrom,updTo,scheduled;const finder={IGNORE_ORIGIN:KEY,EQ_SKIP_KEYS:["mark","valueStart","valueEnd","sticky"],sections:state.sections,keepAliveFor(e,t){let data=keptAlive.get(e);if(data)clearTimeout(data.timer);else{const NOP=()=>0;data={fn:NOP},keptAlive.set(e,data),finder.on(NOP)}data.timer=setTimeout(()=>keptAlive.delete(e),t)},on(t){const{listeners}=state,needsInit=!listeners.size;listeners.add(t),needsInit&&(e.on("changes",onCmChanges),update())},off(t){const{listeners,sections}=state;listeners.size&&(listeners.delete(t),listeners.size||(e.off("changes",onCmChanges),e.operation(()=>sections.forEach(sec=>sec.mark.clear())),sections.length=0))},onOff(e,enable){finder[enable?"on":"off"](e)},updatePositions(section){(section?[section]:state.sections).forEach(setPositionFromMark)}};function onCmChanges(e,changes){updFrom||(updFrom={line:1/0,ch:0}),updTo||(updTo={line:-1,ch:0});for(const e of changes)e.origin!==finder.IGNORE_ORIGIN&&(updFrom=minPos(e.from,updFrom),updTo=maxPos(src_cm.CodeMirror.changeEnd(e),updTo));updTo.line>=0&&!scheduled&&(scheduled=requestAnimationFrame(update))}function update(){const{sections,listeners}=state;let t,from=updFrom?{line:updFrom.line,ch:updFrom.ch}:{line:0,ch:0},n=updTo?{line:updTo.line,ch:updTo.ch}:{line:e.doc.size,ch:0},cutAt=-1,cutTo=-1;scheduled=updFrom=updTo=null;for(let e=0;e<sections.length;e++){const sec=sections[e];if(cmpPos(sec.end,from)>=0&&(cutAt<0&&(cutAt=e,from=minPos(from,sec.start)),setPositionFromMark(sec))){if(cmpPos(sec.start,n)>0){cutTo=e;break}n=maxPos(sec.end,n)}}cutAt<0&&(from.ch=Math.max(0,from.ch-14),cutAt=sections.length),cutTo<0&&(n.ch+=14,cutTo=sections.length);let reusedAtStart=0,reusedAtEnd=0;const added=findSections(from,n),removed=sections.slice(cutAt,cutTo);for(const sec of added){const n=removed.findIndex(isSameSection,sec);if(n>=0){const e=removed[n];e.funcs=sec.funcs,sec.mark=e.mark,removed[n]=null,reusedAtEnd++,t||reusedAtStart++}else t||(t=e.curOp||(e.startOperation(),!0)),sec.mark=e.markText(sec.start,sec.end,{clearWhenEmpty:!1,inclusiveRight:!0,[KEY]:sec}),reusedAtEnd=0}added.length-=reusedAtEnd,cutTo-=reusedAtEnd,reusedAtStart&&(cutAt+=reusedAtStart,added.splice(0,reusedAtStart));for(const sec of removed)sec&&(t||(t=e.curOp||(e.startOperation(),!0)),sec.mark.clear());if(t){sections.splice(cutAt,cutTo-cutAt,...added);for(const t of listeners)t.call(e,added,removed,cutAt,cutTo)}!0===t&&e.endOperation()}function findSections(from,t){const found=[];let section,func,funcPos,url,funcs,line=from.line-1,goal="";return e.eachLine(from.line,e.doc.size,handle=>{++line;const{text}=handle,len=text.length;if(!len)return;let n=line===from.line?from.ch:0;for(;;){let o;if(!goal){if((line-t.line||n-t.ch)>=0)return!0;if((n=text.indexOf("@-",n))<0||(rxDOC.lastIndex=n,!(o=rxDOC.exec(text))))return;if(n=o.index+o[0].length,section={funcs:funcs=[],start:{line,ch:o.index},end:null,mark:null,tocEntry:{label:"",target:null,numTargets:0}},!rxTokDOC.test(e.getTokenTypeAt(section.start)))continue;found.push(section),goal="_func"}handle.styles||e.getTokenTypeAt({line,ch:0});const{styles}=handle;let type,chPrev,i=1;if(n){for(i+=styles.length*n/len&-2;styles[i-2]>=n;)i-=2;for(;styles[i]<=n;)i+=2}for(;goal&&i<styles.length;(type||n>=styles[i]||n===chPrev)&&(i+=2),chPrev=n){let e;if(type=styles[i+1],type&&type.startsWith("overlay ")&&(type=""),goal.startsWith("_")){if(!type&&(rxSPACE.lastIndex=n,rxSPACE.test(text))&&(n=rxSPACE.lastIndex,n===styles[i]))continue;const isCmt=type&&rxTokCOMMENT.test(type);if("_cmt"===goal){const cmt=isCmt&&edit_util.trimCommentLabel(text.slice(n,n=styles[i]));cmt&&(section.tocEntry.label=cmt),(!isCmt&&type||cmt)&&(goal="");continue}if(isCmt){n=styles[i];continue}goal=goal.slice(1)}if("func"===goal){if(!(type&&(rxFUNC.lastIndex=n,o=rxFUNC.exec(text)))){goal="error";break}for(func=o[1],funcPos={line,ch:n},n+=func.length+1,url=!1,goal="_str";styles[i+2]<=n;)i+=2}if("str"===goal)if(url||(e='"'===(e=text[n])||"'"===e?e:"",url={chunks:[],start:{line,ch:n+=!!e},end:null,quote:e}),rxTokSTRING.test(type)){let end=styles[i];end>n&&(text[end-1]===url.quote&&"\\"!==text[end-2]&&(end--,goal="_)"),url.chunks.push(text.slice(n,end)),url.end={line,ch:end}),n=styles[i]}else{if(type){goal="error";break}goal=")"===text[n]?(i+=2,")"):"_)",url.end={line,ch:n}}if(")"===goal){if(")"!==text[n]){goal="error";break}if(n++,e=url?url.chunks.join(""):"",funcs.length||(section.tocEntry.target=e),section.tocEntry.numTargets++,funcs.push({type:func,value:e,isQuoted:url.quote,start:funcPos,end:{line,ch:n},valueStart:url.start,valueEnd:url.end}),rxNEXT.lastIndex=n,e=text.match(rxNEXT),goal=e[2],goal=","===goal?"_func":"{"===goal?"_cmt":!goal&&"_,",!goal){goal="error";break}if(n+=e[0].length,"{"===e[2]&&(rxVOID.lastIndex=n,rxVOID.test(text))){goal="";break}}","===goal&&(goal=","===text[n]?"_func":"")}if(section.end={line,ch:styles[i+2]||len},"error"===goal&&(goal=""),goal)return}}),found}function setPositionFromMark(obj){const pos=obj.mark.find();return obj.start=pos&&pos.from,obj.end=pos&&pos.to,pos}function isSameSection(old){return old&&old.start&&old.tocEntry.label===this.tocEntry.label&&!cmpPos(old.start,this.start)&&!cmpPos(old.end,this.end)&&old.funcs.length===this.funcs.length&&old.funcs.every(isSameFunc,this.funcs)}function isSameFunc(func,e){return util.deepEqual(func,this[e],finder.EQ_SKIP_KEYS)}return finder}var color_mimicry=l(8872);function MozSectionWidget(e,finder=MozSectionFinder(e)){let TPL,EVENTS,CLICK_ROUTE;const KEY="MozSectionWidget",C_CONTAINER=".applies-to",C_LABEL="label",C_LIST=".applies-to-list",C_ITEM=".applies-to-item",C_TYPE=".applies-type",C_VALUE=".applies-value",getFuncFor=e=>e.closest(C_ITEM)[KEY],getFuncsFor=e=>e.closest(C_LIST)[KEY],getSectionFor=e=>e.closest(C_CONTAINER)[KEY],{cmpPos}=src_cm.CodeMirror;let actualStyle,enabled=!1,funcHeight=0;return{toggle(enable){Boolean(enable)!==enabled&&(enable?init:destroy)()}};function init(){const hint={title:util.t("appliesHelp")};enabled=!0,TPL={container:dom.$create("div"+C_CONTAINER,[dom.$create(C_LABEL,hint,util.t("appliesLabel")),dom.$create("ul"+C_LIST)]),listItem:(localization.templateCache.appliesTo??=localization.htmlToTemplate(edit_util.htmlAppliesTo)).cloneNode(!0),appliesToEverything:dom.$create("li.applies-to-everything",util.t("appliesToEverything"))},TPL.listItem.$('[value=""]').remove(),Object.assign(TPL.listItem.$(C_TYPE),hint),CLICK_ROUTE={".remove-applies-to"(elItem,func){const funcs=getFuncsFor(elItem);if(funcs.length<2)return void dom_util.messageBox.show({contents:util.t("appliesRemoveError"),buttons:[util.t("confirmClose")]});const t=funcs.indexOf(func),next=funcs[t+1],from=t?funcs[t-1].item.find(1):func.item.find(-1),n=next?next.item.find(-1):func.item.find(1);e.replaceRange(t&&next?", ":"",from,n)},async".add-applies-to"(elItem,func){const pos=func.item.find(1);e.replaceRange(`, ${func.str.type}("")`,pos,pos),await util.sleep(),elItem.nextElementSibling.$("input").focus()}},EVENTS={onchange({target:e}){EVENTS.oninput({target:e.closest(C_TYPE)||e})},oninput({target:t}){const part=t.matches(C_VALUE)?"value":t.matches(C_TYPE)&&"type";if(!part)return;const func=getFuncFor(t),pos=func[part].find(),{value}=t;if(value!==func.str[part]){if(func.str[part]=value,"type"===part)func.item[KEY].dataset.type=value,editor.default.toggleRegexp(func.value[KEY],value);else if(func===getFuncsFor(t)[0]){const sec=getSectionFor(t);sec.tocEntry.target=value,sec.tocEntry.label||editor.default.updateToc([sec])}e.replaceRange(fromDoubleslash(value).replace(/\\/g,"\\\\"),pos.from,pos.to,finder.IGNORE_ORIGIN)}},onclick(event){const{target}=event;for(const selector in CLICK_ROUTE){const routed=target.closest(selector);if(routed){const elItem=routed.closest(C_ITEM);return void CLICK_ROUTE[selector](elItem,elItem[KEY],event)}}}},actualStyle=n.createElement("style"),e.on("optionChange",onCmOption),msg.onMessage.set(onRuntimeMessage),finder.sections.length&&update(finder.sections,[]),finder.on(update),updateWidgetStyle(),e.display.wrapper.style.setProperty("--cm-bar-width",e.display.barWidth+"px")}function destroy(){enabled=!1,e.off("optionChange",onCmOption),msg.onMessage.delete(onRuntimeMessage),actualStyle.remove(),actualStyle=null,e.operation(()=>finder.sections.forEach(killWidget)),finder.off(update)}function onCmOption(e,option){"theme"===option&&updateWidgetStyle()}function onRuntimeMessage(e){("editPreview"!==e.reason||n.getElementById(`stylus-${e.style.id}`))&&(e.style||e.styles||e.prefs&&"disableAll"in e.prefs||"colorScheme"===e.method||"styleDeleted"===e.method)&&requestAnimationFrame(updateWidgetStyle)}function updateWidgetStyle(){funcHeight=0;const color={wrapper:(0,color_mimicry.default)(e.display.wrapper,{bg:"backgroundColor",fore:"color"}),gutter:(0,color_mimicry.default)(e.display.gutters,{bg:"backgroundColor",border:"borderRightColor"}),line:(0,color_mimicry.default)(".CodeMirror-linenumber",null,e.display.lineDiv),comment:(0,color_mimicry.default)("span.cm-comment",null,e.display.lineDiv)},hasBorder="0px"!==color.gutter.style.borderRightWidth&&!/transparent|\b0\)/g.test(color.gutter.style.borderRightColor),t=Math.abs(color.gutter.bgLuma-color.wrapper.foreLuma),n=(hasBorder&&Math.abs(color.gutter.bgLuma-color.gutter.borderLuma),Math.abs(color.gutter.bgLuma-color.line.foreLuma)),fore=n>t||n>.4?color.line.fore:color.wrapper.fore,border=fore.replace(/[\d.]+(?=\))/,.2),borderStyleForced=`1px ${hasBorder?color.gutter.style.borderRightStyle:"solid"} ${border}`;actualStyle.textContent=`\n      ${C_CONTAINER} {\n        background-color: ${color.gutter.bg};\n        border-top: ${borderStyleForced};\n        border-bottom: ${borderStyleForced};\n      }\n      ${C_CONTAINER} ${C_LABEL} {\n        color: ${fore};\n      }\n      ${C_CONTAINER} input,\n      ${C_CONTAINER} select {\n        background: ${color.wrapper.bg};\n        border: ${borderStyleForced};\n        transition: none;\n        color: ${fore};\n      }\n      ${C_CONTAINER} .select-wrapper::after {\n        color: ${fore};\n        transition: none;\n      }\n    `,o.appendChild(actualStyle)}function update(added,removed,cutAt=finder.sections.indexOf(added[0])){const isDelayed=added.isDelayed&&(e.startOperation(),!0),toDelay=[],t=performance.now();let viewTo=editor.default.viewTo||e.display.viewTo;for(const sec of added){const e=removed.findIndex(isReusableWidget,sec),old=removed[e];if(isDelayed||old||sec.start.line<viewTo){if(renderWidget(sec,old),viewTo-=1.25*(sec.funcs.length||1),old&&(removed[e]=null),performance.now()-t>50){toDelay.push(...added.slice(added.indexOf(sec)+1));break}}else toDelay.push(sec)}for(let sec,e=Math.max(0,cutAt),{sections}=finder;e<sections.length;e++)if(!toDelay.includes(sec=sections[e])){const data=sec.widget.node.$(C_LABEL).dataset,t=`${e+1}`;data.index!==t&&(data.index=t)}toDelay.length?(toDelay.isDelayed=!0,setTimeout(update,0,toDelay,removed)):removed.forEach(killWidget),isDelayed&&e.endOperation()}function isReusableWidget(e){return e&&e.widget&&e.widget.line.parent&&e.start&&!cmpPos(e.start,this.start)}function renderWidget(sec,old){let widget=old&&old.widget;const height=Math.round(funcHeight*(sec.funcs.length||1))||void 0,node=renderContainer(sec,widget);return widget&&widget.line.lineNo()===sec.start.line?(widget.node=node,height&&height!==widget.height&&(widget.height=height,widget.changed())):(widget&&widget.clear(),widget=e.addLineWidget(sec.start.line,node,{coverGutter:!0,noHScroll:!0,above:!0,height}),widget.on("redraw",()=>{const value=e.display.barWidth+"px";widget[KEY]!==value&&(widget[KEY]=value,node.style.setProperty("--cm-bar-width",value))})),funcHeight||(funcHeight=node.offsetHeight/(sec.funcs.length||1)),setProp(sec,"widget",widget),widget}function renderContainer(sec,oldWidget){const container=oldWidget?oldWidget.node:TPL.container.cloneNode(!0),elList=container.$(C_LIST),{funcs}=sec,oldItems=elList[KEY]||!1,items=funcs.map((e,t)=>renderFunc(e,oldItems[t]));let slot=elList.firstChild;for(const{item}of items){const e=item[KEY];e!==slot&&(elList.insertBefore(e,slot),slot&&slot.remove(),slot=e),slot=slot.nextSibling}for(let e=funcs.length;oldItems&&e<oldItems.length;e++)if(killFunc(oldItems[e]),slot){const e=slot.nextSibling;slot.remove(),slot=e}return funcs.length||oldItems&&!oldItems.length||TPL.appliesToEverything.cloneNode(!0),setProp(sec,"widgetFuncs",items),elList[KEY]=items,container[KEY]=sec,container.classList.toggle("error",!sec.funcs.length),Object.assign(container,EVENTS)}function renderFunc(func,old={}){const{type,value,isQuoted=!1,start,start:{line},typeEnd={line,ch:start.ch+type.length},valuePos={line,ch:typeEnd.ch+1+Boolean(isQuoted)},valueEnd={line,ch:valuePos.ch+value.length},end={line,ch:valueEnd.ch+Boolean(isQuoted)+1}}=func,e=old.item?.[KEY]||TPL.listItem.cloneNode(!0),elVal=e.$(C_VALUE),res=e[KEY]={str:{type,value},item:markFuncPart(start,end,old.item,e),type:markFuncPart(start,typeEnd,old.type,e.$(C_TYPE),type,toLowerCase),value:markFuncPart(valuePos,valueEnd,old.value,elVal,value,fromDoubleslash)};return e.dataset.type!==type&&(e.dataset.type=type,elVal.focus=focusRegexp,editor.default.toggleRegexp(elVal,type)),res}function markFuncPart(start,end,marker,t,text,textTransform){if(marker){const pos=marker.find();(!pos||cmpPos(pos.from,start)||cmpPos(pos.to,end)||null!=text&&text!==e.getRange(start,end))&&(marker.clear(),marker=null)}return marker||(marker=e.markText(start,end,{clearWhenEmpty:!1,inclusiveLeft:!0,inclusiveRight:!0,[KEY]:t})),null!=text&&(text=textTransform(text),t.value!==text&&(t.value=text)),marker}function killWidget(sec){const e=sec&&sec.widget;e&&(e.clear(),e.node[KEY].widgetFuncs.forEach(killFunc))}function killFunc(e){editor.default.toggleRegexp(e.value[KEY]),e.item.clear(),e.type.clear(),e.value.clear()}function focusRegexp(){e.display.lineDiv.contains(this)||e.jumpToPos(getSectionFor(this).start),Object.getPrototypeOf(this).focus.apply(this,arguments)}function fromDoubleslash(e){return/([^\\]|^)\\([^\\]|$)/.test(e)?e:e.replace(/\\\\/g,"\\")}function toLowerCase(e){return e.toLowerCase()}function setProp(obj,name,value){return Object.defineProperty(obj,name,{value,configurable:!0})}}function SourceEditor(){const{style,dirty}=editor.default,DEFAULT_TEMPLATE="\n    /* ==UserStyle==\n    @name           \n    @namespace      github.com/openstyles/stylus\n    @version        1.0.0\n    @description    A new userstyle\n    @author         Me\n    ==/UserStyle== */\n  ".replace(/^\s+/gm,"");let savedGeneration,prevSel,sectionFinder,sectionWidget,mozSections,updateTocFocusPending,prevMode=NaN;dom.$$remove(".sectioned-only"),n.getElementById("header").on("wheel",function({target,deltaY,deltaMode,shiftKey}){for(;target=target.parentElement;)if(deltaY<0&&target.scrollTop||deltaY>0&&target.scrollTop+target.clientHeight<target.scrollHeight)return;e.display.scroller.scrollTop+=1===deltaMode?deltaY*e.defaultTextHeight():2===deltaMode||shiftKey?Math.sign(deltaY)*e.display.scroller.clientHeight:deltaY}),n.getElementById("sections").textContent="",n.getElementById("sections").appendChild(dom.$create(".single-editor")),n.getElementById("save-button").on("split-btn",async function(){const res=await dom_util.messageBox.show({contents:util.t("usercssReplaceTemplateConfirmation"),className:"center",buttons:[util.t("confirmYes"),util.t("confirmNo"),{textContent:util.t("genericResetLabel"),title:util.t("restoreTemplate")}]});if(res.enter||1!==res.button){const key=chrome_sync.LZ_KEY.usercssTemplate,code=2===res.button?DEFAULT_TEMPLATE:e.getValue();await chrome_sync.setLZValue(key,code),await chrome_sync.getLZValue(key)!==code&&dom_util.messageBox.alert(util.t("syncStorageErrorSaving"))}});const cmpPos=src_cm.CodeMirror.cmpPos,e=codemirror_factory.default.create(n.querySelector(".single-editor"),{value:style.id?style.sourceCode:function(tpl){const comment=`/* ${util.t("usercssReplaceTemplateSectionBody")} */`,sec0=style.sections[0];sec0.code=" ".repeat(prefs.__values["editor.tabSize"])+comment,1===Object.keys(sec0).length&&(sec0.domains=["example.com"]);return style.sourceCode=(tpl||DEFAULT_TEMPLATE).replace(/(@name)(?:([\t\x20]+).*|\n)/,(e,t,space)=>`${t}${space||" "}${style.name}`).replace(/\s*@-moz-document[^{]*{([^}]*)}\s*$/g,(e,body)=>body.trim()===comment?"\n\n":e).trim()+"\n\n"+sections_util.styleToCss(style)}(editor.default.template),finishInit(e){const kToc="editor.toc.expanded",kWidget="editor.appliesToLineWidget",t=editor.default.applyScrollInfo(e)||{};editor.default.viewTo=t.viewTo,sectionFinder=MozSectionFinder(e),sectionWidget=MozSectionWidget(e,sectionFinder),mozSections=editor.default.sections=sectionFinder.sections,prevSel=e.doc.sel,prefs.subscribe([kToc,kWidget],(t,val)=>{sectionFinder.onOff(updateToc,prefs.__values[kToc]||prefs.__values[kWidget]),t===kWidget&&sectionWidget.toggle(val),t===kToc&&e[val?"on":"off"]("cursorActivity",onCursorActivity)},!0),Object.assign(e.curOp,t.scroll),editor.default.viewTo=0}}),metaCompiler=function(onUpdated){let meta,iFrom,iTo,min,max,prevRes,busy,done;return linter.register(run),run;async function run(text,options,cm2){if(cm2&&cm2!==e)return;if(busy)return busy;if(meta&&!cm2){for(const change of text){const e=change.from,t=src_cm.CodeMirror.changeEnd(change);(cmpPos(e,min)<0?(min=e,cmpPos(t,min)>=0):cmpPos(e,max)<=0)&&(cmpPos(t,max)>0&&(max=t),text="")}if(text)return;text=e.getValue()}if(meta&&text.charCodeAt(iFrom)===meta.charCodeAt(iFrom)&&text.charCodeAt(iTo)===meta.charCodeAt(iTo)&&text.slice(iFrom,iTo+1)===meta)return prevRes;const match=text.match(util.RX_META);if(!match)return[];busy=new Promise(e=>done=e);const{metadata,errors}=await edit_util.worker.metalint(match[0]);errors.every(err=>"unknownMeta"===err.code)&&onUpdated(metadata),meta=match[0],iFrom=match.index,min=e.posFromIndex(iFrom),iTo=iFrom+meta.length-1,max=e.posFromIndex(iTo);for(let t=0;t<errors.length;t++){const{code,index,args,message}=errors[t],isUnknownMeta="unknownMeta"===code,typo=isUnknownMeta&&args[1]?"Typo":"";errors[t]={from:e.posFromIndex((index||0)+t),to:e.posFromIndex((index||0)+t),message:code&&util.t(`meta_${code}${typo}`,args,!1)||message,severity:isUnknownMeta?"warning":"error",rule:code}}return prevRes=errors,done(prevRes),prevRes}}(meta=>{const{vars}=style.usercssData||{};if(vars){let e;for(const[key,val]of Object.entries(meta.vars||{}))(e=vars[key])&&e.type===val.type&&null!=(e=e.value)&&(val.value=e)}style.usercssData=meta,style.name=meta.name,style.url=meta.homepageURL||style.installationUrl,updateMeta()});function showLog(log){if(log)for(const args of log)console.log(...args)}function updateLivePreview(){style.id&&showLog(editor.default.livePreview(Object.assign({},style,{sourceCode:e.getValue()})))}function updateLinterSwitch(){const e=n.getElementById("editor.linter");if(!e)return;e.value=getCurrentLinter();const cssLintOption=e.$('[value="csslint"]'),mode=getModeName();"css"!==mode?(cssLintOption.disabled=!0,cssLintOption.title=util.t("linterCSSLintIncompatible",mode)):(cssLintOption.disabled=!1,cssLintOption.title="")}function getCurrentLinter(){const name=prefs.__values["editor.linter"];return"css"!==e.getOption("mode")&&"csslint"===name?"stylelint":name}function updateMeta(){const name=style.customName||style.name;n.getElementById("name").value=name,n.getElementById("enabled").checked=style.enabled,n.getElementById("url").href=style.url,editor.default.updateName(),e.setPreprocessor(style.usercssData?.preprocessor)}async function replaceStyle(newStyle,draft){dirty.clear("name");const sameCode=editor.default.isSame(newStyle);if(sameCode)return savedGeneration=e.changeGeneration(),editor.default.useSavedStyle(newStyle),dirty.clear("sourceGeneration"),dirty.clear("enabled"),void updateLivePreview();if(draft||await dom_util.messageBox.confirm(util.t("styleUpdateDiscardChanges"))){if(editor.default.useSavedStyle(newStyle),!sameCode){const si0=draft&&draft.si.cms[0],cursor=!si0&&e.getCursor();e.setValue(style.sourceCode),si0?editor.default.applyScrollInfo(e,si0):e.setCursor(cursor),savedGeneration=e.changeGeneration()}sameCode&&updateLivePreview(),draft||dirty.clear()}}function showSaveError(err,errStyle){const shift=err._varLines-1||0,text=(err=Array.isArray(err)?err:[err]).map(e=>e.message||e).join("\n"),points=err.map(t=>t.index>=0&&e.posFromIndex(t.index)||t.offset>=0&&{line:t.line-1,ch:t.col-1}).filter(Boolean),t=errStyle.usercssData.preprocessor,ppUrl=editor.default.ppDemo[t];e.setSelections(points.map(e=>({anchor:e,head:e}))),dom_util.messageBox.show({title:util.t("genericError"),className:"center pre danger",contents:dom.$create("pre","stylus"===t&&shift?text.replace(/^.+\n/,"").replace(/^(\s*)(\d+)/gm,(e,t,n)=>t+(n-shift)):text),buttons:[util.t("confirmClose"),ppUrl&&dom.$createLink({className:"icon",href:ppUrl},[util.t("genericTest"),dom.$create("i.i-external",{style:"line-height:0"})])]})}function nextPrevSection(dir){sectionFinder.keepAliveFor(nextPrevSection,1e4),sectionFinder.updatePositions();const num=mozSections.length;if(!num)return;dir=dir<0?-1:0;const pos=e.getCursor();let t=mozSections.findIndex(sec=>src_cm.CodeMirror.cmpPos(sec.start,pos)>Math.min(dir,0));t<0&&(!dir||src_cm.CodeMirror.cmpPos(mozSections[num-1].start,pos)<0)&&(t=0),e.jumpToPos(mozSections[(t+dir+num)%num].start)}function getBadRegexps({sections}){const res=[];for(const{regexps}of sections)if(regexps)for(const e of regexps){const err=editor.failRegexp(e);err&&res.push(`${err}: ${e}`)}return res.join("\n\n")}function getModeName(){const mode=e.doc.mode;return mode?(mode.name||mode||"")+(mode.helperType||""):""}function onCursorActivity(){prevSel!==e.doc.sel&&(prevSel=e.doc.sel,updateTocFocusPending??=Promise.resolve().then(updateTocFocus))}function updateToc(...args){editor.default.updateToc(...args),updateTocFocus()}function updateTocFocus(){updateTocFocusPending=null;const pos=prevSel.ranges[0].head,toc=editor.default.toc;let e,sec,end=mozSections.length,t=0,n=end--,o=pos.line&&Math.min(toc.i??t+n>>1,end);for(;t<n&&e!==o;){if(sec=mozSections[o],cmpPos(sec.start,pos)>0)n=o;else{if(!(o<end&&cmpPos(mozSections[o+1].start,pos)<=0))return o!==toc.i&&editor.default.updateToc({focus:!0,0:sec});t=o}e=o,o=t+n>>1}toc.el.$("."+toc.cls)?.classList.remove(toc.cls),toc.i=null}updateMeta(),prefs.subscribe("editor.linter",updateLinterSwitch,!0),Object.assign(editor.default,{replaceStyle,updateLinterSwitch,updateLivePreview,updateMeta,closestVisible:()=>e,getCurrentLinter,getEditors:()=>[e],getEditorTitle:()=>"",getValue:asObject=>asObject?{customName:style.customName,enabled:style.enabled,sourceCode:e.getValue()}:e.getValue(),getSearchableInputs:()=>[],isSame:styleObj=>styleObj.sourceCode===e.getValue(),prevEditor:nextPrevSection.bind(null,-1),nextEditor:nextPrevSection.bind(null,1),jumpToEditor(t){const sec=sectionFinder.sections[t];sec&&(sectionFinder.updatePositions(sec),e.jumpToPos(sec.start),e.focus())},async saveImpl(){const sourceCode=e.getValue();let res;try{const{customName,enabled,id:e}=style;res=!e&&await msg_api.API.usercss.build({sourceCode,checkDup:!0,metaOnly:!0}),res&&res.dup?dom_util.messageBox.alert(util.t("usercssAvoidOverwriting"),"danger",util.t("genericError")):(res=await msg_api.API.usercss.editSave({customName,enabled,id:e,sourceCode}),await replaceStyle(res.style),(res.badRe=getBadRegexps(res.style))&&dom_util.messageBox.alert(res.badRe,"danger pre",util.t("styleBadRegexp"))),showLog(res.log)}catch(e){showSaveError(e,res&&res.style||style)}},scrollToEditor:()=>{}}),savedGeneration=e.changeGeneration(),e.on("changes",(t,changes)=>{dirty.modify("sourceGeneration",savedGeneration,e.changeGeneration()),editor.default.livePreviewLazy(updateLivePreview),metaCompiler(changes)}),e.on("optionChange",(e,option)=>{if("mode"!==option)return;const mode=getModeName();mode!==prevMode&&(prevMode=mode,linter.run(),updateLinterSwitch())}),setTimeout(linter.enableForEditor,0,e),dom.$isTextInput(n.activeElement)||e.focus()}l(5483);const{defaults,commands}=src_cm.CodeMirror,ECP="editor.colorpicker.",a="colorpicker";function invokeColorpicker(e){e.state[a].openPopup(prefs.__values[ECP+"color"])}prefs.subscribe(ECP+"hotkey",(e,hotkey)=>{commands[a]=invokeColorpicker;for(const key in src_cm.extraKeys)if(src_cm.extraKeys[key]===a){delete src_cm.extraKeys[key];break}hotkey&&(src_cm.extraKeys[hotkey]=a)},!0),prefs.subscribe(ECP.slice(0,-1),(e,enabled)=>{const keyName=prefs.__values[ECP+"hotkey"];defaults[a]=enabled,enabled?(keyName&&(commands[a]=invokeColorpicker,src_cm.extraKeys[keyName]=a),defaults[a]={tooltip:util.t("colorpickerTooltip"),popup:{tooltipForSwitcher:util.t("colorpickerSwitchFormatTooltip"),paletteLine:util.t("numberedLine"),paletteHint:util.t("colorpickerPaletteHint"),hexUppercase:prefs.__values[ECP+"hexUppercase"],embedderCallback:state=>{for(const e of["hexUppercase","color"])state[e]!==prefs.__values[ECP+e]&&prefs.set(ECP+e,state[e])},get maxHeight(){return prefs.__values[ECP+"maxHeight"]},set maxHeight(e){prefs.set(ECP+"maxHeight",e)}}}):delete src_cm.extraKeys[keyName],codemirror_factory.default.globalSetOption(a,defaults[a])},!0);let errPos,c,data,port,enabled;function createPreviewer(){port=chrome.runtime.connect({name:"livePreview:"+editor.default.style.id}),port.onDisconnect.addListener(()=>port=null),c=n.getElementById("preview-errors"),c.onclick=showError}function showError(){if(errPos){const e=editor.default.getEditors()[0];e.jumpToPos(errPos),e.focus()}}async function updatePreviewer(newData){try{await msg_api.API.styles.preview(newData),c.hidden=!0}catch(t){const ucd=newData.usercssData,e=ucd&&ucd.preprocessor,shift=t._varLines+1||0;errPos=e&&(t.line??=t.lineno)&&t.column?{line:t.line-shift,ch:t.column-1}:t.index,t=Array.isArray(t)?t.map((e,t,n)=>(t=e.message)?(n=e.context)?`${t} in ${n}`:t:e).join("\n"):t.message||`${t}`,errPos>=0?errPos=editor.default.getEditors()[0].posFromIndex(errPos):!errPos&&"stylus"===e&&(errPos=t.match(/^\w+:(\d+):(\d+)(?:\n.+)+\s+(.+)/))&&(t=errPos[3],errPos={line:errPos[1]-shift,ch:errPos[2]-1}),c.title=c.firstChild.textContent=(errPos?`${errPos.line+1}:${errPos.ch+1} `:"")+t,c.lastChild.hidden=!(c.lastChild.href=editor.default.ppDemo[e]),c.hidden=!1}}prefs.subscribe("editor.livePreview",(key,value,init)=>{enabled=value,init||(value?data&&data.id&&(data.enabled||editor.default.dirty.has("enabled"))&&(createPreviewer(),updatePreviewer(data)):port&&(port.disconnect(),port=null))},!0),editor.default.livePreview=newData=>{if(!port){if(!enabled||!newData.id||!newData.enabled&&data&&!data.enabled||!editor.default.dirty.isDirty())return;createPreviewer()}data=newData,updatePreviewer(data)};var urls=l(8982);function USWIntegration(){const ERROR_TITLE="UserStyles.world "+util.t("genericError"),META_KEYS=["name","description","license","username>author","homepage","namespace"],elProgress=n.getElementById("usw-progress"),e=n.getElementById("publish"),btnPublish=n.getElementById("usw-publish-style"),style=editor.default.style;let spinner,spinnerTimer=0,prevCode="";async function publishStyle(){const{id:e,_usw:t}=style;if(await msg_api.API.data.has("usw"+e)&&!await dom_util.messageBox.confirm(util.t("publishRetry"),"danger",ERROR_TITLE))return;let error;const code=editor.default.getValue(),isDiff=code!==prevCode,res=isDiff?await msg_api.API.usw.publish(e,code,t).catch(e=>error=e.message):util.t("importReportUnchanged"),title=`${(new Date).toLocaleString()}\n${res}`,failed=error||/^Error:/.test(res);elProgress.append(...failed?[dom.$create("a.error[data-cmd=note]",{title,tabIndex:0},res),t&&t.token&&dom.$create("div",util.t("publishReconnect"))].filter(Boolean):[dom.$create("span."+(isDiff?"success":"unchanged"),{title})]),failed||(prevCode=code)}async function disconnect(){await msg_api.API.usw.revoke(style.id),prevCode=null}function updateUI(){const usw=style._usw||!1,elUrl=n.getElementById("usw-url"),elData=n.getElementById("usw-data"),isOn=!!usw.token;if(dom.$toggleDataset(e,"connected",isOn),e.classList.toggle("ignore-pref",!isOn),isOn||(e.open=!1),elUrl.href=`${urls.usw}${usw.id?`style/${usw.id}`:""}`,elUrl.textContent=util.t("publishUsw").replace(/<(.+)>/,"$1"+(usw.id?`#${usw.id}`:"")),!(elData.hidden=editor.default.isUsercss))for(const key of META_KEYS){const[from,e=from]=key.split(">"),value=usw[from]||"",t="usw-data-"+e;let o=n.getElementById(t);o||(o=dom.$create("input",{id:t,_from:from,placeholder:"name"===key?style[key]:""}),o.on("input",onDataChanged),elData.appendChild(n.createElement("div")).append(dom.$create("label",{htmlFor:t},"@"+e),o)),o.value=value,onDataChanged.call(o)}}function onDataChanged(){const val=this.value.trim(),usw=style._usw||val&&(style._usw={}),key=this._from;editor.default.dirty.modify(this.id,usw&&usw[key]||"",val),usw&&(val?usw[key]=val:delete usw[key]&&util.isEmptyObj(usw)&&(style._usw=null)),this.parentElement.classList.toggle("empty",!val)}function timerOn(){spinnerTimer||(elProgress.textContent="",spinnerTimer=setTimeout(()=>spinner=dom_util.showSpinner(elProgress),250))}function timerOff(){spinner?.remove(),clearTimeout(spinnerTimer),spinnerTimer=0,spinner=null}msg.onMessage.set(request=>{if("uswData"===request.method&&request.style.id===style.id){Object.assign(style,request.style);for(const e of n.querySelectorAll("#usw-data input"))editor.default.dirty.clear(e.id);updateUI()}}),updateUI(),btnPublish.onclick=n.getElementById("usw-disconnect").onclick=async function(){this.disabled=!0,timerOn(),await(this===btnPublish?publishStyle:disconnect)().catch(console.error),timerOff(),this.disabled=!1}}l(9458);var d=l(8970);function EmbeddedPopup(){const e="popup-iframe",POPUP_HOTKEY="Shift-Ctrl-Alt-S";let frame,isLoaded,scrollbarWidth;const btn=dom.$create("img",{id:"popup-button",title:util.t("optionsCustomizePopup")+"\n"+POPUP_HOTKEY,onclick:embedPopup});function embedPopup(){n.getElementById(e)||(isLoaded=!1,scrollbarWidth=0,frame=dom.$create("iframe",{id:e,src:urls.actionPopupUrl,height:600,width:prefs.__values.popupWidth,onload:initFrame}),t.on("mousedown",removePopup),n.body.appendChild(frame))}function initFrame(){frame=this,frame.focus();const e=frame.contentWindow,body=e.document.body;e.on("keydown",removePopupOnEsc),e.close=removePopup,new e.IntersectionObserver(onIntersect).observe(body.appendChild(dom.$create("div",{style:"height: 1px; marginTop: -1px;"}))),new e.MutationObserver(onMutation).observe(body,{attributes:!0,attributeFilter:["style"]})}function onMutation(){const body=frame.contentDocument.body,e=body.style,t=parseFloat(e.minWidth||e.width)+(scrollbarWidth||0),n=parseFloat(e.minHeight||body.offsetHeight);frame.width-t&&(frame.width=t),frame.height-n&&(frame.height=n)}function onIntersect([e]){const t=frame.contentWindow,n=t.document.scrollingElement,o=e.intersectionRatio&&!t.scrollY?n.offsetHeight:n.scrollHeight,hasSB=o>n.offsetHeight,{width}=e.boundingClientRect;frame.height=o,(!hasSB!=!scrollbarWidth||frame.width-width)&&(scrollbarWidth=hasSB?width-n.offsetWidth:0,frame.width=width+scrollbarWidth),isLoaded||(isLoaded=!0,frame.dataset.loaded="")}function removePopup(){frame=null,n.getElementById(e)?.remove(),t.off("mousedown",removePopup)}function removePopupOnEsc(e){"Escape"===dom_util.getEventKeyName(e)&&removePopup()}o.appendChild(btn),i.add("popup-window"),n.body.appendChild(btn),src_cm.extraKeys[POPUP_HOTKEY]="openStylusPopup",prefs.subscribe("iconset",(e,val)=>{const prefix=`${util_webext.MF_ICON_PATH}${val?"light/":""}`;btn.srcset=`${prefix}16${util_webext.MF_ICON_EXT} 1x,${prefix}32${util_webext.MF_ICON_EXT} 2x`},!0),t.on("keydown",e=>{dom_util.getEventKeyName(e)===POPUP_HOTKEY&&embedPopup()})}let ownTabId;if(util_webext.browserWindows){!async function(){chrome.tabs.onAttached.addListener(onTabAttached);const isSimple=["app","popup"].includes((await util_webext.browserWindows.getCurrent()).type);isSimple&&EmbeddedPopup();editor.default.isWindowed=isSimple||1===history.length&&prefs.__values.openEditInWindow&&(await util_webext.browserWindows.getAll()).length>1&&1===(await browser.tabs.query({currentWindow:!0})).length}();const pos=util.tryJSONparse(util.sessionStore.windowPos);delete util.sessionStore.windowPos,pos&&null!=pos.left&&util_webext.browserWindows.update(util_webext.browserWindows.WINDOW_ID_CURRENT,pos)}async function onTabAttached(tabId,info){if(tabId!==ownTabId)return;if(0!==info.newPosition)return void prefs.set("openEditInWindow",!1);const openEditInWindow=1===(await util_webext.browserWindows.get(info.newWindowId,{populate:!0})).tabs.length;openEditInWindow&&d.FIREFOX&&util_webext.browserWindows.update(info.newWindowId,prefs.__values.windowPosition),prefs.set("openEditInWindow",openEditInWindow)}util_webext.getOwnTab().then(tab=>{ownTabId=tab.id,util.sessionStore["manageStylesHistory"+ownTabId]===location.href&&(editor.default.cancel=()=>history.back())}),localization.tBody(),(async()=>{load_style&&await load_style,editor.default.scrollInfo.sticky&&compact_header.toggleSticky(!0),EditorHeader(),USWIntegration(),(editor.default.isUsercss?SourceEditor:SectionsEditor)(),editor.default.dirty.onChange(editor.default.updateDirty),prefs.subscribe("editor.linter",()=>linter.run()),(0,compact_header.default)(),l.e("edit_lazy-init_js").then(l.bind(l,5740));const cmCommands=src_cm.CodeMirror.commands;for(const cmd of["find","findNext","findPrev","replace","replaceAll"])cmCommands[cmd]=async(...args)=>{await l.e("edit_global-search_js").then(l.bind(l,4161)),cmCommands[cmd](...args)};n.getElementById("name").required=!editor.default.isUsercss,n.getElementById("save-button").onclick=editor.default.save,n.getElementById("cancel-button").onclick=editor.default.cancel,n.getElementById("testRE").onclick=async function(){(this.onclick=(await l.e("edit_regexp-tester_js").then(l.bind(l,4670))).toggle)(!0)},n.getElementById("lint-help").onclick=async function(){(this.onclick=(await l.e("edit_linter_dialogs_js").then(l.bind(l,3253))).showLintHelp)()};const elSec=n.getElementById("sections-list"),elToc=n.getElementById("toc"),moDetails=new MutationObserver(([{target:sec}])=>{if(!sec.open)return;sec===elSec&&editor.default.updateToc();const e=sec.lastElementChild,t=e.style;sec.getBoundingClientRect().left+e.getBoundingClientRect().width>innerWidth-30?t.right="0":t.right&&t.removeProperty("right")});elSec.open&&editor.default.updateToc();for(const e of n.querySelectorAll("#details-wrapper > details"))moDetails.observe(e,{attributes:!0,attributeFilter:["open"]});elToc.onclick=e=>editor.default.jumpToEditor([].indexOf.call(elToc.children,e.target))})()},8864:(e,t,n)=>{const WARNING={severity:"warning"},ENABLED_AS_WARNING=[!0,WARNING],DEFAULTS={stylelint:{rules:{"at-rule-no-unknown":[!0,{ignoreAtRules:["extend","extends","css","block"],...WARNING}],"block-no-empty":ENABLED_AS_WARNING,"color-no-invalid-hex":ENABLED_AS_WARNING,"declaration-block-no-duplicate-properties":[!0,{ignore:["consecutive-duplicates-with-different-values"],...WARNING}],"declaration-block-no-shorthand-property-overrides":ENABLED_AS_WARNING,"font-family-no-duplicate-names":ENABLED_AS_WARNING,"function-calc-no-unspaced-operator":ENABLED_AS_WARNING,"function-linear-gradient-no-nonstandard-direction":ENABLED_AS_WARNING,"keyframe-declaration-no-important":ENABLED_AS_WARNING,"media-feature-name-no-unknown":ENABLED_AS_WARNING,"no-invalid-double-slash-comments":ENABLED_AS_WARNING,"property-no-unknown":ENABLED_AS_WARNING,"selector-pseudo-class-no-unknown":ENABLED_AS_WARNING,"selector-pseudo-element-no-unknown":ENABLED_AS_WARNING,"string-no-newline":ENABLED_AS_WARNING,"unit-no-unknown":ENABLED_AS_WARNING}},csslint:{"display-property-grouping":1,"duplicate-properties":1,"empty-rules":1,errors:1,"globals-in-document":1,"known-properties":1,"known-pseudos":1,"selector-newline":1,"shorthand-overrides":1,"simple-not":1,warnings:1}};t.DEFAULTS=DEFAULTS},2414:(e,t,n)=>{t.disableForEditor=function(e){e.setOption("lint",!1),cms.delete(e);for(const t of unhookListeners)t(e)},t.enableForEditor=function(e,code){if(cms.has(e))return;cms.set(e,null),code?enableOnProblems(e,code):e.setOption("lint",{getAnnotations,onUpdateLinting})},t.onLintingUpdated=function(e){lintingUpdatedListeners.push(e)},t.onUnhook=function(e){unhookListeners.push(e)},t.register=register,t.run=run;const cms=new Map,linters=[],lintingUpdatedListeners=[],unhookListeners=[];var chrome_sync=n(7033),prefs=n(492),util_webext=n(1480),editor=n(9920),util=n(4849),defaults=n(8864);const configs=new Map,ENGINES={csslint:{validMode:mode=>"css"===mode,getConfig:config=>Object.assign({},defaults.DEFAULTS.csslint,config),async lint(text,config){config.doc=!editor.default.isUsercss;return(await util.worker.csslint(text,config)).map(({line,col:e,message,rule,type:severity})=>line&&{message,from:{line:line-1,ch:e-1},to:{line:line-1,ch:e},rule:rule.id,severity}).filter(Boolean)}},stylelint:{validMode:()=>!0,getConfig:config=>({rules:Object.assign({},defaults.DEFAULTS.stylelint.rules,config&&config.rules)}),lint:(code,config,mode)=>util.worker.stylelint({code,config,mode})}};async function getConfig(name){const rawCfg=await chrome_sync.getLZValue(chrome_sync.LZ_KEY[name]),cfg=ENGINES[name].getConfig(rawCfg);return configs.set(name,cfg),cfg}register(async(text,e,t)=>{const linter=prefs.__values["editor.linter"];if(linter){const{mode}=t.options,currentFirst=Object.entries(ENGINES).sort(([e])=>e===linter?-1:1);for(const[name,engine]of currentFirst)if(engine.validMode(mode)){const cfg=configs.get(name)||await getConfig(name);return ENGINES[name].lint(text,cfg,mode)}}}),util_webext.onStorageChanged.addListener(changes=>{for(const name of Object.keys(ENGINES))chrome_sync.LZ_KEY[name]in changes&&getConfig(name).then(run)});var reports=n(3432);function register(e){linters.push(e)}function run(){for(const e of cms.keys())e.performLint()}async function enableOnProblems(e,code){const results=await getAnnotations(code,{},e);results.length||e.display.renderedView?(cms.set(e,results),e.setOption("lint",{getAnnotations:getCachedAnnotations,onUpdateLinting})):cms.delete(e)}async function getAnnotations(...args){const results=await Promise.all(linters.map(e=>e(...args)));return[].concat(...results.filter(Boolean))}function getCachedAnnotations(code,opt,e){const results=cms.get(e);return cms.set(e,null),e.state.lint.options.getAnnotations=getAnnotations,results}function onUpdateLinting(...args){for(const e of lintingUpdatedListeners)e(...args)}n.d(t,{refreshReport:()=>reports.refreshReport})},3432:(e,t,o)=>{t.getIssues=function(){const issues=new Set;for(const table of tables.values())for(const e of table.trs)issues.add(e._anno);return issues},t.refreshReport=function(){for(const table of tables.values())table.updateCaption()};var localization=o(7501),util=o(6940),linter=o(2414),editor=o(9920);const tables=new Map;let tplReport,tplRow,rowSeverityIcon,rowSeverity,rowLine,rowCol,rowMessage;function updateCount(){const issueCount=Array.from(tables.values()).reduce((sum,table)=>sum+table.trs.length,0);n.getElementById("lint").hidden=!issueCount,n.getElementById("issue-count").textContent=issueCount}function findNextSibling(e){const editors=editor.default.getEditors();let t=editors.indexOf(e)+1;for(;t<editors.length;){if(tables.has(editors[t]))return editors[t];t++}}function createTable(e){tplReport||(tplReport=localization.htmlToTemplate("<div class=report><div class=caption></div><table><tr><td role=severity><div></div></td><td role=line></td><td role=sep>:</td><td role=col></td><td role=message></td></tr></table></div>"),tplRow=tplReport.$("tr"),tplRow.remove());const report=tplReport.cloneNode(!0),caption=report.$(".caption"),table=report.$("table"),trs=[];return table._cm=e,table.onclick=gotoLintIssue,{element:report,trs,updateAnnotations:function(lines){let e=0;for(const anno of function*(){for(const line of lines)line&&(yield*line)}()){const t=createTr(anno);e<trs.length?trs[e].replaceWith(trs[e]=t):(trs.push(t),table.appendChild(t)),e++}if(e)for(;trs.length>e;)trs.pop().remove();else trs.length=0,table.textContent="";report.classList.toggle("empty",!e)},updateCaption:function(){const t=editor.default.getEditorTitle(e);"string"==typeof t?caption.textContent=t:Object.assign(caption,t)}};function createTr(anno){rowCol||([rowSeverity,rowLine,,rowCol,rowMessage]=tplRow.children,rowSeverityIcon=rowSeverity.firstChild);const{message,from,rule,severity}=anno;rowSeverity.dataset.rule=rule,rowSeverityIcon.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+severity,rowSeverityIcon.textContent=severity,rowLine.textContent=from.line+1,rowCol.textContent=from.ch+1,rowMessage.title=util.clipString(message,1e3)+(rule?`\n(${rule})`:""),rowMessage.textContent=util.clipString(message,100).replace(/ at line.*/,"");const e=tplRow.cloneNode(!0);return e.className=severity,e._anno=anno,e}}function gotoLintIssue(e){const t=e.target.closest("tr"),n=this._cm;editor.default.scrollToEditor(n),n.focus(),n.jumpToPos(t._anno.from)}linter.onLintingUpdated((annotationsNotSorted,annotations,e)=>{let table=tables.get(e);if(!table){table=createTable(e),tables.set(e,table);const container=n.querySelector(".lint-report-container"),nextSibling=findNextSibling(e);container.insertBefore(table.element,nextSibling&&tables.get(nextSibling).element)}table.updateCaption(),table.updateAnnotations(annotations),updateCount()}),linter.onUnhook(e=>{const table=tables.get(e);table&&(table.element.remove(),tables.delete(e)),updateCount()})},4849:(e,i,s)=>{i.createHotkeyInput=function(prefId,{buttons=!0,onDone}){const RX_ERR=new RegExp("^("+[/Space/,/(Shift-)?./,/(?=.)(Shift-?|Ctrl-?|Control-?|Alt-?|Meta-?)*(Escape|Tab|Page(Up|Down)|Arrow(Up|Down|Left|Right)|Home|End)?/].map(e=>e.source||e).join("|")+")$","i"),initialValue=prefs.__values[prefId],input=dom.$create("input",{spellcheck:!1,onpaste:e=>onkeydown(e,e.clipboardData.getData("text")),onkeydown});buttons=buttons&&[["confirmOK","Enter"],["undo",initialValue],["genericResetLabel",""]].map(([label,val])=>dom.$create("button",{onclick:e=>onkeydown(e,val)},util.t(label)));const[btnOk,btnUndo,btnReset]=buttons||[];return onkeydown(null,initialValue),buttons?dom.$createFragment([input,dom.$create(".buttons",buttons)]):input;function onkeydown(e,key){let newValue;switch(e&&"keydown"===e.type&&(key=dom_util.getEventKeyName(e)),e&&key){case"Tab":case"Shift-Tab":return;case"BackSpace":case"Delete":newValue="";break;case"Enter":input.checkValidity()&&onDone&&onDone(e);break;case"Escape":onDone&&onDone(e);break;default:newValue=key.replace(/\b.$/,e=>e.toUpperCase())}if(null!=newValue){const error=RX_ERR.test(newValue)?util.t("genericError"):"";e&&!error&&prefs.set(prefId,newValue),input.setCustomValidity(error),input.value=newValue,input.focus(),buttons&&(btnOk.disabled=Boolean(error),btnUndo.disabled=newValue===initialValue,btnReset.disabled=!newValue)}e&&(e.preventDefault(),e.stopPropagation())}},i.showCodeMirrorPopup=function(title,html,options){const popup=helpPopup.show(title,html,{className:"big"});let e=popup.codebox=src_cm.CodeMirror(popup._contents,Object.assign({mode:"css",lineNumbers:!0,lineWrapping:prefs.__values["editor.lineWrapping"],foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter","CodeMirror-lint-markers"],matchBrackets:!0,styleActiveLine:!0,theme:prefs.__values[src_cm.THEME_KEY],keyMap:prefs.__values["editor.keyMap"]},options));e.focus(),o.style.pointerEvents="none",popup.style.pointerEvents="auto";const onKeyDown=event=>{if("Tab"===event.key&&!event.ctrlKey&&!event.altKey&&!event.metaKey){const search=n.getElementById("search-replace-dialog"),area=search&&search.contains(n.activeElement)?search:popup;dom_util.moveFocus(area,event.shiftKey?-1:1),event.preventDefault()}};return t.on("keydown",onKeyDown,!0),popup.onClose.add(()=>{t.off("keydown",onKeyDown,!0),o.style.removeProperty("pointer-events"),e=popup.codebox=null}),popup},i.trimCommentLabel=function(str,limit=1e3){return util.clipString(str.replace(/^[!-/:;=\s]*|[-#$&(+,./:;<=>\s*]*$/g,""),limit)};var src_cm=s(6199),dom=s(7986),dom_util=s(3831),localization=s(7501),port=s(5619),prefs=s(492),util=s(6940),urls=s(8982),editor=s(9920);const helpPopup={SEL:"#help-popup",show(title="",body,props,e=title){const div=dom.$create(helpPopup.SEL,props),old=e&&n.querySelector(`${helpPopup.SEL}[data-id="${CSS.escape(e)}"] > .i-close`);return old&&old.click(),div.dataset.id=e,div.append(div._close=dom.$create("i.i-close",{onclick:helpPopup.close}),div._title=dom.$create(".title",title),div._contents=dom.$create(".contents",body&&localization.tHTML(body))),n.body.append(div),div.onClose=new Set,t.on("keydown",helpPopup.close,!0),helpPopup.originalFocus=n.activeElement,dom_util.moveFocus(div,0),div},close(event){let e;const canClose=!(event&&"click"!==event.type&&("Escape"!==dom_util.getEventKeyName(event)||n.querySelector(".CodeMirror-hints, #message-box")||(e=n.activeElement)&&e.closest("#search-replace-dialog"))),div=event&&event.target.closest(helpPopup.SEL)||[...n.querySelectorAll(helpPopup.SEL)].pop();if(canClose&&div){if(!event||!(e=div.codebox)||e.options.readOnly||e.isClean()){div.contains(n.activeElement)&&(e=helpPopup.originalFocus)&&e.focus(),div.remove();for(const e of div.onClose)e();return n.querySelector(helpPopup.SEL)||t.off("keydown",helpPopup.close,!0),!0}setTimeout(async()=>await dom_util.messageBox.confirm(util.t("confirmDiscardChanges"))&&helpPopup.close())}}},rerouteHotkeys={commands:["beautify","colorpicker","find","findNext","findPrev","jumpToLine","nextEditor","prevEditor","replace","replaceAll","save","toggleEditorFocus","toggleStyle"],toggle(enable){n[enable?"on":"off"]("keydown",rerouteHotkeys.handler)},handler(event){const keyName=src_cm.CodeMirror.keyName(event);if(!keyName)return;const rerouteCommand=name=>{if(rerouteHotkeys.commands.includes(name))return src_cm.CodeMirror.commands[name](editor.default.closestVisible(event.target)),!0};"handled"!==src_cm.CodeMirror.lookupKey(keyName,src_cm.CodeMirror.defaults.keyMap,rerouteCommand)&&"handled"!==src_cm.CodeMirror.lookupKey(keyName,src_cm.extraKeys,rerouteCommand)||(event.preventDefault(),event.stopPropagation())}},worker=port.createPortProxy(urls.workerPath);i.helpPopup=helpPopup,i.rerouteHotkeys=rerouteHotkeys,i.worker=worker,s.d(i,{htmlAppliesTo:()=>'<li class=applies-to-item><div class=select-wrapper><select name=applies-type class=applies-type><option value="" i18n=appliesToEverything></option><option value=url i18n=appliesUrlOption></option><option value=url-prefix i18n=appliesUrlPrefixOption></option><option value=domain i18n=appliesDomainOption></option><option value=regexp i18n=appliesRegexpOption></option></select></div><div class=applies-value-wrapper><input name=applies-value class=applies-value spellcheck=false><a class=remove-applies-to i18n="appliesRemove, title:appliesRemove" tabindex=0><i class=i-minus></i></a><a class=add-applies-to i18n="appliesAdd, title:appliesAdd" tabindex=0><i class=i-plus></i></a></div></li>'})},5483:(e,o,i)=>{var s=i(1025),l=i(2928),r=i(8976),a=i(6199);const COLORVIEW_CLASS="colorview",COLORVIEW_SWATCH_CLASS=COLORVIEW_CLASS+"-swatch",COLORVIEW_SWATCH_PROP=`--${COLORVIEW_SWATCH_CLASS}`,{RX_COLOR,testAt}=l,RX_UNSUPPORTED=!1;const RX_DETECT=new RegExp('(^|[\\s(){}[\\]:,/"=])('+RX_COLOR.hex.source+"|(?:(?:rgb|hsl)a?|hwb)(?=\\()|(?:"+[...l.NAMED_COLORS.keys()].join("|")+')(?=[\\s;(){}[\\]/"!]|$))',"gi"),RX_DETECT_FUNC=/((rgb|hsl)a?|hwb)\(/iy,RX_COMMENT=/\/\*([^*]+|\*(?!\/))*(\*\/|$)/g,RX_STYLE=/(?:^|\s)(?:atom|keyword|variable callee|builtin)(?:\s|$)/,SPACE1K=" ".repeat(1e3),ALLOWED_STYLES=["atom","keyword","callee","comment","string"];let maxRenderChunkSize=Math.ceil(t.innerHeight/14);const CM_EVENTS={changes(e,info){colorizeChanges(e.state.colorpicker,info)},update(e){const textHeight=e.display.cachedTextHeight,height=e.display.lastWrapHeight;if(!height||!textHeight)return;maxRenderChunkSize=Math.max(20,Math.ceil(height/textHeight));const state=e.state.colorpicker;state.colorizeOnUpdate&&(state.colorizeOnUpdate=!1,colorizeAll(state)),e.off("update",CM_EVENTS.update)},mousedown(e,event){const state=e.state.colorpicker,swatch=hitTest(event);dispatchEvent(new CustomEvent("close-colorpicker-popup",{detail:swatch&&state.popup})),swatch&&(event.preventDefault(),openPopupForSwatch(state,swatch))}},cache=new Set;class ColorSwatch{constructor(e,options={}){this.cm=e,this.options=options,this.markersToRemove=[],this.markersToRepaint=[],this.popup=(0,r.default)(e),this.popup||(delete CM_EVENTS.mousedown,n.head.appendChild(n.createElement("style")).textContent="\n        .colorview-swatch::before {\n          cursor: auto;\n        }\n      "),this.colorize(),this.registerEvents()}colorize(){colorizeAll(this)}openPopup(color){this.popup&&openPopupForCursor(this,color)}registerEvents(){for(const name in CM_EVENTS)this.cm.on(name,CM_EVENTS[name])}unregisterEvents(){for(const name in CM_EVENTS)this.cm.off(name,CM_EVENTS[name])}destroy(){this.unregisterEvents();const{cm:e}=this,{curOp}=e;curOp||e.startOperation(),e.getAllMarks().forEach(e=>e.className===COLORVIEW_CLASS&&e.clear()),curOp||e.endOperation(),e.state.colorpicker=null}}function colorizeAll(state){const{cm:e}=state,{viewFrom,viewTo}=e.display;if(!viewTo)return void(state.colorizeOnUpdate=!0);const{curOp}=e;curOp||e.startOperation(),state.line=viewFrom,state.inComment=null,state.now=performance.now(),state.stopAt=state.stopped=null,e.doc.iter(viewFrom,viewTo,lineHandle=>colorizeLine(state,lineHandle)),updateMarkers(state),curOp||e.endOperation(),(viewFrom>0||viewTo<e.doc.size)&&(clearTimeout(state.colorizeTimer),state.line=0,state.colorizeTimer=setTimeout(colorizeInvisible,100,state,viewFrom,viewTo))}function colorizeInvisible(state,viewFrom,viewTo){const{cm:e}=state,{curOp}=e;curOp||e.startOperation(),state.now=performance.now(),state.stopAt=state.now+50,state.stopped=null,e.eachLine(state.line,viewFrom,lineHandle=>colorizeLine(state,lineHandle)),!state.stopped&&viewTo<e.doc.size&&(state.line=Math.max(viewTo,state.line),e.eachLine(state.line,e.doc.size,lineHandle=>colorizeLine(state,lineHandle))),updateMarkers(state),curOp||e.endOperation(),state.stopped&&(state.colorizeTimer=setTimeout(colorizeInvisible,0,state,viewFrom,viewTo))}function colorizeChanges(state,changes){if(1===changes.length&&"setValue"===changes[0].origin)return void colorizeAll(state);const queue=[],postponed=[],viewFrom=state.cm.display.viewFrom||0,viewTo=state.cm.display.viewTo||viewFrom+maxRenderChunkSize;for(let change of changes){const{from}=change,e=a.CodeMirror.changeEnd(change);from.line>viewTo||e.line<viewFrom?postponed.push(change):(from.line<viewFrom&&(postponed.push(Object.assign({},change,{to:{line:viewFrom-1}})),change=Object.assign({},change,{from:{line:viewFrom}})),e.line>viewTo&&(postponed.push(Object.assign({},change,{from:{line:viewTo+1}})),change=Object.assign({},change,{to:{line:viewTo}})),queue.push(change))}queue.length&&colorizeChangesNow(state,queue),postponed.length&&setTimeout(colorizeChangesNow,0,state,postponed,!0)}function colorizeChangesNow(state,changes,canPostpone){const{cm:e}=state,{curOp}=e;curOp||e.startOperation(),state.now=performance.now();const stopAt=canPostpone&&state.now+50;let change,changeFromLine,stopped=null,changeToLine=-1,queueIndex=-1;const first=(changes=changes.sort((e,t)=>e.from.line-t.from.line||e.from.ch-t.from.ch))[0].from.line,last=a.CodeMirror.changeEnd(changes[changes.length-1]).line;let line=state.line=first;if(e.doc.iter(first,last+1,lineHandle=>{if(line>changeToLine){if(change=changes[++queueIndex],!change)return!0;changeFromLine=change.from.line,changeToLine=a.CodeMirror.changeEnd(change).line}if(changeFromLine<=line&&line<=changeToLine&&(state.line=line,lineHandle.styles||state.cm.getTokenTypeAt({line,ch:0}),colorizeLineViaStyles(state,lineHandle)),canPostpone&&(state.now=performance.now())>stopAt)return stopped=!0,!0;line++}),updateMarkers(state),curOp||e.endOperation(),stopped){line>=changeFromLine&&line<changeToLine?(changes.splice(0,queueIndex),changes[0]=Object.assign({},changes[0],{from:{line}})):changes.splice(0,queueIndex+1),state.colorizeTimer=setTimeout(colorizeChangesNow,0,state,changes,!0)}}function colorizeLine(state,lineHandle){if(state.stopAt&&(state.now=performance.now())>state.stopAt)return state.stopped=!0,!0;const{text,styles}=lineHandle,{cm:e}=state;if(null===state.inComment&&!styles)return e.getTokenTypeAt({line:state.line,ch:0}),void colorizeLineViaStyles(state,lineHandle);if(styles)return void colorizeLineViaStyles(state,lineHandle);let cmtStart=0,cmtEnd=0;do{if(state.inComment){if(cmtEnd=text.indexOf("*/",cmtStart),cmtEnd<0)break;state.inComment=!1,cmtEnd+=2}cmtStart=(text.indexOf("/*",cmtEnd)+1||text.length+1)-1;const chunk=cmtEnd||cmtStart!==text.length?text.slice(cmtEnd,cmtStart):text;RX_DETECT.lastIndex=0;const t=RX_DETECT.exec(chunk);if(t){cmtEnd+=t.index+t[1].length,e.getTokenTypeAt({line:state.line,ch:0});const index=s.getStyleAtPos(lineHandle.styles,cmtEnd,1);return void colorizeLineViaStyles(state,lineHandle,Math.max(1,index||0))}state.inComment=cmtStart<text.length}while(state.inComment);state.line++}function colorizeLineViaStyles(state,lineHandle,styleIndex=1){const{styles}=lineHandle;let span,style,start,end,len,isHex,isFunc,color,{text}=lineHandle,spanIndex=0,uncommented=!1,{markedSpans}=lineHandle,spansSorted=!1,spansZombies=markedSpans&&markedSpans.length;const spanGeneration=state.now,endsWithComment=text.endsWith("*/");for(let e=styleIndex;e+1<styles.length;e+=2){if(style=styles[e+1],!style||!RX_STYLE.test(style))continue;if(start=e>2?styles[e-2]:0,end=styles[e],len=end-start,isHex="#"===text[start],isFunc="("===text[end],isFunc&&(len<3||len>4||!testAt(RX_DETECT_FUNC,start,text)))continue;isFunc&&!uncommented&&(text=blankOutComments(text,start),uncommented=!0),color=text.slice(start,isFunc?text.indexOf(")",end)+1:end);const t=!isHex&&!isFunc&&color.indexOf("!");t>0&&(color=color.slice(0,t),end=start+t);const spanState=markedSpans&&checkSpan();"same"!==spanState&&(checkColor()&&(spanState?redeem:mark)(getSafeColorValue()))}return function(){if(!spansZombies)return;for(const e of markedSpans)e.generation!==spanGeneration&&e.marker.className===COLORVIEW_CLASS&&state.markersToRemove.push(e.marker)}(),state.inComment=style&&style.includes("comment")&&!endsWithComment,void state.line++;function checkColor(){if(isHex)return testAt(RX_COLOR.hex,0,color);if(!isFunc)return l.NAMED_COLORS.has(color.toLowerCase());const colorLower=color.toLowerCase();if(cache.has(colorLower))return!0;const type=color.substr(0,3),value=color.slice(len+1,-1);return!!testAt(RX_COLOR[type],0,value)&&(cache.add(colorLower),!0)}function mark(colorValue){const{line}=state;state.cm.markText({line,ch:start},{line,ch:end},{className:COLORVIEW_CLASS,startStyle:COLORVIEW_SWATCH_CLASS,css:COLORVIEW_SWATCH_PROP+":"+colorValue,color})}function getSafeColorValue(){if(isHex&&5!==color.length&&9!==color.length)return color;if(!RX_UNSUPPORTED||!RX_UNSUPPORTED.test(color))return color;const value=l.parse(color);return l.format(value,"rgb")}function checkSpan(){for(spansSorted||(markedSpans=markedSpans.sort((e,t)=>e.from-t.from),spansSorted=!0);spanIndex<markedSpans.length&&(span=markedSpans[spanIndex],span.from<=start);)if(spanIndex++,span.from===start&&span.marker.className===COLORVIEW_CLASS){spansZombies--,span.generation=spanGeneration;return color===span.marker.color&&(isFunc||/\W|^$/i.test(text.substr(start+color.length,1)))?"same":(state.markersToRemove.push(span.marker),"redeem")}}function redeem(colorValue){spansZombies++,state.markersToRemove.pop(),state.markersToRepaint.push(span),span.to=end,span.line=state.line,span.index=spanIndex-1,span.marker.color=color,span.marker.css=COLORVIEW_SWATCH_PROP+":"+colorValue}}function openPopupForCursor(state,defaultColor){const{line,ch:e}=state.cm.getCursor(),lineHandle=state.cm.getLineHandle(line),data={line,ch:e,color:defaultColor,isShortCut:!0};let found;for(const{from,marker}of lineHandle.markedSpans||[])if(marker.className===COLORVIEW_CLASS&&from<=e&&e<from+marker.color.length){found={color:marker.color,ch:from};break}found=found||findNearestColor(lineHandle,e),doOpenPopup(state,Object.assign(data,found)),found&&highlightColor(state,data)}function openPopupForSwatch(state,swatch){const e=state.cm,lineDiv=swatch.closest("div"),{line:{markedSpans}={}}=e.display.renderedView.find(e=>e.node===lineDiv)||{};if(!markedSpans)return;let swatchIndex=[...lineDiv.getElementsByClassName(COLORVIEW_SWATCH_CLASS)].indexOf(swatch);for(const{marker}of markedSpans.sort((e,t)=>e.from-t.from))if(marker.className===COLORVIEW_CLASS&&0==swatchIndex--){const data=Object.assign({color:marker.color},marker.find().from);highlightColor(state,data),doOpenPopup(state,data);break}}function doOpenPopup(state,data){const{left,bottom:top}=state.cm.charCoords(data,"window");state.popup.show(Object.assign(state.options.popup,data,{top,left,cm:state.cm,color:data.color,prevColor:data.color||"",callback:popupOnChange,palette:makePalette(state),paletteCallback}))}function popupOnChange(newColor){if(!newColor)return;const{cm:e,line,ch:t,embedderCallback}=this,n={line,ch:t+this.prevColor.length},from={line,ch:t};e.getRange(from,n)!==newColor&&(e.replaceRange(newColor,from,n,"*colorpicker"),this.prevColor=newColor),"function"==typeof embedderCallback&&embedderCallback(this)}function makePalette({cm:e,options}){const palette=new Map;let nums,t=0;e.eachLine(({markedSpans})=>{if(++t,markedSpans)for(const{from,marker:e}of markedSpans){if(null==from||e.className!==COLORVIEW_CLASS)continue;const color=e.color.toLowerCase();nums=palette.get(color),nums||palette.set(color,nums=[]),nums.push(t)}});const res=[];if(palette.size>1||nums&&nums.length>1){const old=new Map(options.popup.palette?.map(e=>[e.__color,e]));for(const[color,data]of palette){const str=data.join(", ");let e=old.get(color);e||(e=n.createElement("div"),e.__color=color,e.className=COLORVIEW_SWATCH_CLASS,e.style.setProperty(COLORVIEW_SWATCH_PROP,color)),e.__str!==str&&(e.__str=str,e.title=`${color}\n${options.popup.paletteLine} ${str.length>50?str.replace(/([^,]+,\s){10}/g,"$&\n"):str}`),res.push(e)}res.push(Object.assign(n.createElement("span"),{className:"colorpicker-palette-hint",title:options.popup.paletteHint,textContent:"?"}))}return res}function paletteCallback(e){const{cm:t}=this,lines=e.title.split("\n")[1].match(/\d+/g).map(Number),n=lines.indexOf(t.getCursor().line+1)+1;t.jumpToPos({line:(lines[n]||lines[0])-1,ch:0})}function updateMarkers(state){state.markersToRemove.forEach(e=>e.clear()),state.markersToRemove.length=0;const{cm:{display:{viewFrom,viewTo,view}}}=state;let viewIndex=0,lineView=view[0],lineViewLine=viewFrom;for(const{line,index,marker}of state.markersToRepaint){if(line<viewFrom||line>=viewTo)continue;for(;lineViewLine<line&&lineView;)lineViewLine+=lineView.size,lineView=view[++viewIndex];if(!lineView)break;const e=lineView.text.getElementsByClassName(COLORVIEW_SWATCH_CLASS)[index];e&&(e.style=marker.css)}state.markersToRepaint.length=0}function findNearestColor({styles,text},pos){let start,color,prevStart,prevColor,e;for(RX_DETECT.lastIndex=Math.max(0,pos-1e3);e=RX_DETECT.exec(text);){start=e.index+e[1].length;const token=e[2].toLowerCase(),style=s.getStyleAtPos(styles,start+1,0);if(!style||ALLOWED_STYLES.includes(style.split(" ",1)[0]))if("("===text[start+token.length]){const tail=blankOutComments(text.slice(start),0);color=tail.slice(0,tail.indexOf(")")+1);const type=color.slice(0,3),value=color.slice(token.length+1,-1);color=testAt(RX_COLOR[type],0,value)&&color}else color=("#"===token[0]||l.NAMED_COLORS.has(token))&&token;else color="";if(color){if(start>=pos)break;prevStart=start,prevColor=color}}return prevColor&&pos-(prevStart+prevColor.length)<start-pos?{color:prevColor,ch:prevStart}:color?{color,ch:start}:void 0}function highlightColor(state,data){const{line}=data,{cm:e}=state,{viewFrom,viewTo}=e.display;if(line<viewFrom||line>viewTo)return;const first=e.charCoords(data);let last=e.charCoords({line,ch:data.ch+data.color.length-1});if(last.top!==first.top){const funcEnd=data.ch+data.color.indexOf("(")-1;last=e.charCoords({line,ch:funcEnd})}const t=n.createElement("div");t.style=`\n    position: absolute;\n    display: block;\n    top: ${first.top}px;\n    left: ${first.left}px;\n    width: ${last.right-first.left}px;\n    height: ${last.bottom-first.top}px;\n    animation: highlight 0.5s;\n  `,n.body.appendChild(t),setTimeout(()=>t.remove(),500)}function blankOutComments(text,start){const cmtStart=text.indexOf("/*",start);return cmtStart<0?text:text.slice(0,cmtStart)+text.slice(cmtStart).replace(RX_COMMENT,e=>SPACE1K.repeat(e.length/1e3|0)+SPACE1K.slice(0,e.length%1e3))}function hitTest({button,target,offsetX,offsetY}){if(button)return;const swatch=target.closest("."+COLORVIEW_CLASS);if(!swatch)return;const{left,width,height}=getComputedStyle(swatch,"::before"),bounds=swatch.getBoundingClientRect();return offsetX>=parseFloat(left)-1&&offsetX<=parseFloat(left)+parseFloat(width)+1&&offsetY>=parseFloat(height)/2-bounds.height/2-1&&offsetY<=parseFloat(height)/2+bounds.height/2+1&&swatch}a.CodeMirror.defineOption("colorpicker",!1,(e,value,oldValue)=>{oldValue&&oldValue!==a.CodeMirror.Init&&e.state.colorpicker&&e.state.colorpicker.destroy(),value&&(e.state.colorpicker=new ColorSwatch(e,value))}),o.COLORVIEW_SWATCH_CLASS=COLORVIEW_SWATCH_CLASS,o.COLORVIEW_SWATCH_PROP=COLORVIEW_SWATCH_PROP}},e=>{e.O(0,["common-ui","codemirror","css_global-dark_css-css_global_css-css_spinner_css","js_color_color-picker_js"],()=>e(e.s=9506));e.O()}])}