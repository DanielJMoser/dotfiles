"use strict";{const e=self,t=e,s=e.document;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["edit_lazy-init_js"],{5740:(e,n,o)=>{var util=o(1025),prefs=o(492),js_util=o(6940),src_cm=o(6199),color_converter=o(2928),color_view=o(5483);const MARK=s.createElement("b"),SWATCH=Object.assign(s.createElement("span"),{className:color_view.COLORVIEW_SWATCH_CLASS}),USO_VAR="uso-variable",USO_VALID_VAR="variable-3 "+USO_VAR,USO_INVALID_VAR="error "+USO_VAR,kCompleteSingle="completeSingle",pickedCms=new WeakSet,addSuffix=(obj,suffix)=>(Object.keys(obj).sort().join(suffix+"\n")+suffix).split("\n");class Completion{constructor(e,text,val){this.i=e,this.text=text,this.val=val}hint(e,{from,to:t},{text}){pickedCms.add(e),text===e.getRange(from,t)?e.setCursor(t):e.replaceRange(text,from,t,"complete"),text.endsWith(": ")&&setTimeout(execAutocomplete,0,e)}render(e,{len},{i:t,text,val}){let color,mark;color_converter.NAMED_COLORS.has(val||text)&&(color=SWATCH.cloneNode()).style.setProperty(color_view.COLORVIEW_SWATCH_PROP,val||text),len&&(mark=MARK.cloneNode()).append((val||text).slice(t,t+len)),e.className+=(val?" hint-value":" hint-name")+(t?" hint-start":" hint-inside"),color||mark?e.append(...[val&&text,color,(val||text).slice(0,t),mark,(val||text).slice(t+len)].filter(Boolean)):e.textContent=text+(val||"")}}function autocompleteOnTyping(e,[info],debounced){const lastLine=info.text[info.text.length-1];e.state.completionActive||info.origin&&!info.origin.includes("input")||!lastLine||(pickedCms.has(e)?pickedCms.delete(e):debounced?lastLine.match(/[-a-z!]+$/i)&&execAutocomplete(e):js_util.debounce(autocompleteOnTyping,100,e,[info],!0))}async function execAutocomplete(e){pickedCms.delete(e);const t=e.options.hintOptions,old=t[kCompleteSingle];t[kCompleteSingle]=!1,e.execCommand("autocomplete"),await 0,t[kCompleteSingle]=old}function findAllCssVars(e,leftPart,rightPart=""){const[,prefixed,named]=leftPart.match(/^(--|@)?(\S)?/),t=new RegExp("(?:^|[\\s/;{])("+(prefixed?leftPart:"--")+(named?"":"[a-zA-Z_-￿]")+"[-0-9a-zA-Z_-￿]*)"+rightPart,"g"),list=new Set;return e.eachLine(({text})=>{for(let e;e=t.exec(text);)list.add(e[1])}),[...list].sort()}function getTokenState(e,pos,type){const token=e.getTokenAt(pos,!0);return token.type?token.state.state:type}function isSameToken(text,style,e){return!style||"/"!==text[e]&&"*"!==text[e+1]||!style.startsWith(USO_VALID_VAR)&&!style.startsWith(USO_INVALID_VAR)}function execAt(e,index,text){return e.lastIndex=index,e.exec(text)}function testAt(e,index,text){return e.lastIndex=Math.max(0,index),e.test(text)}var codemirror_factory=o(8544),editor=o(9920),edit_util=o(4849);const rxCmAnyProp=/^(prop(erty)?|variable-2|string-2)\b/,rxCmProp=/prop/,rxCmTopFunc=/^(top|documentTypes|atBlock)/,rxCmVarTagColor=/^(variable|tag|error)/,rxConsume=/([-\w]*\s*:\s?)?/uy,rxCruftAtStart=/^[^\w\s]\s*/,rxFilterable=/(--|[#.\w])\S*\s*$|@/,rxHexColor=/[0-9a-f]+\b|$|\s/iy,rxMaybeProp1=/^(prop(erty|\?)|atom|error|tag)/,rxMaybeProp2=/^(block|atBlock_parens|maybeprop)/,rxNamedColors=/<color>$/,rxNonSpace=/\S/,rxNonWord=/[^-\w]/u,rxNonWordEnd=/[^-\w]$/u,rxPropOrEnd=/^([-a-z]*)(: ?|\()?$/i,rxPropChars=/(\s*[-a-z(]+)?/iy,rxPropEnd=/[\s:()]*/y,rxVar=/(^|[^-.\w\u0080-\uFFFF])var\(/iuy,rxWord=/(?<![-\w]|#[0-9a-f]*)[a-z][-a-z]+/gi,cssMime=src_cm.CodeMirror.mimeModes["text/css"],docFuncs=addSuffix(cssMime.documentTypes,"("),docFuncsStr="\n"+docFuncs.join("\n"),{tokenHooks}=cssMime,originalCommentHook=tokenHooks["/"],originalHelper=src_cm.CodeMirror.hint.css||(()=>{}),AOT_ID="autocompleteOnTyping",AOT_PREF_ID="editor."+AOT_ID,aot=prefs.__values[AOT_PREF_ID];let cssAts,cssColors,cssMedia,cssProps,cssPropsLC,cssPropNames,cssSpecData,prevData,prevMatch,prevLine,prevCh;async function helper(e){const pos=e.getCursor(),{line,ch:t}=pos,{styles,text}=e.getLineHandle(line);let s,end,leftLC,list,prev,prop,state,str,type;if(prevData&&prevLine===line&&prevCh<=t&&prevMatch===text.slice(prevCh-prevMatch.length,prevCh)&&(s=text.slice(prevCh,t).match(rxPropOrEnd))&&(prevMatch+=s[1],!s[2])){prevData.len=prevMatch.length,prevData.to.ch=t;for(let e,arr=prevData.list,t=0,s=0;t<arr.length||s&&!(arr.length=s);t++)e=arr[t],(e.text||e).indexOf(prevMatch)===e.i&&(s<t&&(arr[s]=e),s++);return prevLine=line,prevCh=t,prevData}if(prevData=null,s)prop=prevMatch,prev=end=t,str=leftLC="";else{const[style,styleIndex]=util.getStyleAtPos(styles,t)||[];if(type=style&&style.split(" ",1)[0]||"prop?",!type||"comment"===type||"string"===type)return originalHelper(e);for(s=styleIndex;(null==prev||`${styles[s-1]}`.startsWith(type))&&(prev=s>2?styles[s-2]:0)&&isSameToken(text,style,prev);)s-=2;if("#"===text[prev]&&testAt(rxHexColor,prev+1,text))return;for(s=styleIndex;(null==end||`${styles[s+1]}`.startsWith(type))&&(end=styles[s])&&isSameToken(text,style,end);)s+=2;rxFilterable.lastIndex=prev,prev=Math.max(prev,text.search(rxFilterable)),str=text.slice(prev,end);const left=text.slice(prev,t).trim(),n=(leftLC=left.toLowerCase())[0];"!"===n?list="!important".startsWith(leftLC)?["!important"]:[]:"@"===n?(list=cssAts||(await initCssProps(),cssAts),"less"===e.doc.mode.helperType&&(list=findAllCssVars(e,left,"\\s*:").concat(list))):"."===n||"#"===n?list=!1:"-"===n||"("===n?(list=str.startsWith("--")||testAt(rxVar,t-5,text)?findAllCssVars(e,left):[],str.startsWith("(")?(prev++,leftLC=left.slice(1)):leftLC=left):"/"===n?str.startsWith("/*[[")&&str.endsWith("]]*/")&&(prev+=4,end-=4,end-="-rgb"===text.slice(end-4,end)?4:0,list=Object.keys(editor.default.style.usercssData?.vars||{}).sort(),leftLC=left.slice(4)):"u"!==n&&"d"!==n&&"r"!==n||rxCmVarTagColor.test(type)&&docFuncsStr.includes("\n"+leftLC)&&rxCmTopFunc.test(state??=getTokenState(e,pos,type))&&(end++,list=docFuncs)}if(null==list){if(!prop&&("stylus"===e.doc.mode.name||rxCmProp.test(state??=getTokenState(e,pos,type)))){for(;s>0&&!rxCmAnyProp.test(styles[s+1]);)s-=2;const propEnd=styles[s];if(propEnd>text.lastIndexOf(";",t-1)){for(;s>0&&rxCmAnyProp.test(styles[s+1]);)s-=2;prop=(s<2||styles[s]<t)&&text.slice(styles[s]||0,propEnd).toLowerCase().match(/([-\w]+)?$/u)[1]}}prop&&(rxNonWord.test(leftLC)&&(prev+=execAt(rxPropEnd,prev,text)[0].length,leftLC=leftLC.replace(rxCruftAtStart,"")),prop.startsWith("--")?prop="color":leftLC&&prop.startsWith(leftLC)&&(prop="")),prop&&(cssPropNames||await initCssProps(),list=cssProps[prop+": "],null!==list&&(list=(list.replace(rxNamedColors,cssColors)+cssSpecData.global).split("\n")),end=prev+execAt(rxPropChars,prev,text)[0].length),!list&&rxMaybeProp1.test(type)&&rxMaybeProp2.test(state??=getTokenState(e,pos,type))&&(cssPropNames||await initCssProps(),"prop?"===type&&(prev+=leftLC.length,leftLC=""),list="atBlock_parens"===state?cssMedia:cssPropNames,end-=rxNonWordEnd.test(str),end+=execAt(rxConsume,end,text)[0].length)}if(!list){const simple="stylus"===e.doc.mode.name?src_cm.CodeMirror.hint.fromList(e,{words:src_cm.CodeMirror.hintWords.stylus}):originalHelper(e),word=leftLC?RegExp(js_util.stringAsRegExpStr(leftLC)+"[-a-z]+","gi"):rxWord,any=src_cm.CodeMirror.hint.anyword(e,{word}).list;cssColors||await initCssProps(),list=[...new Set(simple.list.concat(any,cssColors.split("\n")))],list.sort()}const len=leftLC.length,names1=new Map,names2=new Map;for(const e of list)s=leftLC?e.toLowerCase().indexOf(leftLC):0,s>=0&&(s?names2:names1).set(e,new Completion(s,e));if(list=[...names1.values(),...names2.values()],!prop){const values1=new Map,values2=new Map;cssPropNames||await initCssProps();for(const name of cssPropNames){s=0;for(let e,t,n,o=cssPropsLC[name];s>=0&&(!leftLC||(s=o.indexOf(leftLC,s))>=0);s=leftLC?t:t+1||t)e=leftLC?o.lastIndexOf("\n",s)+1:s,t=o.indexOf("\n",s+len),n=cssProps[name].slice(e,t<0?1e9:t),(s===e?values1:values2).set(name+n,new Completion(s-e,name,n))}list.push(...values1.values(),...values2.values())}return prev+=Math.max(0,str.search(rxNonSpace)),prevMatch=text.slice(prev,t),prevLine=line,prevCh=t,prevData={len,list,from:{line,ch:prev},to:{line,ch:end}},prevData}async function initCssProps(){cssSpecData=await edit_util.worker.getCssPropsValues(),cssAts=cssSpecData.ats,cssColors=cssSpecData.colors,cssProps=cssSpecData.all,cssPropsLC={};for(const e in cssProps)cssPropsLC[e]=cssProps[e].toLowerCase();cssPropNames=cssSpecData.keys,cssMedia=[].concat(...Object.entries(cssMime).map(getMediaKeys).filter(Boolean)).sort()}function getMediaKeys([e,t]){return"mediaFeatures"===e&&addSuffix(t,": ")||e.startsWith("media")&&Object.keys(t)}src_cm.CodeMirror.defineOption(AOT_ID,aot,(e,value)=>{e[value?"on":"off"]("changes",autocompleteOnTyping)}),prefs.subscribe(AOT_PREF_ID,(key,val)=>codemirror_factory.default.globalSetOption(AOT_ID,val),aot),src_cm.CodeMirror.registerHelper("hint","css",helper),src_cm.CodeMirror.registerHelper("hint","stylus",helper),tokenHooks["/"]=function(stream){const token=originalCommentHook.apply(this,arguments);if("comment"===token[1]){const{string,start,pos}=stream;if(testAt(/\/\*\[\[/y,start,string)&&testAt(/]]\*\//y,pos-4,string)){const vars=editor.default.style.usercssData?.vars;token[0]=vars&&js_util.hasOwn(vars,string.slice(start+4,pos-4).replace(/-rgb$/,""))?USO_VALID_VAR:USO_INVALID_VAR}}return token};var dom=o(7986),localization=o(7501),msg_api=o(4930),sections_util=o(2013);const makeId=()=>editor.default.style.id||"new";let delay,port;function connectPort(){port=chrome.runtime.connect({name:"draft:"+makeId()}),port.onDisconnect.addListener(()=>port=null)}function updateDraft(isDirty=editor.default.dirty.isDirty()){isDirty&&msg_api.API.draftsDB.put({date:new Date,isUsercss:editor.default.isUsercss,style:editor.default.getValue(!0),si:editor.default.makeScrollInfo()},makeId())}(async function(){const draft=await msg_api.API.draftsDB.get(makeId());if(!draft||draft.isUsercss!==editor.default.isUsercss||editor.default.isSame(draft.style))return;let resolve;const{style}=draft,onYes=()=>resolve(!0),onNo=()=>resolve(!1),value=draft.isUsercss?style.sourceCode:sections_util.styleToCss(style),info=js_util.t("draftTitle",localization.formatRelativeDate(draft.date)),popup=edit_util.showCodeMirrorPopup(info,"",{value,readOnly:!0});popup.className+=" danger",popup.onClose.add(onNo),popup._contents.append(dom.$create("p",js_util.t("draftAction")),dom.$create(".buttons",[js_util.t("confirmYes"),js_util.t("confirmNo")].map((btn,e)=>dom.$create("button",{onclick:e?onNo:onYes},btn)))),await new Promise(e=>resolve=e)?(style.id=editor.default.style.id,await editor.default.replaceStyle(style,draft)):msg_api.API.draftsDB.delete(makeId()).catch(()=>{});edit_util.helpPopup.close()})().then(()=>{editor.default.dirty.onChange(isDirty=>isDirty?!port&&connectPort():port?.disconnect()),editor.default.dirty.onDataChange(isDirty=>js_util.debounce(updateDraft,isDirty?delay:0)),prefs.subscribe("editor.autosaveDraft",(key,val)=>{delay=js_util.clamp(1e3*val|0,1e3,2**32-1);const timer=js_util.debounce.timers.get(updateDraft);timer&&js_util.debounce(updateDraft,timer.delay?delay:0)},!0)}),t.on("beforeunload",e=>{let pos;editor.default.isWindowed&&"visible"===s.visibilityState&&prefs.__values.openEditInWindow&&-32e3!==screenX&&(screenX>0||outerWidth<screen.availWidth||screenY>0||outerHeight<screen.availHeight||screenX<=-10||outerWidth>=screen.availWidth+10||screenY<=-10||outerHeight>=screen.availHeight+10)&&(pos={left:screenX,top:screenY,width:outerWidth,height:outerHeight},prefs.set("windowPosition",pos)),js_util.sessionStore.windowPos=JSON.stringify(pos||{}),msg_api.API.saveScroll(editor.default.style.id,editor.default.makeScrollInfo());const activeElement=s.activeElement;activeElement&&(activeElement.blur(),setTimeout(()=>activeElement.focus())),(editor.default.dirty.isDirty()||[].some.call(s.$$(edit_util.helpPopup.SEL+" .CodeMirror"),e=>!e.CodeMirror.isClean()))&&(e.returnValue=js_util.t("styleChangesNotSaved"))})}}])}