"use strict";{const e=self,t=e,s=e.document,n=s.documentElement,a=n.classList;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["popup_search_js"],{6643:(e,l,i)=>{var dom=i(7986),dom_util=i(3831),localization=i(7501),msg=i(3619),msg_api=i(4930),prefs=i(492),urls=i(8982),util=i(6940),popup=i(8825),events=i(3220);localization.htmlToTemplateCache('<template data-id=searchUI><div id=pct><div i18n=gettingStyles></div></div><div id=search-results-error hidden></div><div id=search-results hidden><div class=search-results-nav data-type=top></div><div id=search-params><div id=search-years><div class=select-wrapper><select></select></div>-\n        <div class=select-wrapper><select></select></div></div><input id=search-query type=search i18n="placeholder:search, title:searchStyleQueryHint"><div class=select-wrapper><select id=search-order i18n=title:sortStylesHelpTitle><option value=n i18n=genericTitle><option value=u i18n=searchResultUpdated><option value=t i18n=searchResultInstallCount><option value=w i18n=searchResultWeeklyCount><option value=r i18n=searchResultRating></select></div><label i18n="+searchGlobalStyles, title:searchGlobalStylesHint"><input id=popup.search.globals type=checkbox></label></div><div id=search-results-list></div><div class=search-results-nav data-type=bottom></div></div></template><template data-id=searchNav><div><button data-type=prev i18n=title:paginationPrevious disabled>◄</button><label><span data-type=page i18n=title:paginationCurrent>-</span>/\n      <span data-type=total i18n=title:paginationEstimated>-</span>(<span data-type=num></span>)\n    </label><button data-type=next i18n=title:paginationNext disabled>►</button></div></template><template data-id=searchResult><div class=search-result><a class=search-result-title><span></span></a><div class=search-result-info><img class=search-result-screenshot i18n=title:installButton loading=lazy><div class=search-result-status></div><div class=search-result-actions><button class=search-result-install i18n=installButton></button><button class=search-result-uninstall i18n=deleteStyleLabel></button><button class=search-result-customize i18n=configureStyle></button></div><dl class=search-result-meta><div data-type=author><dt i18n=author></dt><dd><a target=_blank i18n=title:author></a></dd></div><div data-type=rating><dt i18n=searchResultRating></dt><dd i18n=title:searchResultRating></dd></div><div data-type=updated><dt i18n=searchResultUpdated></dt><dd i18n=title:searchResultUpdated><time></time></dd></div><div data-type=weekly><dt i18n=searchResultWeeklyCount></dt><dd i18n=title:searchResultWeeklyCount></dd></div><div data-type=total><dt i18n=searchResultInstallCount></dt><dd i18n=title:searchResultInstallCount></dd></div></dl></div><div class=search-result-description></div></div></template><template data-id=emptySearchResult><div class=search-result-empty></div></template><template data-id=searchResultNotMatching><p class=not-matching-explainer i18n="searchResultNotMatching, title:searchResultNotMatchingNote"></p></template>'),s.body.append(localization.templateCache.searchUI);const RESULT_TPL=localization.templateCache.searchResult,RESULT_ID_PREFIX=RESULT_TPL.className+"-",RESULT_SEL="."+RESULT_TPL.className,INDEX_URL=urls.usoaRaw[0]+"search-index.json",USW_INDEX_URL=urls.usw+"api/index/uso-format",USW_ICON=dom.$create("img",{src:`${urls.usw}favicon.ico`,title:urls.usw}),STYLUS_CATEGORY="chrome-extension",PAGE_LENGTH=100,USO_AUTO_PIC_SUFFIX="-after.png",GLOBAL="global",search_dom={},r=s.getElementById("popup.search.globals");let results,resultsAllYears,index;popup.tabUrlSupported?(dom_util.setupLivePrefs([r.id]),r.onchange=()=>{searchGlobals=r.checked,ready=ready.then(start)}):r.checked=r.disabled=!0;let rxCategory,ready,indexing,host3="",category="",searchGlobals=!popup.tabUrlSupported||r.checked,query=[],order=prefs.__values["popup.findSort"],scrollToFirstResult=!0,displayedPage=1,totalPages=1,imgType=".jpeg";dom.$create("img",{src:"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=",onload:()=>imgType=".webp"});const o=e=>{const entry=e.closest(RESULT_SEL);return{entry,result:entry&&entry._result}},rid2id=rid=>rid.split("-")[1],eventMap={styleAdded:onStyleInstalled,styleUpdated:onStyleInstalled,styleDeleted:function({style:{id:e}}){const t=results.find(t=>t._styleId===e);t&&(t.f&&msg_api.API.uso.pingback(rid2id(t.i),!1),delete t._styleId,renderActionButtons(t.i))}};popup.styleFinder.on=async(msg,busy)=>{const e=eventMap[msg.method];if(e)return busy&&await busy,e(msg)},popup.styleFinder.inline=()=>{calcCategory(),ready=start()},popup.styleFinder.inSite=event=>{category||calcCategory({retry:1});const add=(prefix,str)=>str?prefix+str:"",where=event.detail,e=encodeURIComponent(s.getElementById("search-query").value.trim()),catQ=category+add("+",e),href="uso"===where&&`${urls.uso}styles/browse${e?`?search_terms=${catQ}`:category===GLOBAL?"":`/${category}`}`||"usoa"===where&&`${urls.usoa}browse/styles?search=%23${catQ}`||"usw"===where&&`${urls.usw}search?q=${catQ}`||"gf"===where&&"https://greasyfork.org/"+(n.lang.split("-")[0]||"en")+`/scripts${popup.tabUrlSupported?util.tryURL(popup.tabUrl).hostname.replace(/^(www\.)?/,"/by-site/"):""}?language=css${add("&q=",e)}`;events.openURLandHide.call({href},event)},s.getElementById("search-query").oninput=function(){query=[];const text=this.value.trim();for(let e,t=/(")(.+?)"|((\/)?(\S+?)(\/\w*)?)(?=\s|$)/g;e=t.exec(text);){const[all,t,s,rawText,rx1="",n,rx2=""]=e;query.push(rx1&&rx2&&util.tryRegExp(n,rx2.slice(1))||util.stringAsRegExp(t?s:rawText,all===all.toLocaleLowerCase()?"i":""))}category===STYLUS_CATEGORY&&query.push(/\bStylus\b/),ready=ready.then(start)},s.getElementById("search-years").onchange=()=>{ready=ready.then(()=>start({keepYears:!0}))},s.getElementById("search-order").value=order,s.getElementById("search-order").onchange=function(){order=this.value,prefs.set("popup.findSort",order),results.sort(comparator),render()},search_dom.list=s.getElementById("search-results-list"),search_dom.container=s.getElementById("search-results"),search_dom.container.dataset.empty="",search_dom.error=s.getElementById("search-results-error"),search_dom.nav={};const navOnClick={prev:function(){displayedPage=Math.max(1,displayedPage-1),scrollToFirstResult=!0,render()},next:function(){displayedPage=Math.min(totalPages,displayedPage+1),scrollToFirstResult=!0,render()}};for(const place of["top","bottom"]){const nav=s.querySelector(`.search-results-nav[data-type="${place}"]`);nav.appendChild(localization.templateCache.searchNav.cloneNode(!0)),search_dom.nav[place]=nav;for(const child of nav.$$("[data-type]")){const type=child.dataset.type;child.onclick=navOnClick[type],nav["_"+type]=child}}async function onStyleInstalled({style}){const e=await msg_api.API.styles.getRemoteInfo(style.id),t=e&&results.find(t=>e[0]===t.i);t&&(t._styleId=style.id,t._styleVars=e[1],renderActionButtons(e[0]))}function error(err){search_dom.error.textContent=err&&err.message||`${err}`,search_dom.error.hidden=!1,search_dom.list.hidden=!0,search_dom.error.getBoundingClientRect().bottom<0&&search_dom.error.scrollIntoView(!0)}function errorIfNoneFound(){if(!results.length&&!s.getElementById("search-query").value)return indexing?indexing.then(errorIfNoneFound):Promise.reject(util.t("searchResultNoneFound"))}async function start({keepYears}={}){try{results=[];for(let retry=0;!results.length&&retry<=2;retry++)results=await search_search({retry});if(results.length){const info=await msg_api.API.styles.getRemoteInfo();for(const e of results)[e._styleId,e._styleVars]=info[e.i]||[]}keepYears||(resultsAllYears=results),renderYears(),render(),search_dom.list.hidden=!results.length,await errorIfNoneFound(),resetUI(),results.length&&doScrollToFirstResult()}catch(e){error(e)}}function resetUI(){a.add("search-results-shown"),search_dom.container.hidden=!1,search_dom.list.hidden=!1,search_dom.error.hidden=!0}function renderYears(){const BASE=new Date(0).getFullYear(),DAYS=365.2425,SAFETY=1/DAYS,years=[];for(const e of resultsAllYears){let t=e._year;t||(t=e.u/31556952+BASE,e._year=t=Math.abs(t%1-1)<=SAFETY?new Date(1e3*e.u).getFullYear():0|t),years[t]=(years[t]||0)+1}const texts=years.reduceRight((res,num,e)=>res.push(`${e} (${num})`)&&res,[]),selects=[...s.querySelectorAll("#search-years select")];selects.forEach((sel,selNum)=>{if(texts.length!==sel.length||texts.some((e,t)=>e!==sel[t].text)){const e=sel.selectedIndex,value=e&&e<sel.length-1&&sel.value;sel.textContent="",sel.append(...texts.map(e=>dom.$create("option",{value:e.split(" ")[0]},e))),sel.value=value||sel[(selNum?"first":"last")+"Child"]?.value}});const[e,t]=selects.map(e=>Number(e.value)).sort();results=e?resultsAllYears.filter(s=>(s=s._year)>=e&&s<=t):resultsAllYears}function render(){totalPages=Math.ceil(results.length/PAGE_LENGTH),displayedPage=Math.min(displayedPage,totalPages)||1;let startAt=(displayedPage-1)*PAGE_LENGTH;const end=displayedPage*PAGE_LENGTH;let plantAt=0,slot=search_dom.list.children[0];for(;plantAt<PAGE_LENGTH&&slot&&slot.id===RESULT_ID_PREFIX+results[startAt]?.i;)slot=slot.nextElementSibling,plantAt++,startAt++;for(;startAt<Math.min(end,results.length);){const entry=createSearchResultNode(results[startAt++]);slot?(search_dom.list.replaceChild(entry,slot),slot=entry.nextElementSibling):search_dom.list.appendChild(entry),plantAt++}const pageLen=end>results.length&&results.length%PAGE_LENGTH||Math.min(results.length,PAGE_LENGTH);for(;search_dom.list.children.length>pageLen;)search_dom.list.lastElementChild.remove();results.length&&"empty"in search_dom.container.dataset&&delete search_dom.container.dataset.empty,scrollToFirstResult&&util.debounce(doScrollToFirstResult);for(const place in search_dom.nav){const nav=search_dom.nav[place];nav._prev.disabled=displayedPage<=1,nav._next.disabled=displayedPage>=totalPages,nav._page.textContent=displayedPage,nav._total.textContent=totalPages,nav._num.textContent=results.length}}function doScrollToFirstResult(){search_dom.container.scrollHeight>2*t.innerHeight&&(scrollToFirstResult=!1,search_dom.container.scrollIntoView(!0))}function createSearchResultNode(result){const entry=RESULT_TPL.cloneNode(!0),{i:rid,n:name,r:rating,u:updateTime,w:weeklyInstalls,t:totalInstalls,ai:authorId,an:author,sa:shotArchived,sn:shot,f:fmt}=entry._result=result,e=rid2id(rid);entry.id=RESULT_ID_PREFIX+rid,Object.assign(entry.$(".search-result-title"),{onclick:events.openURLandHide,href:`${fmt?urls.usoa:urls.usw}style/${e}`}),fmt||entry.$(".search-result-title").prepend(USW_ICON.cloneNode(!0)),entry.$(".search-result-title span").textContent=localization.breakWord(util.clipString(name,300));const elShot=entry.$(".search-result-screenshot");let shotSrc;return fmt?(elShot._src=urls.uso+`auto_style_screenshots/${e}${USO_AUTO_PIC_SUFFIX}`,shotSrc=shot&&!shot.endsWith(USO_AUTO_PIC_SUFFIX)?`${shotArchived?urls.usoaRaw[0]:urls.uso+"style_"}screenshots/${shot}`:elShot._src):shotSrc=/^https?:/i.test(shot)&&shot.replace(/\.\w+$/,imgType),shotSrc?(elShot._entry=entry,elShot.src=shotSrc,elShot.onerror=fixScreenshot):entry.dataset.noImage="",Object.assign(entry.$('[data-type="author"] a'),{textContent:author,title:author,href:fmt?`${urls.usoa}browse/styles?search=%40${authorId}`:`${urls.usw}user/${encodeURIComponent(author)}`,onclick:events.openURLandHide}),entry.$('[data-type="rating"]').dataset.class=rating?rating>=2.5?"good":rating>=1.5?"okay":"bad":"none",entry.$('[data-type="rating"] dd').textContent=rating&&rating.toFixed(1)||"",Object.assign(entry.$('[data-type="updated"] time'),{dateTime:1e3*updateTime,textContent:localization.formatDate(1e3*updateTime)}),entry.$('[data-type="weekly"] dd').textContent=formatNumber(weeklyInstalls),entry.$('[data-type="total"] dd').textContent=formatNumber(totalInstalls),renderActionButtons(entry),entry}function formatNumber(num){return num>1e9?(num/1e9).toFixed(1)+"B":num>1e7?(num/1e6).toFixed(0)+"M":num>1e6?(num/1e6).toFixed(1)+"M":num>1e4?(num/1e3).toFixed(0)+"k":num>1e3?(num/1e3).toFixed(1)+"k":num}function fixScreenshot(){const{_src:e}=this;e&&e!==this.src?(this.src=e,delete this._src):(this.onerror=null,this.removeAttribute("src"),this._entry.dataset.noImage="",renderActionButtons(this._entry))}function renderActionButtons(entry){if("object"!=typeof entry&&(entry=s.getElementById(RESULT_ID_PREFIX+entry)),!entry)return;const result=entry._result,installedId=result._styleId,isInstalled=installedId>0,status=entry.$(".search-result-status").textContent=isInstalled?util.t("clickToUninstall"):null!=entry.dataset.noImage?util.t("installButton"):"",notMatching=isInstalled&&!s.getElementById("style-"+installedId);notMatching!==entry.classList.contains("not-matching")&&(entry.classList.toggle("not-matching"),notMatching?entry.prepend(localization.templateCache.searchResultNotMatching.cloneNode(!0)):entry.firstElementChild.remove()),Object.assign(entry.$(".search-result-screenshot"),{onclick:isInstalled?uninstall:install,title:status?"":util.t("installButton")}),entry.$(".search-result-uninstall").onclick=uninstall,entry.$(".search-result-install").onclick=install,Object.assign(entry.$(".search-result-customize"),{onclick:configure,disabled:notMatching}),dom.$toggleDataset(entry,"installed",isInstalled),dom.$toggleDataset(entry,"customizable",result._styleVars)}function renderFullInfo(entry,style){let{description,vars}=style.usercssData;description=(description||"").replace(/<[^>]*>/g," ").replace(/([^.][.。?!]|[\s,].{50,70})\s+/g,"$1\n").replace(/([\r\n]\s*){3,}/g,"\n\n"),entry.$(".search-result-description").textContent=description,vars=!!vars,entry._result._styleVars=vars,dom.$toggleDataset(entry,"customizable",vars)}function configure(){const styleEntry=s.getElementById("style-"+o(this).result._styleId);events.configure.call(this,{},styleEntry)}async function install(){const{entry,result}=o(this),{f:fmt}=result,e=rid2id(result.i),installButton=entry.$(".search-result-install"),spinner=dom_util.showSpinner(entry);installButton.disabled=!0,entry.style.setProperty("pointer-events","none","important"),delete entry.dataset.error,fmt&&msg_api.API.uso.pingback(e,5e3);const updateUrl=urls.makeUpdateUrl(fmt?"usoa":"usw",e);try{const sourceCode=await(await fetch(updateUrl)).text();renderFullInfo(entry,await msg_api.API.usercss.install({sourceCode,updateUrl}))}catch(e){entry.dataset.error=`${util.t("genericError")}: ${e&&e.message||e}`,entry.scrollIntoView({behavior:"smooth",block:"nearest"})}spinner.remove(),installButton.disabled=!1,entry.style.pointerEvents=""}function uninstall(){const{result}=o(this);msg_api.API.styles.remove(result._styleId)}function calcCategory({retry}={}){const old=category,e=popup.tabUrlSupported&&util.tryURL(popup.tabUrl);if(e?.href)if("file:"===e.protocol)category="file:";else if(e.protocol===location.protocol)category=STYLUS_CATEGORY;else{const parts=e.hostname.replace(/\.(?:com?|org)(\.\w{2,3})$/,"$1").split("."),[tld,main=e.hostname,third,fourth]=parts.reverse(),keepThird=!retry&&(fourth||third&&"www"!==third&&"m"!==third);category=(keepThird&&`${third}.`||"")+main+(1!==retry&&!("com"===tld||"org"===tld&&"userstyles"!==main)||keepThird?`.${tld}`:""),host3||(host3=keepThird&&category)}else category=GLOBAL;return rxCategory=new RegExp(`\\b${util.stringAsRegExpStr(category)}\\b`,"i"),category!==old}async function fetchIndex(){const elNote=s.getElementById("pct").firstChild,jobs=[[INDEX_URL,"uso",json=>json.filter(e=>"uso"===e.f)],[USW_INDEX_URL,"usw",json=>json.data]].map(fetchIndexJob);return indexing=Promise.all(jobs).then(()=>{indexing=null,elNote.style.opacity=0,start()}),await new Promise((resolve,reject)=>{for(const job of jobs)job.then(resolve,reject)}),index}async function fetchIndexJob([url,prefix,transform]){let e=dom.$create("div",{title:url});s.getElementById("pct").append(e),msg.onConnect[prefix]=port=>{port.onMessage.addListener(([done,total])=>{e&&(e.textContent=total?(done/total*100|0)+"%":formatNumber(done)+"...")})};for(let triesLeft=3;triesLeft--;)try{const res=transform(JSON.parse(await msg_api.API.download(url,{port:prefix})));for(const e of res)e.i=`${prefix}-${e.i}`;index=index?index.concat(res):res;break}catch(e){triesLeft?await util.sleep(250):error(e.message)}e=e.style.opacity=0}async function search_search({retry}={}){return!retry||query.length||calcCategory({retry})?(index||await fetchIndex()).filter(isResultMatching).sort(comparator):[]}function isResultMatching(res){const{c:e}=res;let bias;return(bias=e===category||host3&&(e.includes(".")?46===host3.charCodeAt(host3.length-e.length-1)&&host3.endsWith(e):host3.includes(`.${e}.`))&&2+!res.n.includes(host3)||(category===STYLUS_CATEGORY?"stylus"===e:e===GLOBAL&&searchGlobals&&(query.length||rxCategory.test(res.n))))&&query.every(isInHaystack,res)&&(res._bias=bias)}function isInHaystack(e){return e.test(this.n)}function comparator(e,t){return e._bias-t._bias||("n"===order?e.n<t.n?-1:e.n>t.n:t[order]-e[order])||t.t-e.t}}}])}