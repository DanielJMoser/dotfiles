"use strict";{const e=self,t=e.document,n=t.documentElement;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["edit_global-search_js"],{1461:(e,t,n)=>{n.r(t)},4161:(e,a,o)=>{var color_mimicry=o(8872),dom=o(7986),dom_util=o(3831),localization=o(7501),storage_util=o(5880),util=o(6940),src_cm=o(6199),editor=o(9920);localization.htmlToTemplateCache('<template data-id=searchReplaceDialog><div id=search-replace-dialog><div data-type=main><div data-type=content></div><div data-type=actions><a data-action=case i18n=title:searchCaseSensitive tabindex=0>Aa</a><a data-action=prev i18n=title:genericPrevious data-hotkey-tooltip=findPrev tabindex=0 style=width:20px><i class=i-v style="transform:rotate(180deg); position: absolute; transform-origin:10px 5px;"></i></a><a data-action=next i18n=title:genericNext data-hotkey-tooltip=findNext tabindex=0><i class=i-v></i></a><a data-action=close i18n=title:confirmClose data-hotkey-tooltip="=Esc" tabindex=0><i class=i-close></i></a></div></div><div data-type=status><div class=CodeMirror-search-hint i18n-text=searchRegexp></div><div data-type=tally i18n=title:searchNumberOfResults></div></div></div></template><template data-id=clearSearch><div data-type=hover i18n=title:confirmDelete><i class=i-close data-action=clear></i></div></template><template data-id=find><div data-type=content><div data-type=input-wrapper><textarea class=CodeMirror-search-field rows=1 spellcheck=false required\n                i18n=placeholder:search></textarea></div></div></template><template data-id=replace><div data-type=content><div data-type=input-wrapper><textarea data-type=replace-from i18n=placeholder:replace class=CodeMirror-search-field rows=1 required\n                spellcheck=false></textarea></div><div data-type=input-wrapper><textarea data-type=replace-to i18n=placeholder:replaceWith class=CodeMirror-search-field rows=1 required\n                spellcheck=false></textarea></div><button data-action=replace i18n=replace disabled></button><button data-action=replaceAll i18n=replaceAll disabled></button><button data-action=undo i18n=undo disabled></button><button class=hidden data-action=replace i18n=title:replace disabled><i class=i-check1></i></button><button class=hidden data-action=replaceAll i18n=title:replaceAll disabled><i class=i-check2></i></button><button class=hidden data-action=undo i18n=title:undo disabled><i class=i-undo></i></button></div></template>');const ANNOTATE_SCROLLBAR_OPTIONS={maxMatches:1e4},DLG_STYLE_ID="search-replace-dialog-style",TARGET_CLASS="search-target-editor",MATCH_CLASS="search-target-match",APPLIES_VALUE_CLASS="applies-value",RX_MAYBE_REGEXP=/^\s*\/(.+?)\/([simguy]*)\s*$/;let stateRX,stateRX2,stateLastReplace,stateActiveAppliesTo,stateCm,stateCmStart,stateCursorOptions,stateDialog,stateEditors,stateInput2,stateInput,stateMarker,stateOriginalFocus,stateReplaceHasRefs,stateReplaceValue,stateScrollX,stateScrollY,stateTally,stateFirstRun=!0,stateFind="",stateIcase=!0,stateReverse=!1,stateLastFind="",stateNumFound=0,stateNumApplies=-1,stateReplace="";const stateUndoHistory=[],stateSearchInApplies=!editor.default.isUsercss,ACTIONS={key:{Enter:()=>{switch(t.activeElement){case stateInput:case stateInput2:"find"===stateDialog.dataset.type?doSearch({reverse:!1}):doReplace()}},Esc:()=>{destroyDialog({restoreFocus:!0})}},click:{next:()=>doSearch({reverse:!1}),prev:()=>doSearch({reverse:!0}),close:()=>destroyDialog({restoreFocus:!0}),replace:()=>doReplace(),replaceAll:()=>doReplaceAll(),undo:()=>doUndo(),clear(){dom_util.setInputValue(this._input,"")},case(){stateIcase=!stateIcase,stateLastFind="",dom.$toggleDataset(this,"enabled",!stateIcase),doSearch({canAdvance:!1})}}},EVENTS={oninput(){stateFind=stateInput.value,util.debounce(doSearch,0,{canAdvance:!1}),stateFind||enableReplaceButtons(!1)},onkeydown(event){const action=ACTIONS.key[src_cm.CodeMirror.keyName(event)];action&&!1!==action(event)&&event.preventDefault()},onclick(event){const e=event.target.closest("[data-action]"),action=e&&ACTIONS.click[e.dataset.action];action&&!1!==action.call(e,event)&&event.preventDefault()},onfocusout(){stateDialog.contains(t.activeElement)||(stateDialog.on("focusin",EVENTS.onfocusin),stateDialog.off("focusout",EVENTS.onfocusout))},onfocusin(){stateDialog.on("focusout",EVENTS.onfocusout),stateDialog.off("focusin",EVENTS.onfocusin),trimUndoHistory(),enableUndoButton(stateUndoHistory.length),stateFind&&doSearch({canAdvance:!1})}},DIALOG_PROPS={onclick:EVENTS.onclick,onkeydown:EVENTS.onkeydown},INPUT_PROPS={oninput:EVENTS.oninput},INPUT2_PROPS={oninput(){stateReplace=this.value,util.debounce(writeStorage,500)}},COMMANDS={find(e,{reverse=!1}={}){stateReverse=reverse,focusDialog("find",e)},findNext:e=>doSearch({reverse:!1,cm:e}),findPrev:e=>doSearch({reverse:!0,cm:e}),replace(e){stateReverse=!1,focusDialog("replace",e)}};function initState({initReplace}={}){const text=stateFind;if(text!==stateLastFind){stateNumFound=0,stateNumApplies=-1,stateLastFind=text;const match=text&&text.match(RX_MAYBE_REGEXP),unicodeFlag="unicode"in RegExp.prototype?"u":"",string2regexpFlags=(stateIcase?"gi":"g")+unicodeFlag;stateRX=match&&util.tryRegExp(match[1],"g"+match[2].replace(/[guy]/g,"")+unicodeFlag)||text&&(stateIcase||text.includes("\n"))&&util.stringAsRegExp(text,string2regexpFlags),stateRX2=stateRX||text&&util.stringAsRegExp(text,string2regexpFlags),stateCursorOptions={caseFold:!stateRX&&stateIcase,multiline:!0},util.debounce(writeStorage,500)}initReplace&&stateReplace!==stateLastReplace&&(stateLastReplace=stateReplace,stateReplaceValue=stateReplace.replace(/(\\r)?\\n/g,"\n").replace(/\\t/g,"\t"),stateReplaceHasRefs=/\$[$&`'\d]/.test(stateReplaceValue));const cmFocused=t.activeElement&&t.activeElement.closest(".CodeMirror");stateActiveAppliesTo=t.querySelector(`.${APPLIES_VALUE_CLASS}:focus, .${APPLIES_VALUE_CLASS}.${TARGET_CLASS}`),stateCmStart=editor.default.closestVisible(cmFocused&&t.activeElement||stateActiveAppliesTo||stateCm);const cmExtra=t.querySelector("body > :not(#sections) .CodeMirror");stateEditors=cmExtra?[cmExtra.CodeMirror]:editor.default.getEditors()}function doSearch({reverse=stateReverse,canAdvance=!0,inApplies=!0,cm:e}={}){if(e&&setActiveEditor(e),stateReverse=reverse,!stateFind&&!dialogShown())return void focusDialog("find",stateCm);initState();const cmStart=stateCmStart,{index,found,foundInCode}=stateFind&&doSearchInEditors({cmStart,canAdvance,inApplies})||{};foundInCode||clearMarker(),found||makeTargetVisible(null);const radiateFrom=foundInCode?index:stateEditors.indexOf(cmStart);if(setupOverlay(radiateArray(stateEditors,radiateFrom)),enableReplaceButtons(foundInCode),stateFind){util.debounce(showTally,0,foundInCode&&!stateNumFound?1:void 0)}else showTally(0,0);return stateFirstRun=!1,found}function doSearchInEditors({cmStart,canAdvance,inApplies}){const query=stateRX||stateFind,reverse=stateReverse,BOF={line:0,ch:0},EOF=getEOF(cmStart),start=stateEditors.indexOf(cmStart),total=stateEditors.length;let pos,index,e,t=0,wrapAround=0;if(inApplies&&stateActiveAppliesTo){if(doSearchInApplies(stateCmStart,canAdvance))return{found:!0};reverse?pos=EOF:t++}else pos=getContinuationPos({cm:cmStart,reverse:!canAdvance||reverse}),wrapAround=reverse?src_cm.CodeMirror.cmpPos(pos,EOF)<0:src_cm.CodeMirror.cmpPos(pos,BOF)>0;for(;t<total+wrapAround;t++){index=(start+t*(reverse?-1:1)+total)%total,e=stateEditors[index],t&&(pos=reverse?{line:e.doc.size,ch:0}:BOF);const cursor=e.getSearchCursor(query,pos,stateCursorOptions);if(cursor.find(reverse))return makeMatchVisible(e,cursor),{found:!0,foundInCode:!0,index};if(inApplies&&doSearchInApplies(reverse?stateEditors[index?index-1:total-1]:e))return{found:!0}}}function doSearchInApplies(e,canAdvance){if(!stateSearchInApplies)return;const inputs=editor.default.getSearchableInputs(e);stateReverse&&inputs.reverse(),inputs.splice(0,inputs.indexOf(stateActiveAppliesTo));for(const input of inputs){const value=input.value;stateRX2.lastIndex=input===stateActiveAppliesTo?input.selectionStart+canAdvance:0;const match=stateRX2.exec(value);if(!match)continue;const end=match.index+match[0].length;setTimeout(()=>{input.setSelectionRange(end,end),input.setSelectionRange(match.index,end)});const canFocus=!stateDialog||!stateDialog.contains(t.activeElement);return makeTargetVisible(!canFocus&&input),editor.default.scrollToEditor(e),canFocus&&input.focus(),stateCm=e,clearMarker(),!0}}function doReplace(){initState({initReplace:!0});const e=stateCmStart,generation=e.changeGeneration(),cursor=doReplaceInEditor({cm:e,pos:getContinuationPos({cm:e,reverse:!0})});cursor&&(cursor.findNext()?(clearMarker(),makeMatchVisible(e,cursor)):doSearchInEditors({cmStart:getNextEditor(e)}),getStateSafe(e).unclosedOp=!1,e.curOp&&e.endOperation(),cursor&&(stateUndoHistory.push([[e,generation]]),enableUndoButton(!0)))}function doReplaceAll(){initState({initReplace:!0}),clearMarker();const generations=new Map(stateEditors.map(e=>[e,e.changeGeneration()])),found=stateEditors.filter(e=>doReplaceInEditor({cm:e,all:!0}));found.length&&(stateLastFind=null,stateUndoHistory.push(found.map(e=>[e,generations.get(e)])),enableUndoButton(!0),doSearch({canAdvance:!1}))}function doReplaceInEditor({cm:e,pos,all=!1}){const cursor=e.getSearchCursor(stateRX||stateFind,pos,stateCursorOptions),replace=stateReplaceValue;let found;for(cursor.find();cursor.atOccurrence;){if(found=!0,e.curOp||(e.startOperation(),getStateSafe(e).unclosedOp=!0),stateRX){const text=e.getRange(cursor.pos.from,cursor.pos.to);cursor.replace(stateReplaceHasRefs?text.replace(stateRX,replace):replace)}else cursor.replace(replace);if(!all)return makeMatchVisible(e,cursor),cursor;cursor.findNext()}return all&&(getStateSafe(e).searchPos=null),found}function doUndo(){let undoneSome;saveWindowScrollPos();for(const[e,generation]of stateUndoHistory.pop()||[])t.body.contains(e.display.wrapper)&&!e.isClean(generation)&&(e.undo(),e.getAllMarks().forEach(marker=>marker!==stateMarker&&marker.className===MATCH_CLASS&&marker.clear()),undoneSome=!0);enableUndoButton(stateUndoHistory.length),stateUndoHistory.length?focusUndoButton():stateInput.focus(),undoneSome&&(stateLastFind=null,restoreWindowScrollPos(),doSearch({reverse:!1,canAdvance:!1,inApplies:!1}))}function setupOverlay(queue,debounced){if(!queue.length)return;if((queue.length>1||!debounced)&&(util.debounce(setupOverlay,0,queue,!0),!debounced))return;let canContinue=!0;for(;queue.length&&canContinue;){const e=queue.shift();if(!t.body.contains(e.display.wrapper))continue;const cmState=getStateSafe(e),query=stateRX2;if(cmState.overlay?.query===query){cmState.unclosedOp&&e.curOp&&e.endOperation(),cmState.unclosedOp=!1;continue}cmState.overlay&&(e.curOp||e.startOperation(),e.removeOverlay(cmState.overlay),cmState.overlay=null,canContinue=!1);const hasMatches=query&&e.getSearchCursor(query,null,stateCursorOptions).find();hasMatches&&(e.curOp||e.startOperation(),cmState.overlay={query,token:tokenize,numFound:0,tallyShownTime:0},e.addOverlay(cmState.overlay),canContinue=!1),cmState.annotate&&(e.curOp||e.startOperation(),cmState.annotate.clear(),cmState.annotate=null,canContinue=!1),cmState.annotateTimer&&(clearTimeout(cmState.annotateTimer),cmState.annotateTimer=0),hasMatches&&(cmState.annotateTimer=setTimeout(annotateScrollbar,350,e,query,stateIcase)),cmState.unclosedOp=!1,e.curOp&&e.endOperation()}queue.length||util.debounce.unregister(setupOverlay)}function tokenize(stream){this.query.lastIndex=stream.pos;const match=this.query.exec(stream.string);if(match&&match.index===stream.pos){this.numFound++;const now=performance.now();return now-this.tallyShownTime>10&&(this.tallyShownTime=now,util.debounce(showTally)),stream.pos+=match[0].length||1,"searching"}match?stream.pos=match.index:stream.skipToEnd()}function annotateScrollbar(e,query,icase){getStateSafe(e).annotate=e.showMatchesOnScrollbar(query,icase,ANNOTATE_SCROLLBAR_OPTIONS),util.debounce(showTally)}async function focusDialog(type,e){await Promise.resolve().then(o.bind(o,1461)),setActiveEditor(e);let sel=stateDialog&&stateDialog.contains(t.activeElement)?"":getSelection().toString()||e&&e.getSelection();sel=!sel.includes("\n")&&!sel.includes("\r")&&sel,sel&&(stateFind=sel),dialogShown(type)?sel&&dom_util.setInputValue(stateInput,sel):(destroyDialog(),createDialog(type),"0"===stateTally.textContent&&(stateTally.textContent="")),stateInput.focus(),stateInput.select(),stateFind&&doSearch({canAdvance:!1})}function dialogShown(type){return t.body.contains(stateInput)&&(!type||stateDialog.dataset.type===type)}function createDialog(type){stateOriginalFocus=t.activeElement,stateFirstRun=!0;const dialog=stateDialog=localization.templateCache.searchReplaceDialog.cloneNode(!0);Object.assign(dialog,DIALOG_PROPS),dialog.on("focusout",EVENTS.onfocusout),dialog.dataset.type=type,dialog.style.pointerEvents="auto";const content=dialog.$('[data-type="content"]');content.parentNode.replaceChild(localization.templateCache[type].cloneNode(!0),content),stateInput=createInput(0,INPUT_PROPS,stateFind),stateInput2=createInput(1,INPUT2_PROPS,stateReplace),dom.$toggleDataset(dialog.$('[data-action="case"]'),"enabled",!stateIcase),stateTally=dialog.$('[data-type="tally"]');const colors={body:(0,color_mimicry.default)(t.body,{bg:"backgroundColor"}),input:(0,color_mimicry.default)(t.querySelector("input:not(:disabled)"),{bg:"backgroundColor"}),icon:(0,color_mimicry.default)(t.querySelectorAll("i.i-info")[1])};return n.appendChild(t.getElementById(DLG_STYLE_ID)||dom.$create("style#"+DLG_STYLE_ID)).textContent=`\n    #search-replace-dialog {\n      background-color: ${colors.body.bg};\n    }\n    #search-replace-dialog textarea {\n      color: ${colors.body.fore};\n      background-color: ${colors.input.bg};\n    }\n    #search-replace-dialog i {\n      color: ${colors.icon.fore};\n    }\n    #search-replace-dialog [data-action="case"] {\n      color: ${colors.icon.fore};\n    }\n    #search-replace-dialog[data-type="replace"] button:hover i,\n    #search-replace-dialog i:hover {\n      color: var(--cmin);\n    }\n    #search-replace-dialog [data-action="case"]:hover {\n      color: var(--cmin);\n    }\n    #search-replace-dialog [data-action="clear"] {\n      background-color: ${colors.input.bg.replace(/[^,]+$/,"")+".75)"};\n    }\n  `,t.body.appendChild(dialog),dispatchEvent(new Event("showHotkeyInTooltip")),"replace"===type&&(enableReplaceButtons(""!==stateFind),enableUndoButton(stateUndoHistory.length)),dialog}function createInput(index,props,value){const input=stateDialog.$$("textarea")[index];if(input)return input.value=value,Object.assign(input,props),input.parentElement.appendChild(localization.templateCache.clearSearch.cloneNode(!0)),input.parentElement.$("[data-action]")._input=input,input}function destroyDialog({restoreFocus=!1}={}){stateInput=null,t.getElementById("search-replace-dialog")?.remove(),util.debounce.unregister(doSearch),makeTargetVisible(null),restoreFocus?setTimeout(focusNoScroll,0,stateOriginalFocus):(saveWindowScrollPos(),restoreWindowScrollPos({immediately:!1}))}function enableReplaceButtons(enabled){if(stateDialog&&"replace"===stateDialog.dataset.type)for(const e of stateDialog.$$('[data-action^="replace"]'))e.disabled=!enabled}function enableUndoButton(enabled){if(stateDialog&&"replace"===stateDialog.dataset.type)for(const e of stateDialog.$$('[data-action="undo"]'))e.disabled=!enabled}function focusUndoButton(){for(const btn of stateDialog.$$('[data-action="undo"]'))if("none"!==getComputedStyle(btn).display){btn.focus();break}}function getStateSafe(e){return e.stateSearch||(e.stateSearch={})}function getContinuationPos({cm:e,reverse}){const cmSearchState=getStateSafe(e),posType=reverse?"from":"to",searchPos=cmSearchState.searchPos?.[posType],cursorPos=e.getCursor(posType);return!searchPos||src_cm.CodeMirror.cmpPos(cursorPos,cmSearchState.cursorPos[posType])?cursorPos:searchPos}function getEOF(e){const line=e.doc.size-1;return{line,ch:e.getLine(line).length}}function getNextEditor(e,step=1){const editors=stateEditors;return editors[(editors.indexOf(e)+step+editors.length)%editors.length]}function setActiveEditor(e){e.display.wrapper.contains(t.activeElement)&&(stateCm=e,stateOriginalFocus=e)}function makeTargetVisible(element){const old=t.querySelector("."+TARGET_CLASS);old!==element&&(old&&(old.classList.remove(TARGET_CLASS),t.body.classList.remove("find-open")),element&&(element.classList.add(TARGET_CLASS),t.body.classList.add("find-open")))}function makeMatchVisible(e,searchCursor){const canFocus=!(stateFirstRun||stateDialog&&stateDialog.contains(t.activeElement));stateCm=e;const pos=searchCursor.pos;Object.assign(getStateSafe(e),{cursorPos:{from:e.getCursor("from"),to:e.getCursor("to")},searchPos:pos,unclosedOp:!e.curOp}),e.curOp||e.startOperation(),stateFirstRun||e.jumpToPos(pos.from,pos.to),clearMarker(),canFocus?(e.focus(),makeTargetVisible(null)):(makeTargetVisible(e.display.wrapper),stateMarker=e.stateSearch.marker=e.markText(pos.from,pos.to,{className:MATCH_CLASS,clearOnEnter:!0}))}function clearMarker(){stateMarker&&stateMarker.clear()}function showTally(num,numApplies){if(!stateTally)return;if(void 0===num){num=0;for(const e of stateEditors){const{annotate,overlay}=getStateSafe(e);num+=annotate?.matches?.length||overlay?.numFound||0}stateNumFound=num}if(void 0===numApplies&&stateSearchInApplies&&stateNumApplies<0){numApplies=0;const elements=stateFind?t.getElementsByClassName(APPLIES_VALUE_CLASS):[];for(const e of elements){const value=e.value;if(stateRX){stateRX.lastIndex=0;for(let e;(e=stateRX.exec(value))&&++numApplies&&stateRX.lastIndex>e.index;);}else{let e=-1;for(;(e=value.indexOf(stateFind,e+1))>=0;)numApplies++}}stateNumApplies=numApplies}else numApplies=stateNumApplies;const newText=num+(numApplies>0?"+"+numApplies:"");if(stateTally.textContent!==newText){stateTally.textContent=newText;const newTitle=util.t("searchNumberOfResults"+(numApplies?"2":""));stateTally.title!==newTitle&&(stateTally.title=newTitle)}}function trimUndoHistory(){const history=stateUndoHistory;for(let last;last=history[history.length-1];){const undoables=last.filter(([e,generation])=>t.body.contains(e.display.wrapper)&&!e.isClean(generation));if(undoables.length){history[history.length-1]=undoables;break}history.length--}}function focusNoScroll(e){e&&(saveWindowScrollPos(),e.focus({preventScroll:!0}),restoreWindowScrollPos({immediately:!1}))}function saveWindowScrollPos(){stateScrollX=scrollX,stateScrollY=scrollY}function restoreWindowScrollPos({immediately=!0}={}){immediately?scrollX===stateScrollX&&scrollY===stateScrollY||scrollTo(stateScrollX,stateScrollY):Promise.resolve().then(restoreWindowScrollPos)}function radiateArray(arr,focalIndex){const focus=arr[focalIndex];if(!focus)return arr;const result=[focus],len=arr.length;for(let e=1;e<len;e++)focalIndex+e<len&&result.push(arr[focalIndex+e]),focalIndex-e>=0&&result.push(arr[focalIndex-e]);return result}function writeStorage(){storage_util.chromeLocal.getValue("editor").then((val={})=>{val.find=stateFind,val.replace=stateReplace,val.icase=stateIcase,storage_util.chromeLocal.set({editor:val})})}COMMANDS.replaceAll=COMMANDS.replace,Object.assign(src_cm.CodeMirror.commands,COMMANDS),storage_util.chromeLocal.getValue("editor").then((val={})=>{stateFind=val.find||"",stateReplace=val.replace||"",stateIcase=val.icase||stateIcase})}}])}