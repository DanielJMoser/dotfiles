"use strict";{const e=self;(()=>{var t={945:(e,exports)=>{function percentToByte(e){return String.fromCharCode(parseInt(e.slice(1),16))}function byteToPercent(e){return`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`}exports.encode=function(str){return btoa(encodeURIComponent(str).replace(/%[0-9A-F]{2}/g,percentToByte))}},499:()=>{e.API={}},458:()=>{e.browser=chrome}},n={};function s(e){var r=n[e];if(void 0!==r)return r.exports;var module=n[e]={exports:{}};return t[e](module,module.exports,s),module.exports}s.d=(exports,e)=>{for(var key in e)s.o(e,key)&&!s.o(exports,key)&&Object.defineProperty(exports,key,{enumerable:!0,get:e[key]})},s.o=(obj,e)=>Object.prototype.hasOwnProperty.call(obj,e),s.r=exports=>Object.defineProperties(exports,{[Symbol.toStringTag]:{value:"Module"},__esModule:{value:!0}}),(()=>{var t={};s.r(t),s.d(t,{build:()=>To,buildCode:()=>_o,buildMeta:()=>Do,configVars:()=>$o,editSave:()=>Oo,find:()=>Ao,getInstallCode:()=>mo,getVersion:()=>jo,install:()=>Ro,kUrlInstaller:()=>ho,parse:()=>Po,toggleUrlInstaller:()=>go});var n={};s.r(n),s.d(n,{getDriveOptions:()=>ei,getStatus:()=>Ga,getToken:()=>Ta,login:()=>Qa,putDoc:()=>Ya,remove:()=>Ka,setDriveOptions:()=>Za,start:()=>ti,stop:()=>ni,syncNow:()=>si});var r={};s.r(r),s.d(r,{publish:()=>bi,revoke:()=>vi});var o={};s.r(o),s.d(o,{config:()=>ji,editSave:()=>Ri,find:()=>Pi,get:()=>aa,getAll:()=>Ui,getAllOrdered:()=>Ci,getByUrl:()=>Li,getCore:()=>Ni,getOrder:()=>Mi,getRemoteInfo:()=>qi,getSectionsByUrl:()=>Wi,importMany:()=>Fi,install:()=>Bi,preview:()=>Hi,remove:()=>Vi,save:()=>zi,searchDb:()=>_i,setOrder:()=>Ji,toggle:()=>Xi,toggleOverride:()=>Ki});var a={};s.r(a),s.d(a,{deleteStyle:()=>Ec,getEmbeddedMeta:()=>Tc,getUpdatability:()=>_c,pingback:()=>Dc,toUsercss:()=>$c});var i={};s.r(i),s.d(i,{checkAllStyles:()=>Gc,checkStyle:()=>Qc,getStates:()=>Mc});s(499);const c=/(R)eceiving end does not exist|The message (port|channel) closed|moved into back\/forward cache/,API=e.API;const l=e=>e.split("/",3)[2],u=Object.call.bind({}.hasOwnProperty),d=e=>new Promise(e>0?t=>setTimeout(t,e):setTimeout),f=e=>e.replace(/[{}()[\]\\.+*?^$|]/g,"\\$&"),p=(e,t)=>new RegExp(f(e),t),h=/\/\*!?\s*==userstyle==[\s\S]*?==\/userstyle==\s*\*\//i,m=new Map,w=(key,e,strict=!0)=>{const t=!e&&m.get(key)||chrome.i18n.getMessage(key,e);if(!t&&strict)throw`Missing string "${key}"`;return e||m.set(key,t),t},g=(()=>{const e=new Map,t=e=>clearTimeout(e.timer),n=async(t,args)=>{e.delete(t),t(...args)};return Object.assign((s,r,...args)=>{let o;r=+r||0;let a=e.get(s);if(a){if(r&&a.time<(o=performance.now()+r))t(a);else if(a.args.length===args.length&&a.args.every((e,t)=>e===args[t]))return}else e.set(s,a={});a.args=args,a.time=r&&(o??performance.now()+r),a.timer=setTimeout(n,r,s,args)},{timers:e,run:n,unregister:n=>{const s=e.get(n);s&&(t(s),e.delete(n))}})})();function y(obj){if(!0===obj||null==obj)return 4;if(!1===obj)return 5;let e=typeof obj;if("string"===e)return obj.length+2;if("number"===e)return(e=obj)>=0&&e<10?1:Math.ceil(Math.log10(e<0?-e:e));if("object"!==e)return`${obj}`.length;let t=1;if(Array.isArray(obj))for(e of obj)t+=y(e)+1;else for(const e in obj)t+=e.length+3+y(obj[e])+1;return t}function b(obj){if(obj)for(const e in obj)if(u(obj,e))return!1;return!0}function v(obj,e,t){if(!obj)return obj;const res={};for(const n of t||Object.keys(obj))t&&!(n in obj)||(res[n]=e?e(obj[n],n,obj):obj[n]);return res}function k(e,t){try{return new RegExp(e,t)}catch{}}function x(e){try{if(e)return JSON.parse(e)}catch{}}function S(e){try{if(e)return new URL(e)}catch{}return""}function I(src,e,t){if(!src||"object"!=typeof src)return src;if(Array.isArray(src))if(e&&t)for(const t of src)e.push(I(t));else e=Array.prototype.map.call(src,E);else{e||(e={});for(const[t,n]of Object.entries(src))e[t]=I(n,e[t])}return e}function E(src){return I(src)}function T(e,t,n){if(!e||!t||e===t)return e===t;const s=typeof e;if(s!==typeof t)return!1;if("object"!==s)return e===t;if(Array.isArray(e))return Array.isArray(t)&&e.length===t.length&&e.every((e,s)=>T(e,t[s],n));for(const key in e)if(!(!u(e,key)||n&&n.includes(key))){if(!u(t,key))return!1;if(!T(e[key],t[key],n))return!1}for(const key in t)if(!(!u(t,key)||n&&n.includes(key)||u(e,key)))return!1;return!0}async function _(e,opts){return(await fetch(e,opts)).text()}s(458);const D=navigator.userAgentData,$=D||navigator.userAgent,O=D?D.brands.map(e=>`${e.brand}/${e.version}`).join(" "):$,A=D?D.platform:$,j=+O.match(/Chrom\w*\/(\d+)|$/)[1],R=j,P=j?NaN:+O.match(/Firefox\w*\/(\d+)|$/)[1],U=(O.match(/(Opera|OPR)\w*\/(\d+)|$/),D?D.mobile:/Android/.test($)),M=/Windows/.test(A),C=(O.match(/Vivaldi\w*\/(\d+)|$/),chrome.runtime.getURL("")),L=C+"popup.html",N="install-usercss.html",q="/js/worker.js",W=/^(https:\/\/)(?:update\.)?((?:greasy|sleazy)fork\.org\/scripts\/)(\d+)[^/]*\/code\/[^/]*\.user\.css$|$/,F="https://userstyles.org/",B="https://gateway.userstyles.org/styles/getStyle",H="https://userstyles.org/styles/chrome/",V=["https://cdn.jsdelivr.net/gh/uso-archive/data@flomaster/data/","https://raw.githubusercontent.com/uso-archive/data/flomaster/data/","https://cdn.jsdelivr.net/gh/33kk/uso-archive@flomaster/data/","https://raw.githubusercontent.com/33kk/uso-archive/flomaster/data/"],z="https://userstyles.world/",J=e=>e&&V.some(t=>e.startsWith(t))&&+e.match(/\/(\d+)\.user\.css|$/)[1],X=e=>e&&e.startsWith(z)&&+e.match(/\/(\d+)\.user\.css|$/)[1],K=(e,t)=>"usoa"===e||!t&&(t=J(e))?`https://uso.kkx.one/style/${t}`:"usw"===e||!t&&(t=X(e))?`${z}style/${t}`:"gf"===e||!t&&(t=W.exec(e))?t[1]+t[2]+t[3]:"",G=(e,t)=>"usoa"===e||!t&&(t=J(e))?`${V[0]}usercss/${t}.user.css`:"usw"===e||!t&&(t=X(e))?`${z}api/style/${t}.user.css`:"",Q=RegExp.prototype.test,Y=Q.bind(new RegExp(`^(?:(?:ht|f)tps?:|file:|${C})`)),Z=Q.bind(/^file:|^https?:\/\/([^/]+@)?(localhost|127\.0\.0\.1)(:\d+)?\//),ee=Q.bind(/^https:\/\/((\w+-)?cdn(js)?(-\w+)?\.[^/]+|[^/]+?\.github(usercontent)?\.(io|com))\//i),te=chrome.runtime.id,ne=chrome.runtime.getManifest(),se=ne.icons[16].replace(C,""),re=se.slice(0,se.lastIndexOf("/")+1),oe=se.slice(se.lastIndexOf(".")),ae=browser.windows,ie=chrome.storage.sync.onChanged||chrome.storage.onChanged,ce=async()=>(await browser.tabs.query({currentWindow:!0,active:!0}))[0]||ae&&(await browser.tabs.query({windowId:(await ae.getCurrent()).id,active:!0}))[0],le=()=>chrome.runtime.lastError,ue=(evt,add,...args)=>add?evt.addListener(...args):evt.removeListener(args[0]);e._deepCopy=E;const de=Symbol("client"),fe=location.pathname,pe=navigator.locks,he=()=>{};let me,we=0;function ge(e,opts){let t;return new Proxy({},{get:(n,s)=>s===de?t?.[de]:function(...args){return t??=ye(e,opts,n[de]),t.call(this,s,...args)}})}function ye(e,{lock:t,once:n}={},target){let s,r,o,a,i=0;return c;async function c(...args){const e={args,stack:(new Error).stack},t=new Promise((resolve,reject)=>e.rr=[resolve,reject]);return r||o||(o=l()),o&&(o=!c[de]&&await o),(n?target:r).postMessage({args,id:++i},n||(Array.isArray(this)?this:void 0)),s.set(i,e),e.p=t.catch(he),t}async function l(){c[de]=null,target||(target="function"==typeof e?e():e).then&&(target=await target),r=target instanceof MessagePort?target:n?ve(target,null,n=[]):ve(target,{lock:t}),r.onmessage=onMessage,r.onmessageerror=ke,s=new Map,i=0,c[de]=target,a||n||!pe||f(s)}function onMessage({data:e}){const{id:t,res,err}=e.id?e:JSON.parse(e),{stack:r,rr:[resolve,reject]}=s.get(t);s.delete(t),i>1e9&&(i=0),err?reject(err[1]?Object.assign(...err,{stack:err[0].stack+"\n"+r}):err[0]):resolve(res),n&&s.size&&u(s,!0)}async function u(e,t){for(;t&&e.size;)await Promise.all(Array.from(e.values(),e=>e.p));e===s&&(t&&r?.close(),c[de]=s=r=target=null)}async function f(e){for(a=!0;!(await pe.query()).held.some(e=>e.name===t);)await d(10);await pe.request(t,he),a=!1;for(const{stack:t,rr:[,reject]}of e.values()){const msg="Target disconnected",err=new Error(msg);err.stack=msg+"\n"+t,reject(err)}e.clear(),s===e&&u(e)}}function be(evt){const{id:e}=evt.data||{},t=this,n=evt.ports[0];async function onMessage(e){const s=e.data,{args,id:r}=s.id?s:JSON.parse(s);let res,err;me&&(me=clearTimeout(me));try{res=("function"==typeof t?t:t[args.shift()]).apply(e,args),res instanceof Promise&&(res=await res)}catch(e){res=void 0,e instanceof Error?(delete e.origin,err=[e,{...e}]):err=[e]}n.postMessage({id:r,res,err},e._transfer),we=performance.now()}n.onerror=console.error,n.onmessage=onMessage,n.onmessageerror=ke,e&&onMessage(evt)}function ve(target,msg,e){const t=new MessageChannel,n=t.port2;return e?e[0]=n:target.postMessage(msg,[n]),t.port1}function ke({data:e,source:t}){console.warn("Non-cloneable data",e),t.postMessage(JSON.stringify(e))}pe&&pe.request(fe,()=>new Promise(he));ye(()=>navigator.serviceWorker.controller,{lock:"/sw.js"});let xe,Se,Ie;self;const Ee={__proto__:null,disableAll:!1,exposeIframes:!1,exposeStyleName:!1,keepAlive:0,keepAliveIdle:!1,newStyleAsUsercss:!1,openEditInWindow:!1,"openEditInWindow.popup":!1,patchCsp:!1,"show-badge":!0,styleViaASS:!1,styleViaXhr:!1,urlInstaller:!0,windowPosition:{},compactWidth:850,"config.autosave":!0,"schemeSwitcher.enabled":"system","schemeSwitcher.nightStart":"18:00","schemeSwitcher.nightEnd":"06:00","popup.enabledFirst":!0,"popup.stylesFirst":!0,"popup.autoResort":!1,"popup.borders":!1,"popup.findSort":"w","manage.onlyEnabled":!1,"manage.onlyLocal":!1,"manage.onlyUsercss":!1,"manage.onlyEnabled.invert":!1,"manage.onlyLocal.invert":!1,"manage.onlyUsercss.invert":!1,"manage.actions.expanded":!1,"manage.backup.expanded":!0,"manage.filters.expanded":!0,"manage.links.expanded":!0,"manage.minColumnWidth":750,"manage.newUI":!0,"manage.newUI.favicons":!0,"manage.newUI.faviconsGray":!1,"manage.newUI.targets":3,"manage.newUI.sort":"title,asc","manage.searchMode":"meta","editor.options":{},"editor.toc.expanded":!0,"editor.options.expanded":!0,"editor.options.style.expanded":!0,"editor.lint.expanded":!0,"editor.publish.expanded":!0,"editor.lineWrapping":!0,"editor.smartIndent":!0,"editor.indentWithTabs":!1,"editor.tabSize":4,"editor.keyMap":"default","editor.theme":"default","editor.beautify":{selector_separator_newline:!0,newline_before_open_brace:!1,newline_after_open_brace:!0,newline_between_properties:!0,newline_before_close_brace:!0,newline_between_rules:!1,preserve_newlines:!0,end_with_newline:!1,indent_conditional:!0,indent_mozdoc:!0,space_around_combinator:!0,space_around_cmp:!1},"editor.beautify.hotkey":"","editor.lintDelay":300,"editor.linter":"csslint","editor.lintReportDelay":500,"editor.matchHighlight":"token","editor.autoCloseBrackets":!0,"editor.autocompleteOnTyping":!1,"editor.contextDelete":!1,"editor.selectByTokens":!0,"editor.arrowKeysTraverse":!0,"editor.appliesToLineWidget":!0,"editor.autosaveDraft":10,"editor.livePreview":!0,"editor.livePreview.delay":.2,"editor.targetsFirst":!0,"editor.colorpicker":!0,"editor.colorpicker.hexUppercase":!1,"editor.colorpicker.hotkey":"","editor.colorpicker.color":"","editor.colorpicker.maxHeight":300,"hotkey._execute_browser_action":"","hotkey.openManage":"","hotkey.styleDisableAll":"","sync.enabled":"none",iconset:-1,badgeDisabled:"#8B0000",badgeNormal:"#006666","headerWidth.edit":280,"headerWidth.install":280,"headerWidth.manage":280,"popup.search.globals":!1,popupWidth:246,popupWidthMax:280,updateInterval:24,updateOnlyEnabled:!1},Te=console.warn.bind(console,'Unknown preference "%s"'),_e=E(Ee),De={},$e="settings",set=(new Proxy({},{get:(e,key)=>E(Ee[key])}),Object.keys(Ee),(key,val,t)=>{const n=_e[key],s=typeof Ee[key];return s?(s!==typeof val&&(val="string"===s?`${val}`:"number"===s?+val||0:"boolean"===s?"true"===val||"false"!==val&&!!val:null),val===n||"object"===s&&T(val,n)?void 0:(_e[key]=val,e._busy||De[key]?.forEach(e=>e(key,val)),set._bgSet(key,val))):Te(key)}),Oe=(e,t,n)=>{if(!t)return;let s;for(const key of Array.isArray(e)?new Set(e):[e])key in Ee?((De[key]??=new Set).add(t),n&&(xe?(s??=[]).push(key):t(key,_e[key],!0))):Te(key);return s?xe.then(()=>{for(const key of s)t(key,_e[key],!0)}):void 0},Ae=(e,t)=>{for(const key of Array.isArray(e)?e:[e]){const e=De[key];e&&(e.delete(t),e.size||delete De[key])}};function je(e,t){if(xe=!1,t){for(const key in t)!(key in e)&&key in Ee&&set(key,Ee[key],!0);for(const key in e||(e={}))set(key,e[key],!0)||delete e[key]}else Object.assign(_e,e)}xe=Se=new Promise(e=>Ie=e),xe.set=(...args)=>Ie(je(...args)),ie.addListener((e,t)=>{if(xe)return;const n=(!t||"sync"===t)&&e[$e];n&&je(n.newValue,n.oldValue)});const Re=[],Pe=[],Ue=new Map,Me={del:key=>delete Ce[key],get:key=>Ce[key],has:key=>key in Ce,pop:key=>{const val=Ce[key];return delete Ce[key],val},set:(key,val)=>{Ce[key]=val}},Ce={__proto__:null},Le=new Set,Ne=new Set,qe=new Set,We=new Set,Fe=Object.assign(new Map,{custom:{},addCustom(obj,{get=()=>obj,set}){Object.defineProperty(Fe.custom,obj._id,{get,set})}});let Be=!(!ae||!R)&&(async()=>{const e=(await ae.getAll())[0]||await new Promise(resolve=>ae.onCreated.addListener(function e(t){ae.onCreated.removeListener(e),resolve(t)}));return Be=!(!e||!e.vivExtData&&!e.extData),Be})(),He=e._busy=Object.assign(new Promise(e=>Ve=e),{resolve:Ve});var Ve;let ze;He.then(()=>{He=null,delete e._busy});let Je,Xe,Ke,Ge=0;function Qe(e){return e instanceof Promise?ze?ze.push(e):Ye([e]):Ge=performance.now(),e}async function Ye(e){ze=e,null==Xe&&He&&await He,Je||Ze();do{await Promise.allSettled(ze)}while(ze?.splice(0,e.length)&&ze.length);ze=null,Ge=performance.now()}async function Ze(){(ze||Xe<0?et(!0):Xe&&performance.now()<Ge+Xe&&await et(_e.keepAliveIdle))?Je??=setInterval(Ze,25e3):Je&&(clearInterval(Je),Je=null)}async function et(e){return("idle"!==await chrome.idle.queryState(Ke)||e)&&(e||(await chrome.windows.getAll({})).some(e=>e.focused))}Qe(He),e.keepAlive=Qe,Oe("keepAlive",(e,val)=>{Ke=Math.max(30,60*val|0||0),Xe=6e4*val,Je&&(Xe||ze)||Ze()},!0);const onMessage=new Map,tt={},nt={},st=e=>({data:e}),rt=error=>({error:Object.assign({message:error.message||`${error}`,stack:error.stack},error)});function ot(e,t,n){let s,res;for(const[r,o]of onMessage){try{res=r(e,t,!!n)}catch(e){res=Promise.reject(e)}o&&res!==s&&void 0===s&&(s=res)}return s}function at({maxActiveReader:e=1/0}={}){let t,n,s=0;const self={read:e=>r(e,!1),write:e=>r(e,!0),length:0};return self;function r(e,s){const r=a({fn:e,block:s});return n?(n.next=r,r.prev=n,n=r,t||(t=n)):t=n=r,self.length++,i(),r.q.promise}function o(){const e={};return e.promise=new Promise((resolve,reject)=>{e.resolve=resolve,e.reject=reject}),e}function a({fn:e,block:t=!1,prev:n,next:s,q:r=o(),q2:a=(e.length?o():null)}){return{fn:e,block:t,prev:n,next:s,q:r,q2:a}}function i(){const r=t;if(!r||r.block&&r.prev||r.prev&&r.prev.block||s>=e)return;let o;r.block||s++,t=r.next;try{o=r.fn(r.q2&&r.q2.resolve)}catch(e){return r.q.reject(e),void a()}if(r.q2&&r.q2.promise.then(c),o&&o.then){const e=o.then(r.q.resolve,r.q.reject);r.q2||e.then(a)}else if(r.q.resolve(o),!r.q2)return void a();function a(){c()}function c(e){r.prev&&(r.prev.next=r.next),r.next&&(r.next.prev=r.prev),n===r&&(n=r.prev),r.block||s--,self.length--,e&&e(),i()}i()}}chrome.runtime.onMessage.addListener(function({data:t,multi:n,TDM:s},r,o){0;0;r.TDM=s;let res=e._busy;if(res=res?res.then(ot.bind(null,t,r,n)):ot(t,r,n),res instanceof Promise)return res.then(st,rt).then(o),!0;void 0!==res&&o(st(res))}),chrome.runtime.onConnect.addListener(async t=>{e._busy&&await e._busy;const name=t.name.split(":",1)[0],n=tt[name],s=nt[name];n&&n(t),s&&t.onDisconnect.addListener(s)});var it=s(945);function ct(e){let t,n=0;return()=>(n&&clearTimeout(n),n=setTimeout(s),t||(t=r()),t.promise);function s(){Promise.resolve(e()).then(t.resolve,t.reject),n=0,t=null}function r(){const e={};return e.promise=new Promise((resolve,reject)=>{e.resolve=resolve,e.reject=reject}),e}}function lt(e){return new Promise(resolve=>setTimeout(resolve,e))}class RequestError extends Error{constructor(message,e,t=e&&e.status){super(message),this.code=t,this.origin=e,Error.captureStackTrace&&Error.captureStackTrace(this,RequestError)}}function ut({fetch:e,cooldown:t=0,getAccessToken:n,username:s,password:r}){const o=at(),a=s||r?`Basic ${it.encode(`${s}:${r}`)}`:null;return args=>o.write(async e=>{try{return await i(args)}finally{t&&args.method&&"GET"!==args.method?setTimeout(e,t):e()}});async function i({path:t,contentType:s,headers:r,format:o,raw:i=!1,...args}){const c={};for(n&&(c.Authorization=`Bearer ${await n()}`),a&&(c.Authorization=a),s&&(c["Content-Type"]=s),Object.assign(c,r);;){const res=await e(t,{headers:c,...args});if(!res.ok){const e=res.headers.get("Retry-After");if(e){const t=Number(e);if(t){await lt(1e3*t);continue}}const t=await res.text();throw new RequestError(`failed to fetch [${res.status}]: ${t}`,res)}if(i)return res;if(o)return await res[o]();const n=res.headers.get("Content-Type");return/application\/json/.test(n)?await res.json():await res.text()}}}const dt=function({getAccessToken:t,fetch:n=("undefined"!=typeof self?self:e).fetch}){const s=ut({fetch:n,getAccessToken:t});return{name:"dropbox",get:async function(e){const t={path:`/${e}`};try{return await s({path:`https://content.dropboxapi.com/2/files/download?${o(t)}`,format:"text"})}catch(e){throw 409===e.code&&e.message.includes("not_found")&&(e.code="ENOENT"),e}},put:a,post:async function(e,t){try{return await a(e,t,"add")}catch(e){throw 409===e.code&&e.message.includes("conflict")&&(e.code="EEXIST"),e}},delete:async function(e){try{await r({path:"files/delete_v2",body:{path:`/${e}`}})}catch(e){if(409===e.code&&e.message.includes("not_found"))return;throw e}},list:async function(e){const t=[];let n=await r({path:"files/list_folder",body:{path:`/${e}`}});for(const e of n.entries)t.push(e.name);if(!n.has_more)return t;for(;n.has_more;){n=await r({path:"files/list_folder/continue",body:{cursor:n.cursor}});for(const e of n.entries)t.push(e.name)}return t}};function r({path:e,body:t,...args}){return s({method:"POST",path:`https://api.dropboxapi.com/2/${e}`,contentType:"application/json",body:JSON.stringify(t),...args})}function o(obj){const e=new URLSearchParams;return e.set("arg",JSON.stringify(obj)),e.toString()}async function a(e,t,n="overwrite"){const r={path:`/${e}`,mode:n,autorename:!1,mute:!0};await s({path:`https://content.dropboxapi.com/2/files/upload?${o(r)}`,method:"POST",contentType:"application/octet-stream",body:t})}};const ft=function({getAccessToken:t,fetch:n=("undefined"!=typeof self?self:e).fetch}){const s=ut({fetch:n,getAccessToken:t});return{name:"onedrive",get:async function(e){return await r({path:`:/${e}:/content`,format:"text"})},put:async function(e,t){await r({method:"PUT",path:`:/${e}:/content`,headers:{"Content-Type":"text/plain"},body:t})},post:async function(e,t){try{await r({method:"PUT",path:`:/${e}:/content?@microsoft.graph.conflictBehavior=fail`,headers:{"Content-Type":"text/plain"},body:t})}catch(e){throw 409===e.code&&e.message.includes("nameAlreadyExists")&&(e.code="EEXIST"),e}},delete:async function(e){try{await r({method:"DELETE",path:`:/${e}:`})}catch(e){if(404===e.code)return;throw e}},list:async function(e){e&&(e=`:/${e}:`);let t=await r({path:`${e}/children?select=name`}),n=t.value.map(e=>e.name);for(;t["@odata.nextLink"];)t=await s({path:t["@odata.nextLink"]}),n=n.concat(t.value.map(e=>e.name));return n}};async function r(args){return args.path=`https://graph.microsoft.com/v1.0/me/drive/special/approot${args.path}`,await s(args)}};class LockError extends Error{constructor(e){super(`The database is locked. Will expire at ${new Date(e).toLocaleString()}`),this.expire=e,this.name="LockError",Error.captureStackTrace&&Error.captureStackTrace(this,LockError)}}const pt=function({getAccessToken:t,fetch:n=("undefined"!=typeof self?self:e).fetch,FormData:s=("undefined"!=typeof self?self:e).FormData,Blob:r=("undefined"!=typeof self?self:e).Blob}){const o=ut({fetch:n,getAccessToken:t}),a=new Map;let i;return{name:"google",get:async function(e){let t=a.get(e);if(!t&&(await d(`name = '${e}'`),t=a.get(e),!t))throw new RequestError(`metaCache doesn't contain ${e}`,null,"ENOENT");try{return await o({path:`https://www.googleapis.com/drive/v3/files/${t.id}?alt=media`})}catch(e){throw 404===e.code&&(e.code="ENOENT"),e}},put:async function(e,t){if(!a.has(e))return await f(e,t);const n=a.get(e),s=await u(n.id,t);n.headRevisionId=s.headRevisionId},post:f,delete:async function(e){const t=a.get(e);if(!t)return;try{await o({method:"DELETE",path:`https://www.googleapis.com/drive/v3/files/${t.id}`})}catch(e){if(404===e.code)return;throw e}},list:async function(e){return[...a.values()].filter(t=>t.name.startsWith(e+"/")).map(e=>e.name.split("/")[1])},init:async function(){await d(),a.has("lock.json")||await f("lock.json","{}");a.has("meta.json")||await f("meta.json","{}")},acquireLock:async function(e){const t=a.get("lock.json"),{headRevisionId:n}=await u(t.id,JSON.stringify({expire:Date.now()+60*e*1e3})),s=await o({path:`https://www.googleapis.com/drive/v3/files/${t.id}/revisions?fields=revisions(id)`});for(let e=1;e<s.revisions.length;e++){const r=s.revisions[e].id;if(r===n)return void(i=n);const a=JSON.parse(await o({path:`https://www.googleapis.com/drive/v3/files/${t.id}/revisions/${r}?alt=media`}));if(a.expire>Date.now())throw await c(t.id,n),new LockError(a.expire);await c(t.id,r)}throw new Error("cannot find lock revision")},releaseLock:async function(){const e=a.get("lock.json");await c(e.id,i),i=null},fileMetaCache:a};async function c(e,t){await o({method:"DELETE",path:`https://www.googleapis.com/drive/v3/files/${e}/revisions/${t}`})}async function l(e,t){e="https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=nextPageToken,files(id,name,headRevisionId)"+(e?"&"+e:"");let n=await o({path:e});for(t(n);n.nextPageToken;)n=await o({path:`${e}&pageToken=${n.nextPageToken}`}),t(n)}async function u(e,t){return await o({method:"PATCH",path:`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media&fields=headRevisionId`,headers:{"Content-Type":"text/plain"},body:t})}async function d(e){e&&(e=`q=${encodeURIComponent(e)}`),await l(e,e=>{for(const t of e.files)a.set(t.name,t)})}async function f(e,t){const n=new s;n.append("metadata",new r([JSON.stringify({name:e,parents:["appDataFolder"]})],{type:"application/json; charset=UTF-8"})),n.append("media",new r([t],{type:"text/plain"}));const i=await o({method:"POST",path:"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,headRevisionId",body:n});a.set(i.name,i)}};function ht(e){const t=Object.create(e);return t.get=async t=>JSON.parse(await e.get(t)),t.put=async(t,n)=>await e.put(t,JSON.stringify(n)),t.post=async(t,n)=>await e.post(t,JSON.stringify(n)),t.isInit=!1,t.acquireLock||(t.acquireLock=async function(e){try{await this.post("lock.json",{expire:Date.now()+60*e*1e3})}catch(t){if("EEXIST"!==t.code)throw t;const e=await this.get("lock.json");if(Date.now()>e.expire)throw await this.delete("lock.json"),new Error("Found expired lock, please try again");throw new LockError(e.expire)}},t.releaseLock=async function(){await this.delete("lock.json")}),t.getMeta||(t.getMeta=async function(){try{return await this.get("meta.json")}catch(e){if("ENOENT"===e.code||404===e.code)return{};throw e}},t.putMeta=async function(e){await this.put("meta.json",e)}),t.peekChanges||(t.peekChanges=async function(e){return(await this.getMeta()).lastChange!==e.lastChange}),t}function mt({onGet:e,onPut:t,onDelete:n,onFirstSync:s,onWarn:r=console.error,onProgress:o,compareRevision:a,getState:i,setState:c,lockExpire:l=60,retryMaxAttempts:u=5,retryExp:d=1.5,retryDelay:f=10}){let p,h,m;const w=new Map,g=ct(()=>c(p,h)),y=new Map,b=at();return{use:function(e){p=ht(e)},init:function(){return b.write(async()=>{if(!h||!h.enabled){if(!p)throw new Error("cloud drive is undefined");h=await i(p)||{},h.enabled=!0,h.queue||(h.queue=[])}})},uninit:function(){return b.write(async()=>{h&&h.enabled&&(h=m=null,w.clear(),y.clear(),p.uninit&&p.isInit&&(await p.uninit(),p.isInit=!1),await g())})},put:function(e,t){if(!h||!h.enabled)return;h.queue.push({_id:e,_rev:t,action:"put"}),g()},delete:function(e,t){if(!h||!h.enabled)return;h.queue.push({_id:e,_rev:t,action:"delete"}),g()},syncNow:function(e){return b.write(async()=>{if(!h||!h.enabled)throw new Error("Cannot sync now, the sync is not enabled");p.init&&!p.isInit&&(await p.init(),p.isInit=!0),null==h.lastChange&&await s(),await S(e)})},drive:()=>p,isInit:()=>Boolean(h&&h.enabled)};async function v(){if(m=await p.getMeta(),!m.lastChange||m.lastChange===h.lastChange)return;let e=[];if(h.lastChange){const t=Math.floor((m.lastChange-1)/100);let n=Math.floor(h.lastChange/100);for(;n<=t;){const t=await p.get(`changes/${n}.json`);w.set(n,t),e=e.concat(t),n++}e=e.slice(h.lastChange%100)}else e=(await p.list("docs")).map(name=>({action:"put",_id:name.slice(0,-5)}));const s=new Map;for(const t of e)s.set(t._id,t);let a=0;for(const[e,i]of s){let c,l;if(o&&o({phase:"pull",total:s.size,loaded:a,change:i}),"delete"===i.action)await n(e,i._rev);else if("put"===i.action){try{({doc:c,_rev:l}=await p.get(`docs/${e}.json`))}catch(t){if("ENOENT"===t.code||404===t.code){r(`Cannot find ${e}. Is it deleted without updating the history?`),a++;continue}throw t}await t(c)}const u=i._rev||l;u&&y.set(e,u),a++}h.lastChange=m.lastChange,await g()}async function k(){if(!h.queue.length)return;const t=h.queue.slice(),n=new Map;for(const e of t)n.set(e._id,e);const s=[];for(const e of n.values()){const t=y.get(e._id);void 0!==t&&a(e._rev,t)<=0||s.push(e)}let r,i,c=0;for(const t of s){if(o&&o({phase:"push",loaded:c,total:s.length,change:t}),"delete"===t.action)await p.delete(`docs/${t._id}.json`);else if("put"===t.action){const n=await e(t._id,t._rev);await p.put(`docs/${t._id}.json`,{doc:n,_rev:t._rev})}y.set(t._id,t._rev),c++}if(m.lastChange){i=Math.floor(m.lastChange/100);const e=m.lastChange%100;r=e?w.get(i)||await p.get(`changes/${i}.json`):[],r=r.slice(0,e).concat(s)}else i=0,r=s;for(let e=0;100*e<r.length;e++){const t=r.slice(100*e,100*(e+1));await p.put(`changes/${i+e}.json`,t),w.set(i+e,t)}m.lastChange=(m.lastChange||0)+s.length,await p.putMeta(m),h.queue=h.queue.slice(t.length),h.lastChange=m.lastChange,await g()}async function x(){let e,t=0,n=f;for(;;){try{await p.acquireLock(l);break}catch(t){if("LockError"!==t.name)throw t;e=t}if(t++,t>=u)throw e;await lt(1e3*n),n*=d}try{await v(),await k()}finally{await p.releaseLock()}}async function S(e=!0){o&&o({phase:"start"});try{if(!h.queue.length&&e&&m){if(!await p.peekChanges(m))return}await x()}finally{o&&o({phase:"end"})}}}const wt={dropbox:dt,onedrive:ft,google:pt,webdav:!1},gt=chrome.webNavigation,yt={url:[{schemes:["http","https","file","ftp","ftps"]},{urlPrefix:C}]},bt="committed";let vt={};async function kt(e,t){if(R&&t.timeStamp===vt.timeStamp&&T(t,vt))return;vt=t,He&&await He;const{tabId:n}=t,s=xt[n];if(s&&e!==bt){const{frameId:e,documentId:r,frameType:o,url:a}=t,i=!o&&!e||"outer_frame"===o,c=s.url?.[e];c!==a&&qt(n,{method:"urlChanged",top:i,old:c,url:a},{documentId:r})}for(const n of We)n(t,e)}gt.onCommitted.addListener(kt.bind(null,bt),yt),gt.onHistoryStateUpdated.addListener(kt.bind(null,"history"),yt),gt.onReferenceFragmentUpdated.addListener(kt.bind(null,"hash"),yt);const cache={__proto__:null},xt=cache,St=(e,...args)=>{const value=args.pop(),t=args.pop(),n=void 0===value;let obj=cache[e];if(!obj){if(n)return;cache[e]=obj={id:e}}for(let key,e=0;obj&&e<args.length;e++)obj=obj[key=args[e]]||!n&&(obj[key]={});return n?obj&&delete obj[t]:obj[t]=value,value},It=()=>{for(let e in cache)if(e=cache[e],e.styleIds||(e=e.url)&&Y(e[0]))return!0};Pe.push(async()=>{for(const{id:e,url:t}of await browser.tabs.query({}))Y(t)&&(cache[e]={id:e,url:{0:t}})}),He.then(()=>{We.add(({tabId:e,frameId:t,url:n},s)=>{let obj,r;if((obj=cache[e])?(r=obj.url?.[0],s===bt&&obj.styleIds&&(t?delete obj.styleIds[t]:delete obj.styleIds)):cache[e]=obj={id:e},s!==bt||t?(obj.url??={})[t]=n:obj.url={0:n},!t)for(const t of Ne)t(e,n,r)})}),nt.apply=function(e){le();const{sender:t}=e,n=t.tab?.id,s=t.frameId;if(!s)return;for(const t of qe)t(n,s,e)},chrome.tabs.onCreated.addListener(()=>{}),chrome.tabs.onRemoved.addListener(async e=>{He&&await He,delete cache[e];for(const t of qe)t(e,0)});const Et="offscreen.html",Tt=C+Et,_t=ge(()=>Dt??=create().finally(Ot),{lock:"/"+Et});let Dt;async function $t(){for(const e of await At())if(e.url===Tt)return e}async function create(){try{await chrome.offscreen.createDocument({url:Tt,reasons:["BLOBS","DOM_PARSER","MATCH_MEDIA","WORKERS"],justification:"ManifestV3 requirement"})}catch(e){if(!e.message.startsWith("Only a single offscreen"))throw e}return $t()}function Ot(){Dt=null}const At=()=>self.clients.matchAll({includeUncontrolled:!0,type:"window"}),jt=ge(async()=>{let e;if(!_t[de])for(const t of await At())if(!Ue.has(t.url)){e=ge(t,{once:!0});break}return(e||_t).getWorkerPort(q)},{lock:q});let Rt,Pt,Ut;function Mt(e,{onlyIfStyled:t,getData:n}={}){n&&!(e=n())||((Rt??=[]).push(e),(Pt??=[]).push(!!t),Ut??=setTimeout(Ct))}async function Ct(){const e=[],t=Pt.indexOf(!1),n=t<0,[s,tabs,r]=await Promise.all([At(),n?[]:browser.tabs.query({}),n&&It()&&ce()]),o=Rt,a=Pt;let i,c;Rt=Pt=Ut=null;let l=0;if(n){if(r)for(const{id:e,url:t,styleIds:n}of Object.values(xt))n&&t&&t[0]&&!t[0].startsWith(C)&&(l=tabs[e===r.id?"unshift":"push"](e))}else{for(let e,t,n=0;n<tabs.length;n++)e=tabs[n],!e.discarded&&(t=e.url)&&!t.startsWith(C)&&Y(e.url)&&(n&&e.active?(tabs[l]=tabs[0],tabs[0]=e.id):tabs[l]=e.id,l++);tabs.length=l}if(s)e.push(Lt(o.length>1?o:o[0],o.length>1));else if(!l)return;for(const n of tabs){const msg=!t||xt[n]?.styleIds?c??=o:i??=o.filter((e,t)=>!a[t]),s=msg.length;s&&e.push(qt(n,s>1?msg:msg[0],void 0,s>1))>20&&await Promise.all(e.splice(0))}await Promise.all(e)}function Lt(e,t){return Wt(browser.runtime.sendMessage({data:e,multi:t}))}function Nt(e,t=0){return qt(e,{method:"ping"},{frameId:t})}function qt(e,t,n,s){return Wt(browser.tabs.sendMessage(e,{data:t,multi:s},n),s)}async function Wt(e,t){const err=new Error;let n,error;try{if(({data:n,error}=await e||{}),!error)return n}catch(e){if(error=e,c.test(err.message=e.message))return}return error.stack&&(err.stack=error.stack+"\n"+err.stack),t?(console.error(err),n):Promise.reject(err)}const Ft={async getValue(key){return(await this.get(key))[key]}},Bt=Object.assign(browser.storage.local,Ft);chrome;let Ht=pn;const Vt="drafts",zt={[Vt]:fn,[$e]:fn},{CompressionStream:Jt}=e,Xt="application/gzip",Kt=Jt&&{headers:{"content-type":Xt}},Gt="http://_/",Qt={stylish:null,[$e]:null},Yt={},Zt={},en={},tn={},nn={},sn={},rn={get:({dbName:e},t)=>(zt[e]||Ht).bind(null,e,t)},on=(e,{id:t,store:n="data",ver:s=2}={})=>nn[e]??=(Yt[e]=t&&"string"!=typeof t?"id":t,Zt[e]=n,en[e]=s,new Proxy({dbName:e},rn)),an=on("cache",{id:"url"}),cn=on("stylish",{id:!0,store:"styles"}),ln=on(Vt),un=on($e),dn=on("state",{store:"kv"});async function fn(e,t,n,s){const r=tn[e]??={},res="get"===t&&n in r?r[n]:await Ht(...arguments);if("get"===t)r[n]=I(res);else if("put"===t){const key=Yt[e];r[key?n[key]:s]=I(n)}else"delete"===t&&delete r[n];return res}async function pn(e,t,...args){const n=t.startsWith("get")?void 0:"readwrite",s=Zt[e],r=(sn[e]??=await mn(e)).transaction([s],n).objectStore(s);return n&&e in Qt&&gn(...arguments),t.endsWith("Many")?hn(r,t.slice(0,-4),args[0]):new Promise((resolve,reject)=>{const e=r[t](...args);e.onsuccess=()=>resolve(e.result),e.onerror=reject})}function hn(e,t,n){let resolve,reject,s=0;const r=new Promise((e,t)=>{resolve=e,reject=t}),results=[],o=({target:e})=>{results[e.i]=e.result,--s||resolve(results)};for(const r of n){const n=e[t](r);n.onerror=reject,n.onsuccess=o,n.i=s,results[s]=null,s++}return r}function mn(name){return new Promise((resolve,reject)=>{const e=indexedDB.open(name,en[name]);e.onsuccess=e=>resolve(wn(e)),e.onerror=reject,e.onupgradeneeded=wn})}function wn(e){const t=e.target.result,n=t.name,s=Zt[n];if(!t.objectStoreNames.contains(s)){if("success"===e.type)return t.close(),new Promise(resolve=>{indexedDB.deleteDatabase(n).onsuccess=()=>{resolve(mn(n))}});t.createObjectStore(s,Yt[n]?{keyPath:Yt[n],autoIncrement:!0}:void 0)}return t}async function gn(e,t,n,s){const r=Qt[e]??=await caches.open(e);switch(t){case"delete":return r.delete(Gt+n);case"get":return(s=await gn(e,"getAll",n))[0];case"getAll":n=await r.matchAll(n);for(let e=0;e<n.length;e++)s=n[e],Kt&&s.headers.get("content-type")===Xt&&(s=new Response(s.body.pipeThrough(new DecompressionStream("gzip")))),n[e]=s.text();n=await Promise.all(n);for(let e=0;e<n.length;e++)n[e]=JSON.parse(n[e]);return n;case"put":return await d(10),"stylish"===e&&n.usercssData&&delete(n={...n}).sections,s=Gt+(s??n.id),n=JSON.stringify(n),Kt&&(Kt.headers["Content-Length"]=n.length),Jt&&(n=new Response(n).body.pipeThrough(new Jt("gzip"))),r.put(s,new Response(n,Kt));case"putMany":for(s of n)await gn(e,"put",s)}}async function yn(e){if(!await caches.has("stylish"))for(const{style:t}of e.values())await gn("stylish","put",t);if(!await caches.has($e))for(const key of["injectionOrder"]){const val=await un.get(key);val&&await gn($e,"put",val,key)}}Object.assign(API,{draftsDB:ln,prefsDB:un});const bn="schemeSwitcher.enabled",vn="schemeSwitcher.nightStart",kn="schemeSwitcher.nightEnd",xn="light",Sn="never",In="system",En="time",map={[Sn]:!1,dark:!0,[xn]:!1,[In]:null,[En]:!1},Tn=["dark",xn],_n=()=>$n===In&&_t.isDark().then(Dn),Dn=qn.bind(null,In);let $n,On,An,jn,Rn,Pn=null;function Un({preferScheme:e}){return $n===Sn||"dark"!==e&&e!==xn||Pn===("dark"===e)}function Mn(key){const[e,t]=_e[key].split(":");return 1e3*(3600*e+60*t)}function Cn(key,value){const e=new Date,[t,n]=value.split(":");e.setHours(t,n,0,0),e.getTime()<Date.now()&&e.setDate(e.getDate()+1),chrome.alarms.create(key,{when:e.getTime(),periodInMinutes:1440})}function Ln(e){if(!0!==e)return g(Ln,0,!0);Nn(),Cn(vn,_e[vn]),Cn(kn,_e[kn])}function Nn(){const now=Date.now()-(new Date).setHours(0,0,0,0),e=Mn(vn),t=Mn(kn);qn(En,e>t?now>=e||now<t:now>=e&&now<t)}function qn(e,val){if(e){if(map[e]===val)return;if(e===In&&(jn??=setTimeout(Fn)),map[e]=val,!$n)return}Pn!==(val=map[$n])&&(Pn=val,Pn!==An&&null!=On&&Wn())}function Wn(){An=Pn,Lt({method:"colorScheme",value:Pn});for(const e of Le)e(Pn)}async function Fn(){He&&await He;const val=(Pn?1:0)+(map[In]?2:0);On!==val&&dn.put(On=val,"dark"),jn=null}async function Bn(e){const t="<all_urls>",n=ne.content_scripts,s=(e,t=".")=>f(e.replace(/\*/g,"\n")).replace(/\n/g,t+"*?");if(!Rn){Rn=!0;for(const e of n)(e[t]=e.matches.includes(t))||e.matches.forEach((t,n)=>{const[,r,o,a]=t.match(/^([^:]+):\/\/([^/]+)\/(.*)/);e.matches[n]=new RegExp(`^${"*"===r?"https?":r}://${s(o,"[^/]")}/${s(a)}$`)})}e||await d();for(const t of e?[e]:await browser.tabs.query({})){const n=t.pendingUrl||t.url,res=t.width&&!t.discarded&&Y(n)&&await r(t.id,n,e);if(e)return res&&res[0]&&!res[0].message&&0===res[0].frameId}async function r(e,s,r){const o=[];if(St(e,"url",0,s),r||!await qt(e,{method:"backgroundReady"})){for(const r of n)(r[t]||r.matches.some(s.match,s))&&o.push(chrome.scripting.executeScript({injectImmediately:"document_start"===r.run_at,target:{allFrames:r.all_frames,tabId:e},files:r.js}).catch(le));return Promise.all(o)}}}chrome.alarms.onAlarm.addListener(async function({name}){name!==vn&&name!==kn||($n||await Se,Nn())}),Re.push(dn.get("dark").then(val=>{On=+val,"number"==typeof val&&(An=Pn=!!(1&val),map[In]??=!!(2&val),qn())})),He.then(()=>setTimeout(()=>Oe([bn,"styleViaXhr"],(key,val,init)=>{init&&"styleViaXhr"!==key||((val=_e[bn]===In||_e.styleViaXhr)||_t[de])&&_t.keepAlive(val)},!0),Ue.size?50:0)),Oe(bn,(e,val)=>{$n=val,val===En?Oe([vn,kn],Ln,!0):(Ae([vn,kn],Ln),chrome.alarms.clear(vn),chrome.alarms.clear(kn)),qn()},!0);const Hn={domains:"domain",urlPrefixes:"url-prefix",urls:"url",regexps:"regexp"},Vn=/\s+|\/\*([^*]+|\*(?!\/))*(\*\/|$)|@namespace[^;]+;|@charset[^;]+;/iuy;function zn(e){const{code:t}=e;let res=!t;if(res||null!=(res=e._empty))return res;const n=t.length,s=Vn;s.lastIndex=0;let r=0;for(;s.exec(t)&&(r=s.lastIndex)!==n;);return Object.defineProperty(e,"_empty",{value:res=r===n,configurable:!0}),zn.lastIndex=r,res}function Jn({sections:e},{sections:t}){return e&&t&&e.length===t.length&&e.every(Xn,t)}function Xn(e,t){const n=this[t];if(Kn(e.code,n.code,!0)){for(const target in Hn)if(!Kn(e[target],n[target],!1))return;return!0}}function Kn(e,t,n){const s=n?"string"==typeof e:Array.isArray(e),r=n?"string"==typeof t:Array.isArray(t);return s&&r&&(n?e===t:e.length===t.length&&Gn(e,t))||(null==e||s&&!e.length)&&(null==t||r&&!t.length)}function Gn(e,t){return e.every(Qn,t)&&t.every(Qn,e)}function Qn(e){return this.includes(e)}async function Yn(e){const src=e.usercssData?e.sourceCode:JSON.stringify((e.sections||[]).map(e=>({code:e.code||"",urls:e.urls||[],urlPrefixes:e.urlPrefixes||[],domains:e.domains||[],regexps:e.regexps||[]}))),t=(new TextEncoder).encode(src),res=await crypto.subtle.digest("SHA-1",t);return Array.from(new Uint8Array(res),e=>(256+e).toString(16).slice(1)).join("")}for(var Zn=0,es={},fromCharCode=String.fromCharCode,ts="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+",ns=(ts+"/=").split(""),ss=(ts+"-$").split("");Zn<65;)Zn>62&&(es[ss[Zn].charCodeAt(0)]=Zn),es[ns[Zn].charCodeAt(0)]=Zn++;function rs(length,e,t){for(var n,s=[0,1,2],r=4,o=4,a=3,i="",c=[],l="",u=0,d=2,f=0,p=t(0),h=e,m=1;f!=d;)u+=(p>>--h&1)<<f++,0==h&&(h=e,p=t(m++));if(2==u)return"";for(d=8*u+8,u=f=0;f!=d;)u+=(p>>--h&1)<<f++,0==h&&(h=e,p=t(m++));for(n=fromCharCode(u),s[3]=n,l=n,c.push(n);m<=length;){for(d=a,u=f=0;f!=d;)u+=(p>>--h&1)<<f++,0==h&&(h=e,p=t(m++));if(u<2){for(d=8+8*u,u=f=0;f!=d;)u+=(p>>--h&1)<<f++,0==h&&(h=e,p=t(m++));s[o]=fromCharCode(u),u=o++,0==--r&&(r=1<<a++)}else if(2==u)return c.join("");if(u>s.length)return null;i=u<s.length?s[u]:l+l.charAt(0),c.push(i),s[o++]=l+i.charAt(0),l=i,0==--r&&(r=1<<a++)}return""}const os=browser.storage.sync,as="MAX_WRITE_OPERATIONS_PER_MINUTE",is={csslint:"editorCSSLintConfig",stylelint:"editorStylelintConfig",usercssTemplate:"usercssTemplate"},cs=os.get.bind(os),ls=ps.bind(os.set),us=val=>{return x(null==(e=val)?"":""==e?null:rs(e.length,15,function(t){return e.charCodeAt(t)-32}));var e},ds=async key=>us((await cs(key))[key]);let fs;async function ps(...args){for(;;)try{if(!fs)return await(fs=this.apply(os,args));await fs.catch(()=>0)}catch(t){if(!t.message.includes(as))throw t;fs=d(6e4/(os[as]||120)*(2*Math.random()+1)),await e.keepAlive(fs)}finally{fs=null}}const hs="connected",ms="connecting",ws="disconnected",gs="disconnecting",ys=1e6,bs=1,vs=chrome.declarativeNetRequest,ks=Es.bind(vs.updateDynamicRules),xs=Es.bind(vs.updateSessionRules),Ss=e=>e.id,Is=e=>e.map(Ss);function Es(e,t=Is(e)){return this({addRules:e,removeRuleIds:t})}let Ts,_s;const Ds=1e3,$s=new Map,Os=new Set,As=$s,js=e=>(e=$s.get(e))&&Ws(e);function Rs(){Ts&&$s.forEach(Ts),$s.clear(),an.clear(),_s&&(_s=clearTimeout(_s))}async function Ps(e){const val=await an.get(e);if(val){$s.set(e,Ws(val));const t=Object.keys(val.sections??={}).map(Number),n=t.length?await cn.getMany(t):[];for(const e of n)if(!e||!Cs(val,e))return void Ls([val])}return val}async function Us(){for(const val of await an.getAll())$s.has(val.url)||$s.set(val.url,val)}function Ms(e){const t=[];for(const val of $s.values())for(const n in val.sections??={}){const s=e.get(+n);if(!s||!Cs(val,s.style)){t.push(val);break}s.appliesTo.add(val.url)}t[0]&&Ls(t)}function Cs(e,t,n,s){const r=t.id,o=e.sections;if(n||(n=o[r])&&!n.idx){if(!s){s=[];for(const e of n){const n=t.sections[e];if(!n)return;s.push(n.code)}}o[r]={id:r,idx:n,code:s,name:t.customName||t.name}}return!!n}function Ls(e){if(e[0]){for(let val,t=0;t<e.length;t++)val=e[t],$s.delete(e[t]=val.url),Ts(val);an.deleteMany(e)}}function Ns(){const e=[];let t;e:for(const val of Os){const{d:n,url:s,sections:r}=val,o={},res={};let a;for(a in r){const e=r[a],n=e&&(Array.isArray(e)?e:e.idx);if(!n){(t??=[]).push(val);continue e}o[a]=n}a&&(res.sections=o),res.d=[n?.[1]||0,new Date],res.url=s,e.push(res)}t&&Ls(t),an.putMany(e),Os.clear(),_s=null}async function qs(){_s=setTimeout(Ns,He?(await He,5e3):50)}function Ws(val){return val&&(Os.add(val),_s||qs()),val}const Fs="patchCsp",Bs="disableAll",Hs=1e4,Vs="ruleIds",zs="set-cookie",Js=/^('non(e|ce-.+?)'|(https?:\/\/)?[^']+?[^:'])$/,Xs=/(?:^|[;,])\s*style-src\s+[^;,]*?'nonce-([-+/=\w]+)'/,Ks="blob:"+C,Gs={urls:["*://*/*"],types:["main_frame","sub_frame"]},Qs=e=>new Blob([JSON.stringify(e)],{type:"application/json"}),Ys=e=>`${te}=${e}; SameSite=Lax`,Zs=e=>e.tabId+":"+e.frameId,er=e=>e&&_t.revokeObjectURL(Ks+e),tr={},nr=browser.permissions.contains({permissions:["webRequestBlocking"]}),sr={};let rr,or,ar=!0,ir=!1,cr=!1;function lr(e){const t=!e,n=_e[Bs],s=!n&&_e[Fs],r=!n&&_e.styleViaXhr;if(!t&&r===cr&&s===ir&&n===ar)return;let o;n!==ar&&s!==ir&&(o=chrome.webRequest.onHeadersReceived,ue(o,!1,fr),ue(o,!n,fr,Gs,["blocking","responseHeaders",!1].filter(Boolean))),(t||n!==ar)&&ue(chrome.webRequest.onBeforeRequest,t||!n&&!0,ur,Gs),ir=s,ar=n,cr=r}async function ur(e){const{tabId:t,frameId:n,url:s}=e;if(t<0)return;const key=t+":"+n,r=Re.length,o=$n===In&&!It()&&_n();if(!cr&&!ir&&!He)return;let a,i,c=r&&new Promise(resolve=>i=resolve);if(r){Re.push(Ps(s),n?browser.tabs.get(t).catch(le):void 0,o);const all=Promise.all(Re);c&&Re.push(c),[a,e.tab]=(await all).slice(r)}!a&&He?(c&&(c=i()),await He):!r&&o&&await o;const l=tr[key],u=l||{},d=u.payload=Wi.call({sender:e},s,null,"styleViaXhr"),f=d.sections.length;u.url=s,l&&mr(null,key,u,f),cr&&f&&await dr(t,n,s,u,key,d),tr[key]=u,c&&setTimeout(i)}async function dr(e,t,n,s,key,r){let o;for(const t in tr){if(key===t)continue;const val=tr[t];if(val.url===n&&T(r,val.payload)){setTimeout(gr,Hs,e),r=val.payload,o=val.blobId;break}}o||(o=(await _t.createObjectURL(Qs(r))).slice(Ks.length)),s.blobId=o;const a=Ys(o);let{ruleId:i=0}=s;if(!i){for(;++i in rr;);s.ruleId=i}rr[i]=key,sr[key]=i,or??=setTimeout(br),await xs([{id:i,condition:{tabIds:[e],urlFilter:"|"+n+"|",resourceTypes:[t?"sub_frame":"main_frame"],excludedResponseHeaders:[{header:zs,values:[a]}]},action:{type:"modifyHeaders",responseHeaders:[{header:zs,value:a,operation:"append"}]}}])}function fr(e){const key=Zs(e),t=tr[key];if(!t)return;const{responseHeaders:n}=e,{payload:s}=t,r=s.sections,o=(P||ir)&&yr(n,"content-security-policy");if(o){const t=o.value.match(Xs);t&&St(e.tabId,"nonce",e.frameId,s.cfg.nonce=t[1]),ir&&r[0]&&pr(o)}if(!r[0])return void mr(e,key,t);let a;return cr&&(a=t.blobId??=!1)&&(a=Ys(a),yr(n,zs,a)?a=!1:n.push({name:zs,value:a})),a||o&&ir?{responseHeaders:n}:void 0}function pr(e){const src={};for(let t of e.value.split(/[;,]/))t=t.trim().split(/\s+/),src[t[0]]=t.slice(1);hr(src,"img-src","data:","*"),hr(src,"font-src","data:","*"),hr(src,"style-src","'unsafe-inline'","*"),src.sandbox&&!src.sandbox.includes("allow-same-origin")&&src.sandbox.push("allow-same-origin"),e.value=Object.entries(src).map(([e,t])=>`${e}${t.length?" ":""}${t.join(" ")}`).join("; ")}function hr(src,name,...e){let t=src["default-src"],n=src[name];(t||n)&&(t||(t=[]),n||(n=[...t]),e.includes("*")&&(n=src[name]=n.filter(e=>!Js.test(e))),n.push(...e.filter(e=>!n.includes(e))),n.length||delete src[name])}function mr(e,key=Zs(e),t=tr[key],n){let s;t&&(delete tr[key],(s=t.blobId)&&(e?setTimeout(er,Hs,s):er(s),t.blobId=""),(s=t.timer)&&(t.timer=clearTimeout(s))),!n&&(t?rr[s=t.ruleId]:s=sr[key])&&(delete rr[s],delete sr[key],or??=setTimeout(br),xs(void 0,[s]))}function wr(e){e=new RegExp(`^(?:${e.join("|")}):`);const t=[];for(const key in sr)if(e.test(key)){const e=sr[key];t.push(e),delete rr[e],delete sr[key]}t.length&&(xs(void 0,t),or??=setTimeout(br));for(const key in tr)e.test(key)&&mr(null,key)}async function gr(e){try{await chrome.tabs.get(e)}catch{delete xt[e],wr([e])}}function yr(e,name,value){for(const t of e)if(t.name.toLowerCase()===name&&(null==value||t.value===value))return t}function br(){or=null,b(rr)?dn.delete(Vs):dn.put(rr,Vs)}lr(),Re.push((async()=>{rr=await dn.get(Vs)||{};for(const e in rr)sr[rr[e]]=+e})()),Se.then(()=>{lr(!0),Oe([Bs,Fs,"styleViaXhr"],lr)}),He.then(()=>{const e=[];for(let key in sr)xt[key=parseInt(key)]||e.push(key);e.length&&wr(e)}),qe.add((e,t)=>{t?setTimeout(mr,Hs,null,e+":"+t):wr([e])}),gt.onErrorOccurred.addListener(mr,{url:[{urlPrefix:"http"}]}),R&&chrome.webRequest.onBeforeRequest.addListener(e=>{Me.popup=e.tabId<0&&Gi()},{urls:[L],types:["main_frame"]});const vr=chrome.action||{},kr=new Set,xr={},Sr={color:"",text:""},Ir=[16,32],Er="badgeDisabled",Tr="badgeNormal",_r="iconset",Dr="show-badge";let $r=!(P&&U)&&null;async function Or(){He&&(Pe[Pe.indexOf(Ar)]=0,await He),Ar(!0)}function Ar(e=!1){Oe(["disableAll",Er,Tr],()=>g(Wr),e),Oe([Dr],()=>g(Br),e),Oe(["disableAll",_r],()=>g(Fr),e)}function jr(e,t){const{tab:{id:n},TDM:s}=this.sender,r=s>0?0:this.sender.frameId,value=e.length?e.map(Number):void 0;St(n,"styleIds",r,value),g(Hr,r&&t?250:0),kr.add(n),r||Mr(n,!0),mr(null,n+":"+r)}function Rr({text:e="",color:t="",title:n=""}={}){if(Sr.text!==e){Sr.text=e,Sr.color=t,Wr(),Jr({text:e});for(let t in xt)t=+t,e?Jr({tabId:t,text:e}):Pr(t);Vr("setTitle",{title:n&&w(n,"",!1)||n||""})}}function Pr(e){if(Sr.text)return;Jr({tabId:e,text:_e[Dr]?`${Lr(e)}`:""})}function Ur(e=!1){const t=_e[_r];return`${0===t||-1===t&&Pn?"":"light/"}$SIZE$${_e.disableAll?"x":e?"":"w"}`}function Mr(e,t=!1){const n=xt[e]||{id:e},s=n.icon,r=Ur(n.styleIds?.[0]);(t||s!==r)&&(St(e,"icon",r),zr({path:Cr(r),tabId:e}))}function Cr(e){return Ir.reduce((obj,t)=>(obj[t]=re+e.replace("$SIZE$",t)+oe,obj),{})}function Lr(e){const t=new Set;for(const n of Object.values(xt[e]?.styleIds||{}))n.forEach(t.add,t);return t.size||""}async function Nr(e){const{OffscreenCanvas:t}=self||{},n=await createImageBitmap(await(await fetch(e)).blob()),{width:s,height:r}=n,o=new t(s,r).getContext("2d");o.drawImage(n,0,0,s,r);const a=o.getImageData(0,0,s,r);return xr[e]=a,a}function qr(){zr({path:Cr(Ur())})}function Wr(){Xr({color:Sr.color||_e[_e.disableAll?Er:Tr]})}function Fr(){for(const e in xt)Mr(+e);qr()}function Br(){for(const e in xt)Pr(+e)}function Hr(){for(const e of kr)Pr(e);kr.clear()}function Vr(e,t){if(vr[e])try{vr[e](t,le)}catch{vr[e](t)}}async function zr(e){if(null==$r){const e=re+Ir[0]+oe;$r=xr[e]=Nr(e),$r=(await $r).data.some(e=>255!==e)}else $r.then&&await $r;if($r){e.imageData={};for(const[key,t]of Object.entries(e.path)){const val=xr[t]||(xr[t]=Nr(t));e.imageData[key]=val.then?await val:val}delete e.path}Vr("setIcon",e)}function Jr(e){Vr("setBadgeText",e)}function Xr(e){Vr("setBadgeBackgroundColor",e)}Pe.push(Ar),Le.add(()=>{-1===_e[_r]&&(g(qr),g(Fr))}),qe.add((e,t,n)=>{t&&xt[e]?.styleIds&&jr.call(n,[],!0)});const Kr={},Gr="Timeout fetching ",Qr=(e,t)=>e.abort(Gr+t);function Yr(t,n={}){const key=arguments[1]?t+"\0"+JSON.stringify(n):t,s=Kr[key]??={req:e.keepAlive(Zr(t,n,key))};if(n.port){const e=s.ports||(s.ports=new Set),t=chrome.runtime.connect({name:n.port});t.onDisconnect.addListener(()=>e.delete(t)),e.add(t)}return s.req}async function Zr(e,{method:t="GET",body:n,responseType:s="text",requiredStatusCode:r=200,timeout:o=6e4,loadTimeout:a=12e4,headers:i,responseHeaders:c,port:l,...opts},u){let d,f,p,h;try{if(e.startsWith(F)&&e.includes("?")){const s=e.indexOf("?");null==n?(t="POST",n=e.slice(s),e=e.slice(0,s)):"GET"===t&&e.length>=2e3&&e.startsWith(H)&&(e=eo(h=[],e,s)),i??={"content-type":"application/x-www-form-urlencoded"}}const m=await fetch(e,{...opts,body:n,method:t,headers:i,signal:o?(d=new AbortController,p=setTimeout(Qr,o,d,e),d.signal):null});if(p&&clearTimeout(p),p=a&&setTimeout(Qr,a,d,e),r&&m.status!==r&&!e.startsWith("file:"))throw new Error(`Bad status code ${m.status} for ${e}`);if(l){f="";for await(const value of m.body.pipeThrough(new TextDecoderStream))so(u,[(f+=value).length])}else f=await m["arraybuffer"===s?"arrayBuffer":s]();return f&&h&&(f=to(h,e,f)),c&&(f={response:f,headers:no(m,c)}),f}finally{p&&clearTimeout(p),Kr[u].ports?.forEach(e=>e.disconnect()),delete Kr[u]}}function eo(e,t,n){const s=new URLSearchParams(t.slice(n+1));for(const[t,n]of s.entries())n.length<10||n.startsWith("ik-")||(e.push(n),s.set(t,`${e.length}`));return t.slice(0,n+1)+s}function to(e,t,n){const s="string"==typeof n,r=s&&x(n)||n;r.updateUrl=t;for(const t of r.sections||[]){const{code:n}=t;n.includes("")&&(t.code=n.replace(/\x01(\d+)\x02/g,(t,n)=>e[n-1]||""))}return s?JSON.stringify(r):r}function no(src,e){const res={};for(const t of e)res[t]=src.headers.get(t);return res}function so(e,msg){Kr[e]?.ports?.forEach(e=>e.postMessage(msg))}const ro=!(!ae||!R&&!e.AbortController),oo=["chrome://newtab/","chrome://startpage/","chrome://startpageshared/","chrome-extension://mpognobbkildjkofajifpdfhcoklimli/components/startpage/startpage.html","chrome://vivaldi-webui/startpage","about:home","about:newtab"];async function ao(opts={}){const e=chrome.runtime.getURL("manage.html"),t=uo(e,opts),tabs=await browser.tabs.query({url:e+"*"}),n=tabs.find(e=>e.url===t);let s=n||tabs[0];return s?n||await qt(s.id,{method:"pushState",url:uo(s.url,opts)}):(un.get("badFavs"),s=await io({url:t,newTab:!0})),co(s)}async function io({url:e,index:t,openerTabId:n,active:s=!0,currentWindow:r=!0,newWindow:o,newTab:a}){e.includes("://")||(e=chrome.runtime.getURL(e));let i=!a&&(await browser.tabs.query({url:e.split("#")[0],currentWindow:r}))[0];if(i)return co(i,{index:t,openerTabId:n,url:e!==(i.pendingUrl||i.url)&&e.includes("#")?e:void 0});if(o&&ae)return(await ae.create(Object.assign({url:e},o))).tabs[0];if(i=await ce()||{url:""},i&&oo.includes((i.pendingUrl||i.url||"").replace("edge://","chrome://"))&&(!i.incognito||!e.startsWith("chrome")))return co(i,{url:e,openerTabId:n});const c=n??i.id;return browser.tabs.create(Object.assign({url:e,index:t,active:s},null!=c&&!i.incognito&&ro&&{openerTabId:c,windowId:i.windowId}))}async function co(e,{url:t,index:n,openerTabId:s}={}){const r={active:!0};return t&&(r.url=t),null!=s&&ro&&(r.openerTabId=s),await Promise.all([browser.tabs.update(e.id,r),ae?.update(e.windowId,{focused:!0}),null!=n&&browser.tabs.move(e.id,{index:n})]),e}function lo(e=""){return e.substring(0,e.indexOf("/",e.indexOf(":")+3))}function uo(e,opts){const t=new URL(e);for(const key of["search","searchMode"])key in opts?t.searchParams.set(key,opts[key]):t.searchParams.delete(key);return t.hash=opts.options?"#stylus-options":"",t.href}const fo={},po="mime",ho="urlInstaller";function mo(e){const{code:t,timer:n}=fo[e];return yo(e),clearTimeout(n),t}function wo(key,val,e){val?Ne.add(xo):Ne.delete(xo),e||go(val)}function go(val){const e=val?[""]:[z,...V,...["greasy","sleazy"].map(e=>`https://update.${e}fork.org/`)];ks([{id:bs,condition:{regexFilter:(val?/^.*\.user\.(?:css|less|styl)(?:\?.*)?$/:/^.*\.user\.css$/).source,requestDomains:val?void 0:[...new Set(e.map(l))],resourceTypes:["main_frame"],responseHeaders:[{header:"content-type",values:["text/*"],excludedValues:["text/html*"]}]},action:{type:"redirect",redirect:{regexSubstitution:chrome.runtime.getURL(N+"#\\0")}}}])}function yo(e){delete fo[e]}async function bo(e){return(await browser.tabs.executeScript(e,{file:"/js/install-hook-usercss.js"}))[0]}async function vo(e,t){return(t.startsWith("file:")||xt[e]?.[po])&&Yr(t)}function ko(e){return`${C}${N}?updateUrl=${encodeURIComponent(e)}`}async function xo(e,t,n=""){if(t.includes(".user.")&&!1!==xt[e]?.[po]&&/^(https?|file|ftps?):/.test(t)&&/\.user\.(css|less|styl)$/.test(t.split(/[#?]/,1)[0])&&!n.startsWith(ko(t))){const n=P&&t.startsWith("file:"),s=await(n?bo:vo)(e,t);!/^\s*</.test(s)&&h.test(s)&&await So(e,t,{code:s,inTab:n})}}async function So(e,t,{code:n,inTab:s}={}){const r=ko(t);if(s){const t=await browser.tabs.get(e);return io({url:`${r}&tabId=${e}`,active:t.active,index:t.index+1,openerTabId:e,currentWindow:null})}const o=setTimeout(yo,1e4,t);fo[t]={code:n,timer:o};try{await browser.tabs.update(e,{url:r})}catch(e){if(/Tabs cannot be edited right now/i.test(e.message))return browser.tabs.create({url:r});throw e}}He.then(()=>{Oe(ho,wo,!0)});const Io=Object.entries({author:null,description:null,homepageURL:"url",updateURL:"updateUrl",name:null});async function Eo(e,src){const t=e.usercssData,n=src.usercssData,{vars:s}=t,r=n?n.vars:src;if(s&&r){for(const[key,e]of Object.entries(s)){const t=r[key]&&r[key].value;null!=t&&(e.value=t)}t.vars=await jt.nullifyInvalidVars(s)}}async function To({styleId:e,sourceCode:t,vars:n,checkDup:s,metaOnly:r,assignVars:o,initialUrl:a}){a&&(t=await Yr(a));const i=await Do({sourceCode:t}),c=(s||o)&&Ao(e?{id:e}:i);let log;return r||((n||o)&&await Eo(i,n||c),await _o(i),log=i.log),{style:i,dup:c,log}}async function _o(e){const{sourceCode:t,usercssData:{vars:n,preprocessor:s}}=e,{sections:r,errors:o,log}=await jt.compileUsercss(s,t,n),a=o.every(e=>e.recoverable);if(!r.length||!a)throw a?"Style does not contain any actual CSS to apply.":o;return e.sections=r,log&&Object.defineProperty(e,"log",{value:log}),e}async function Do(e){if(e.usercssData)return e;const t=e.sourceCode=e.sourceCode.replace(/\r\n?/g,"\n");e=Object.assign({enabled:!0,sections:[]},e);const n=t.match(h);if(!n)return Promise.reject(new Error("Could not find metadata."));try{const{metadata:t}=await jt.parseUsercssMeta(n[0]);e.usercssData=t;for(const[key,n]of Io){const val=t[key];void 0!==val&&(e[n||key]=val)}return e}catch(e){if(e.code){const args="missingMandatory"===e.code||"missingChar"===e.code?e.args.map(e=>1===e.length?JSON.stringify(e):e).join(", "):e.args,msg=w(`meta_${e.code}`,args);msg&&(e.message=msg),e.index+=n.index}return Promise.reject(e)}}async function $o(e,t){const n=E(aa(e));return n.usercssData.vars=t,await _o(n),(await Bi(n,"config")).usercssData.vars}async function Oo(e){return{log:(e=await Po(e)).log,style:await Ri(e)}}function Ao(e){if(e.id)return aa(e.id);return Pi(v(e.usercssData||e,null,["name","namespace"]),"usercssData")}function jo(e){return Ao(e)?.usercssData.version}async function Ro(e,opts){return Bi(await Po(e,opts))}async function Po(e,{dup:t,vars:n}={}){return e=await Do(e),(t||(t=Ao(e)))&&(e.id=t.id),(n||(n=t))&&await Eo(e,n),_o(e)}const Uo={test:()=>!1},Mo=/\bextension\b/,Co=Wo(e=>`^(${e})$`),Lo=Wo(e=>`^${e}$`),No=Wo(function(e){const t=e.match(/^(\*|[\w-]+):\/\/(\*\.)?([\w.]+\/.*)/);if(!t)return"^"+qo(e)+"$";return"^"+("*"===t[1]?"[\\w-]+":t[1])+"://"+(t[2]?"(?:[\\w.]+\\.)?":"")+qo(t[3])+"$"});function qo(e){return f(e).replace(/\\\\\\\*|\\\*/g,e=>e.length>2?e:".*")}function Wo(e){const cache=new Map;return t=>{let n=cache.get(t);return n||cache.set(t,n=k(e(t))||Uo),n}}function Fo(e){return No(e).test(this.urlWithoutParams??=this.url.split(/[?#]/,1)[0])}function Bo(e,t){let n;return(n=t.exclusions)&&n.some(Fo,e)?"excluded":t.enabled?Un(t)?!(n=t.inclusions)||!n.some(Fo,e)||"included":"excludedScheme":"disabled"}function Ho(e,t,n){let s,r,o,a,i,c,l,u;return!!((s=t.domains)&&(r=s.length)&&s.some(Vo,e)||(o=t.urlPrefixes)&&(a=o.length)&&o.some(zo,e)||(l=t.urls)&&(u=l.length)&&(l.includes(e.url)||l.includes(e.urlWithoutHash??=e.url.split("#",1)[0]))||(i=t.regexps)&&(c=i.length)&&i.some(Jo,e))||(c&&i.some(Xo,e)?"sloppy":!(c||a||u||r||(e.isOwnPage??=e.url.startsWith(C))||n&&zn(t)))}function Vo(e){const t=this.domain??=S(this.url).hostname;return e===t||"."===t[t.length-e.length-1]&&t.endsWith(e)}function zo(e){return e&&this.url.startsWith(e)}function Jo(e){return(!(this.isOwnPage??=this.url.startsWith(C))||Mo.test(e))&&Co(e).test(this.url)}function Xo(e){return(!(this.isOwnPage??=this.url.startsWith(C))||Mo.test(e))&&Lo(e).test(this.url)}let Ko,Go={};const Qo={exposeIframes:"top",disableAll:"off",keepAlive:"wake",styleViaASS:"ass"};function Yo(key,val){"keepAlive"===(key=Qo[key]||key)&&(val=val>=0),Ko?Go[key]===val?delete Ko[key]:Ko[key]=val:(Ko={},Ko[key]=val,setTimeout(ta))}He.then(()=>{Oe(Object.keys(Qo),Yo)}),Le.add(Yo.bind(null,"dark"));const Zo={method:"injectorConfig",cfg:Ko};function ea(e){return Zo.cfg.top=e&&lo(e.url),Zo}function ta(){b(Ko)||(Zo.cfg=Ko,Mt(Zo,{getData:Ko.top&&ea,onlyIfStyled:!("off"in Ko||"dark"in Ko)})),Go=Ko,Ko=null}const na=new Map,sa={main:{},prio:{}},ra={id:"injectionOrder",value:v(sa,()=>[]),_id:`${chrome.runtime.id}-injectionOrder`,_rev:0};function oa({md5Url:e,updateUrl:t,usercssData:n}={}){let s;return s=(s=/\d+/.test(e)||J(t))&&`uso-${s}`||(s=X(t))&&`usw-${s}`||"",s&&[s,!!n?.vars]}const aa=e=>na.get(+e)?.style,ia=e=>aa(Fe.get(e)),ca=e=>({...aa(e.id)||{enabled:!0,installDate:Date.now()},...e});function la(e,t,n){return fa(e),Mt({method:n?"styleAdded":"styleUpdated",reason:t,style:{id:e.id,enabled:e.enabled}},{onlyIfStyled:!e.enabled})}async function ua(e,{broadcast:t,calc:n=!0,store:s=!0,sync:r}={}){if(e&&e.value&&!T(e.value,ra.value)){if(Object.assign(ra,e,r&&{_rev:Date.now()}),n)for(const[t,n]of Object.entries(e.value)){const e=sa[t]={};n.forEach((t,n)=>{const s=Fe.get(t);s&&(e[s]=n)})}t&&Yo("order",sa),s&&await un.put(ra,ra.id),r&&Ya(ra)}}function da(e){na.set(e.id,{style:e,appliesTo:new Set}),Fe.set(e._id,e.id)}function fa(e){const{id:t}=e,n=na.get(t),s=n.preview||e,r=new Set;for(const cache of As.values()){const e=cache.url;if(!n.appliesTo.has(e)){(cache.maybeMatch??=new Set).add(t);continue}const o=ma({url:e},s);if(o)r.add(e),ha(cache,s,o);else{if(!cache.sections[t])continue;delete cache.sections[t]}Ws(cache)}n.appliesTo=r}function pa(cache,e,t){const n={url:e};for(let s of t||na.values()){if(t&&!(s=na.get(s)))continue;const{style:r}=s,o=r.enabled&&ma(n,s.preview||r);o&&(ha(cache,r,o),s.appliesTo.add(e))}}function ha(e,t,[n,s]){Cs(e,t,n,s)}function ma(e,t){const n=Bo(e,t),s="included"===n,r=[],o=[];if(!s&&!0!==n)return;let a=0;for(const n of t.sections)!s&&!0!==Ho(e,n)||zn(n)||(r.push(n.code),o.push(a)),a++;return r.length&&[o,r]}Fe.addCustom(ra,{set:ua});const wa=crypto.randomUUID?.bind(crypto)||!1,ga={name:e=>`ID: ${e.id}`,_id:wa,_rev:Date.now},ya=({code:e})=>e.startsWith(":root {\n  --")&&/@import\s/i.test(e);function ba(e,t){let n,res=0;for(const key in ga)e[key]||(e[key]=ga[key](e),res=1);for(const key in e)n=e[key],(null==n||"object"==typeof n&&b(n))&&(delete e[key],res=1);const{originalName:s}=e;s&&(s!==e.name&&(e.customName=e.name,e.name=s),delete e.originalName,res=1);for(const key of["url","installationUrl"]){const t=e[key],n=t&&t.replace(/([^:]\/)\//,"$1");n!==t&&(res=1,e[key]=n)}return(n=e.md5Url)&&n.includes("update.update.userstyles")&&(res=e.md5Url=n.replace("update.update.userstyles","update.userstyles")),`${e.url}${e.installationUrl}`.includes("https://33kk.github.io/uso-archive/")&&(delete e.url,delete e.installationUrl),e.url&&e.installationUrl||!(n=e.updateUrl)||!(n=K(n)||(n=/\d+/.exec(e.md5Url))&&`${F}styles/${n[0]}`)||(e.url||(res=e.url=n),e.installationUrl||(res=e.installationUrl=n)),t&&(!Array.isArray(n=e.sections)&&(n=0,1)||e.usercssData?.vars&&n.some(ya))?n||e.sourceCode?_o(e):(e.customName="Damaged style #"+e.id,e.sections=[{code:"/* No sections or sourceCode */"}],e):res&&e}function va(e){if(!e.name)throw new Error("Style name is empty");e._id||(e._id=wa()),e.id||delete e.id,e._rev=Date.now(),ba(e)}function ka(e,t,n=e.id){null==e.id&&(e.id=n);const s=na.get(n);return s?s.style=e:da(e),!1!==t?la(e,t,!s):fa(e),"sync"!==t&&Ya(e),e}const xa={dropbox:{flow:"token",clientId:"zg52vphuapvpng9",authURL:"https://www.dropbox.com/oauth2/authorize",tokenURL:"https://api.dropboxapi.com/oauth2/token",revoke:e=>fetch("https://api.dropboxapi.com/2/auth/token/revoke",{method:"POST",headers:{Authorization:`Bearer ${e}`}})},google:{flow:"code",clientId:"283762574871-d4u58s4arra5jdan2gr00heasjlttt1e.apps.googleusercontent.com",clientSecret:"J0nc5TlR_0V_ex9-sZk-5faf",authURL:"https://accounts.google.com/o/oauth2/v2/auth",authQuery:{access_type:"offline",prompt:"consent"},tokenURL:"https://oauth2.googleapis.com/token",scopes:["https://www.googleapis.com/auth/drive.appdata"]},onedrive:{flow:"code",clientId:"3864ce03-867c-4ad8-9856-371a097d47b1",clientSecret:"9Pj=TpsrStq8K@1BiwB9PIWLppM:@s=w",authURL:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenURL:"https://login.microsoftonline.com/common/oauth2/v2.0/token",scopes:["Files.ReadWrite.AppFolder","offline_access"]},userstylesworld:{flow:"code",clientId:"zeDmKhJIfJqULtcrGMsWaxRtWHEimKgS",clientSecret:"wqHsvTuThQmXmDiVvOpZxPwSIbyycNFImpAOTxjaIRqDbsXcTOqrymMJKsOMuibFaijZZAkVYTDbLkQuYFKqgpMsMlFlgwQOYHvHFbgxQHDTwwdOroYhOwFuekCwXUlk",authURL:z+"api/oauth/style/link",tokenURL:z+"api/oauth/token",redirect_uri:"https://gusted.xyz/callback_helper/"}},Sa=30,Ia="https://clngdbkpkpeebahjckkjfobafhncgmne.chromiumapp.org/";class TokenError extends Error{constructor(e,message){super(`[${e}] ${message}`),this.name="TokenError",this.provider=e,Error.captureStackTrace&&Error.captureStackTrace(this,TokenError)}}function Ea(name,e){const t=`secure/token/${e?e.keyName(name):name}/`,n={TOKEN:`${t}token`,EXPIRE:`${t}expire`,REFRESH:`${t}refresh`};return n.LIST=Object.values(n),n}async function Ta(name,e,t){const n=Ea(name,t),obj=await Bt.get(n.LIST);if(obj[n.TOKEN]){if(!obj[n.EXPIRE]||Date.now()<obj[n.EXPIRE])return obj[n.TOKEN];if(obj[n.REFRESH])return Da(name,n,obj)}if(!e)throw new TokenError(name,"Token is missing");return $a(n,name,e,t)}async function _a(name,e){const t=xa[name],n=Ea(name,e);if(t.revoke)try{const e=await Bt.getValue(n.TOKEN);e&&await t.revoke(e)}catch(e){console.error(e)}await Bt.remove(n.LIST)}async function Da(name,e,obj){if(!obj[e.REFRESH])throw new TokenError(name,"No refresh token");const t=xa[name],n={client_id:t.clientId,refresh_token:obj[e.REFRESH],grant_type:"refresh_token",scope:t.scopes.join(" ")};t.clientSecret&&(n.client_secret=t.clientSecret);const s=await ja(t.tokenURL,n);return s.refresh_token||(s.refresh_token=obj[e.REFRESH]),Aa(s,e)}async function $a(e,name,t=!1,n=null){const s=xa[name],r=Math.random().toFixed(8).slice(2),o=s.redirect_uri||Ia,a={response_type:s.flow,client_id:s.clientId,redirect_uri:o,state:r};s.scopes&&(a.scope=s.scopes.join(" ")),s.authQuery&&Object.assign(a,s.authQuery),n?.query(a);const i=`${s.authURL}?${new URLSearchParams(a)}`,c=await Oa(i,t,o),l=new URLSearchParams("token"===s.flow?new URL(c).hash.slice(1):new URL(c).search.slice(1));if(l.get("state")!==r)throw new TokenError(name,`Unexpected state: ${l.get("state")}, expected: ${r}`);let u;if("token"===s.flow){const obj={};for(const[key,value]of l)obj[key]=value;u=obj}else{const e={code:l.get("code"),grant_type:"authorization_code",client_id:s.clientId,redirect_uri:a.redirect_uri,state:r};s.clientSecret&&(e.client_secret=s.clientSecret),u=await ja(s.tokenURL,e)}return Aa(u,e)}async function Oa(e,t,n){const s=chrome.identity.getRedirectURL();s!==n&&await xs([{id:ys,condition:{urlFilter:"|"+n,resourceTypes:["main_frame"]},action:{type:"redirect",redirect:{transform:{host:l(s)}}}}]);try{return await chrome.identity.launchWebAuthFlow({interactive:t,url:e})}finally{n&&await xs(void 0,[ys])}}async function Aa(e,t){return await Bt.set({[t.TOKEN]:e.access_token,[t.EXPIRE]:e.expires_in?Date.now()+1e3*(e.expires_in-Sa):void 0,[t.REFRESH]:e.refresh_token}),e.access_token}async function ja(e,t){const n={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:t?new URLSearchParams(t):null},s=await fetch(e,n);if(s.ok)return s.json();const r=await s.text(),err=new Error(`Failed to fetch (${s.status}): ${r}`);throw err.code=s.status,err}const Ra="syncNow",Pa="sync.enabled",Ua=10/60,Ma=1,Ca=30,La="sync/state/",Na=["webdav"],qa={state:"pending"},Wa=(e,t)=>e-t;let Fa,Ba,Ha,Va,za,Ja,Xa,lastError=null;async function Ka(...args){if(Va&&await ti(),Ba)return ci(),Fa.delete(...args)}function Ga(e){return Va&&!e&&ti(),qa}async function Qa(name){Va&&await ti(),name||(name=Ha),await _a(name);try{await Ta(name,!0),qa.login=!0}catch(e){throw qa.login=!1,e}finally{ri()}}async function Ya({_id:e,_rev:t}){if(Va&&await ti(),Ba)return ci(),Fa.put(e,t)}async function Za(e,t){const key=`secure/sync/driveOptions/${e}`;await ls({[key]:t})}async function ei(e){const key=`secure/sync/driveOptions/${e}`;return(await cs(key))[key]||{}}async function ti(name=Va){const e=name&&name===Va,t=qa.state===gs;if(Va=!1,(Fa??=mt({onGet:e=>ia(e)||Fe.custom[e],async onPut(e){if(!e)return;const t=Fe.get(e._id),n=!t&&Fe.custom[e._id],s=n||aa(t),r=s?Wa(s._rev,e._rev):-1;r&&(r>0?Ya(s):n?Fe.custom[e._id]=e:(delete e.id,t&&(e.id=t),e.id=await cn.put(e),await ka(e,"sync")))},onDelete(e,t){const n=Fe.get(e),s=aa(n);return s&&Wa(s._rev,t)<=0&&Vi(n,"sync")},onFirstSync(){for(const e of Object.values(Fe.custom).concat(Ui()))Fa.put(e._id,e._rev)},onProgress(e){"start"===e.phase?qa.syncing=!0:"end"===e.phase?(qa.syncing=!1,qa.progress=null):qa.progress=e,lastError&&li(),ri()},compareRevision:Wa,getState:e=>Bt.getValue(La+e.name),setState:(e,t)=>Bt.set({[La+e.name]:t}),retryMaxAttempts:10,retryExp:1.2,retryDelay:6})).then&&(Fa=await Fa),!Ba){if(Ha=name,Ba=ii(name).catch(console.error),Ba=await Ba,Fa.use(Ba),qa.state=ms,qa.drive=Ha,ri(),e||Na.includes(Ha))qa.login=!0;else try{await Qa(name)}catch(e){return console.error(e),li(e),ri(),ni()}await Fa.init(),t||(await si(),set(Pa,name),qa.state=hs,ri())}}async function ni(){if(Va){qa.state=gs;try{await ti()}catch{}}if(Ba){qa.state=gs,ri();try{await Fa.uninit(),await _a(Ha),await Bt.remove(La+Ha)}catch{}Ba=Ha=null,set(Pa,"none"),qa.state=ws,qa.drive=null,qa.login=!1,ri()}}async function si(){if(!Xa)if(Xa=!0,Va&&await ti(),Ba&&qa.login){try{await Fa.syncNow(),li()}catch(e){e.message=ui(e),li(e),oi(e)&&(qa.login=!1)}za&&(za(),za=null),Xa=!1,ri()}else console.warn("cannot sync when disconnected")}function ri(){Lt({method:"syncStatusUpdate",status:qa}),Rr(ai())}function oi(err){return 401===err.code||(!(400!==err.code||!/invalid_grant/.test(err.message))||"TokenError"===err.name)}function ai(){if(qa.state===hs&&(!qa.login||lastError&&!("TypeError"===(err=lastError).name&&/networkerror|failed to fetch/i.test(err.message)||502===err.code)))return{text:"x",color:"#F00",title:qa.login?`${w("syncError")}\n---------------------\n${lastError.message.replace(/.{60,}?\s(?=.{30,})/g,"$&\n")}`:"syncErrorRelogin"};var err}async function ii(name){if(!u(wt,name))throw new Error(`Unknown cloud provider: ${name}`);const opts=await ei(name),e="webdav"===name;if(e&&!S(opts.url))throw set(Pa,"none"),new Error("Broken options: WebDAV server URL is missing");return e||(opts.getAccessToken=()=>Ta(name)),wt[name](opts)}async function ci(t,n=Ha){if(Ja)return;Ja=!0;const s=t&&await browser.alarms.get(Ra);Va=u(wt,n)&&n,Va?(!s||Math.abs((s.periodInMinutes||1e99)-Ca)>1e-6||((s.scheduledTime-Date.now())/6e4+Ca)%Ca>(t?Ca:Ma))&&(chrome.alarms.create(Ra,{delayInMinutes:t?Ua:Ma,periodInMinutes:Ca}),za||e.keepAlive(new Promise(e=>za=e))):(qa.state=ws,s&&chrome.alarms.clear(Ra),t&&ri()),Ja=!1}function li(err){qa.errorMessage=err?.message,lastError=err}function ui(err){return"LockError"===err.name?browser.i18n.getMessage("syncErrorLock",new Date(err.expire).toLocaleString([],{timeStyle:"short"})):err.message||JSON.stringify(err)}chrome.alarms.onAlarm.addListener(async t=>{t.name===Ra&&(He&&await He,e.keepAlive(si()))}),Oe(Pa,ci,!0);const di=["description","homepage","license","name"],fi=[...di,"id","namespace","username"],pi=(e,val=!0)=>Me.set("usw"+e,val),hi=e=>Me.del("usw"+e);class TokenHooks{constructor(e){this.id=e}keyName(name){return`${name}/${this.id}`}query(e){return Object.assign(e,{vendor_data:this.id})}}function mi(e,t){const{namespace:n,username:s}=t||(t={}),r=["name",["@version",(new Date).toISOString().replace(/^(\d+)-(\d+)-(\d+)T(\d+):(\d+).+/,"$1$2$3.$4.$5")],["@namespace","?"!==n&&n||s&&`https://userstyles.world/user/${s}`||"?"],"description",["@homepage",S(n).href],["@author",s],"license"].map((n,s)=>n.map?n[1]&&n:(s=t[n]||e[n])&&["@"+n,s]).filter(Boolean),o=r.reduce((res,[e])=>Math.max(res,e.length),0);return"/* ==UserStyle==\n"+r.map(([e,t])=>`${e}${" ".repeat(o-e.length+2)}${t}\n`).join("")+"==/UserStyle== */\n\n"}async function wi(e,t){const{id:n,name}=e,{metadata:s}=await jt.parseUsercssMeta(t.match(h)[0]),r={name,sourceCode:t,usercssData:{}};for(const e of di)r[e]=r.usercssData[e]=s[e]||"";pi(n,r);try{const t=await Ta("userstylesworld",!0,new TokenHooks(n)),s=await gi("style",t),r=v(s,null,e.usercssData?["id"]:fi);return r.token=t,e.url=e.url||s.homepage||`${z}style/${r.id}`,r}finally{hi(n)}}async function gi(e,t,opts){return(opts=Object.assign({credentials:"omit"},opts)).headers=Object.assign({Authorization:`Bearer ${t}`},opts.headers),(await(await fetch(`${z}api/${e}`,opts)).json()).data}async function yi(e,t){const{id:n}=e;t?e._usw=t:t=e._usw,await zi(e,!1),Lt({method:"uswData",style:{id:n,_usw:t}})}async function bi(e,t,n){try{pi(e);const s=aa(e);n||(n=s._usw),s.usercssData||(t=mi(s,n)+t),n&&n.token&&n.id||(n=await wi(s,t));const res=await gi(`style/${n.id}`,n.token,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({code:t})});return T(n,s._usw)||await yi(s,n),res}finally{hi(e)}}async function vi(e){try{pi(e),await _a("userstylesworld",new TokenHooks(e));const t=aa(e);t&&(delete t._usw.token,await yi(t))}finally{hi(e)}}async function ki(e,t){let n,s,r,o,a,i;for(o=0,i=0;o<e.length;o++)if(a=e[o],+a.id>0&&"string"==typeof a._id&&"string"==typeof a.sections?.[0]?.code)da(a),t&&(o>i&&(e[i]=a),i++);else{try{n=ba(a,!0)}catch{}n?(s??=new Map).set(a.id,n):(r??=[]).push(a)}e.length=i,r&&console.error(`Skipped ${r.length} unrecoverable styles:`,r),s&&(console[t?"log":"warn"](`Fixed ${s.size} styles, ids:`,...s.keys()),s=await Promise.all([...s.values(),He]),s.pop(),t&&(e.push(...s),s.forEach(da))),e.length&&setTimeout(cn.putMany,100,e)}Pe.push(async()=>{let e,[t,n]=await Promise.all([un.get("injectionOrder"),cn.getAll(),Us()]);t||(t=await gn($e,"get","injectionOrder")),n[0]||(n=e=await gn("stylish","getAll")),ua(t,{store:!1}),ki(n,e),Ms(na)}),Le.add(()=>{for(const{style:e}of na.values())Tn.includes(e.preferScheme)&&la(e,"colorScheme")}),Ts=val=>{for(const e in val.sections)na.get(+e)?.appliesTo.delete(val.url)},nt.draft=e=>{e.resolve();const t=e.name.split(":")[1];ln.delete(+t||t).catch(()=>{})},nt.livePreview=e=>{e.resolve();const t=+e.name.split(":")[1],n=na.get(t);n&&(n.preview=null,la(n.style,"editPreviewEnd"))},tt.draft=tt.livePreview=t=>{e.keepAlive(new Promise(resolve=>{t.resolve=resolve}))};const xi=new Map,Si=["customName","name","url","installationUrl","updateUrl"],Ii=e=>e.usercssData?(e.sourceCode.match(h)||[""])[0]:null,Ei=e=>e.usercssData?e.sourceCode.replace(h,""):null,Ti=Object.assign(Object.create(null),{code:(e,t)=>e.usercssData?t(Ei(e)):$i(e,t,"code"),meta:(e,t,n)=>Si.some(key=>t(e[key]))||t("all"===n?e.sourceCode:Ii(e))||$i(e,t,"funcs"),name:(e,t)=>t(e.customName)||t(e.name),all:(e,t)=>Ti.meta(e,t,"all")||!e.usercssData&&Ti.code(e,t)});function _i({query:e,mode:t,ids:n}){t??="all";let res=[];if("url"===t&&e)res=Li(e).map(e=>e.style.id);else if(t in Ti){const s=Ti[t],r=/^\/(.+?)\/([gimsuy]*)$/.exec(e),o=r&&k(r[1],r[2]),a=o?o.test.bind(o):Di(e);for(let t of n||na.values())n&&!(t=na.get(t))||!(t=t.style)||e&&!s(t,a)||res.push(t.id);xi.size&&g(Ai,6e4)}return res}function Di(e){const t="u"+(Oi(e)===e?"i":""),n=e.split(/(".*?")|\s+/).filter(Boolean).map(e=>e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e).filter(e=>e.length>1),s=(n.length?n:[e]).map(e=>p(e,t));return e=>s.every(t=>t.test(e))}function $i({sections:e},t,n){const s="code"===n||"all"===n,r="funcs"===n||"all"===n;for(const n of e)for(const e in n){const value=n[e];if(s&&"code"===e&&t(value)||r&&Array.isArray(value)&&value.some(str=>t(str)))return!0}}function Oi(e){let t=xi.get(e);return t||xi.set(e,t=e.toLocaleLowerCase()),t}function Ai(){xi.clear()}async function ji(e,t,value){const n=Object.assign({},aa(e)),s=na.get(e);n[t]=(s.preview||{})[t]=value,"inclusions"!==t&&"exclusions"!==t||Rs(),await zi(n,"config")}function Ri(e){return(e=ca(e)).updateDate=Date.now(),ln.delete(e.id).catch(()=>{}),zi(e,"editSave")}function Pi(e,t){for(const{style:n}of na.values()){let obj=t?n[t]:n;if(obj){for(const key in e)if(e[key]!==obj[key]){obj=null;break}if(obj)return n}}}const Ui=()=>Array.from(na.values(),e=>e.style),Mi=()=>ra.value;function Ci(e){const res=v(ra.value,e=>e.map(ia).filter(Boolean));if(res.main.length+res.prio.length<na.size)for(const{style:e}of na.values())e.id in sa.main||e.id in sa.prio||res.main.push(e);return e?v(res,t=>t.map(t=>v(t,null,e))):res}function Li(e,t=null){const n=[],s={url:e};for(const{style:e}of t?[na.get(t)].filter(Boolean):na.values()){let t=!0,r=!1,o=!1,a=!1,i=!1,c=!1,l=Bo(s,e);"included"===l&&(a=!0),"excluded"===l&&(r=!0),"excludedScheme"===l&&(o=!0);for(const n of e.sections)l=Ho(s,n,!0),l&&("sloppy"===l&&(i=!0),c=!0,t&&(t=zn(n)));(c||a)&&n.push({empty:t,excluded:r,excludedScheme:o,included:a,sectionMatched:c,sloppy:i,style:Ni({id:e.id})})}return n}function Ni({id:e,code:t,sections:n,size:s,vars:r}={}){const res=[];for(let{style:o}of e?[na.get(e)]:na.values()){let e;o={...o},s&&(o._size=y(o)),!t&&n&&(e=o.sections.map(e=>({...e,code:void 0}))),t&&n||(o.sections=e),t||(o.sourceCode=void 0),!r&&(e=o.usercssData)&&e.vars&&(o.usercssData={...e,vars:{}}),res.push(o)}return e?res[0]:res}function qi(e){if(e)return oa(aa(e));const res={};for(const{style:e}of na.values()){const[t,n]=oa(e);t&&(res[t]=[e.id,n])}return res}function Wi(e,t,n){const s=_e;if(n&&s.disableAll)return{cfg:{off:!0}};const{sender:r={}}=this||{},{tab:o={},frameId:a,TDM:i}=r,c=!a||i||"main_frame"===r.type,l=xt[r.tabId||o.id]||{},u=!t&&{ass:s.styleViaASS,dark:c&&Pn,name:s.exposeStyleName,nonce:l.nonce?.[a],top:n&&s.exposeIframes&&(c?"":lo(o.url||l.url?.[0])),wake:s.keepAlive>=0,order:sa};if("cfg"===n)return{cfg:u};let res,cache;var val;return 0===a&&"styleViaXhr"!==n&&(res=l.url)&&(res=res[0])!==e&&res.split("#",1)[0]===e.split("#",1)[0]&&(e=res||e),cache=js(e),cache?(res=cache.maybeMatch)&&pa(cache,e,res):(cache={url:e,sections:{}},$s.set((val=cache).url,Ws(val)),$s.size>=Ds&&Ls([...$s.values()].filter(val=>val.d).sort(({d:[e,t]},{d:[n,s]})=>100*(e-n)+10*(s-n-(t-e))+t-s).slice(0,10)),pa(cache,e)),res=cache.sections,res=t?(res=res[t])?[res]:[]:Object.values(res),!0===n&&res.length&&((l.url??={})[a]??=e),{cfg:u,sections:res}}async function Fi(e){const res=[],t=[];for(const n of e)try{va(n),n.sourceCode&&n.usercssData&&await _o(n),res.push(t.push(n)-1)}catch(e){res.push({err:e})}const n=await cn.putMany(t),s=[];for(let e,r=0;r<res.length;r++)if(e=res[r],!e.err){const o=n[e],a=na.has(o)?"styleUpdated":"styleAdded",i=ka(t[e],!1,o);s.push([i,"import",a]),res[r]={style:{...i,_size:y(i)}}}return Rs(),setTimeout(()=>s.forEach(args=>la(...args)),100),Promise.all(res)}async function Bi(e,t=(na.has(e.id)?"update":"install")){return(e=ca(e)).originalDigest=await Yn(e),zi(e,t)}async function Hi(e){let res=e.sourceCode||!1;return res&&(res=await To({styleId:e.id,sourceCode:res,assignVars:!0}),delete res.style.enabled,Object.assign(e,res.style)),na.get(e.id).preview=e,la(e,"editPreview"),res.log}function Vi(e,t){const{style:n,appliesTo:s}=na.get(e),r="sync"!==t,o=n._id;cn.delete(e),r&&Ka(o,Date.now());for(const t of s){const cache=js(t);cache&&delete cache.sections[e]}return na.delete(e),Fe.delete(o),v(ra.value,(t,n)=>{delete sa[n][e];const s=t.indexOf(o);s>=0&&t.splice(s,1)}),ua(ra,{calc:!1}),n._usw&&n._usw.token&&vi(e),ln.delete(e).catch(()=>{}),Mt({method:"styleDeleted",style:{id:e}},{onlyIfStyled:!0}),e}async function zi(e,t){va(e);return ka(e,t,await cn.put(e))}async function Ji(value){await ua({value},{broadcast:!0,sync:!0})}async function Xi(e,t){await zi({...aa(e),enabled:t},"toggle")}async function Ki(e,t,n,s){const r=Object.assign({},aa(e)),o=n?"inclusions":"exclusions";let a=r[o];if(s){if(a){if(a.includes(t))throw new Error("The rule already exists")}else a=r[o]=[];a.push(t)}else{if(!a)return;{const e=a.indexOf(t);e>=0&&a.splice(e,1)}}Rs(),await zi(r,"config")}async function Gi(){let e=await ce();var t;P&&"loading"===e.status&&"about:blank"===e.url&&(e=await(t=e.id,new Promise(resolve=>{browser.tabs.onUpdated.addListener(function e(n,s,r){s.url&&n===t&&(browser.tabs.onUpdated.removeListener(e),resolve(r))},..."UpdateFilter"in browser.tabs?[{tabId:t}]:[])})));let n,s=e.url||e.pendingUrl||"";const r=xt[e.id],o=s.startsWith(C),[a=!r?.popup&&(St(e.id,"popup",!0),await Bn(e)),i]=await Promise.all([o||Y(s)&&Nt(e.id),o&&R&&Qi(s,e)||browser.webNavigation.getAllFrames({tabId:e.id})]),c=new Map(i.map(e=>[e.frameId,e])),l=new Map,u=new Set(["about:blank"]);if(r&&(n=r.styleIds))for(let e in n)if(!c.has(e=+e)){const t=r.url[e];c.set(e,{frameId:e,parentFrameId:0,styles:Li(t),url:t})}l.set(0,c.get(0)||{frameId:0,url:""}),c.delete(0);let d=0;for(;c.size!==d;){for(const[e,t]of c)l.has(t.parentFrameId)&&(c.delete(e),t.errorOccurred||l.set(e,t),"about:blank"===t.url&&(t.url=l.get(t.parentFrameId).url));d=c.size}i.length=0;for(const e of[l,c])for(const t of e.values()){const e=t.url??="";t.isDupe=u.has(e),u.add(e),i.push(t)}i[0].url=s;const f=Y(s);if(f){He&&await He;for(const e of i)e.url&&!e.isDupe&&(e.styles??=Li(e.url))}return[i,a,e,f]}async function Qi(e,{id:t}){let res;return res=await chrome.runtime.getContexts({tabIds:[t]}),res=res[1]?.documentUrl,[{frameId:0,url:e},res&&{frameId:1,parentFrameId:0,url:res}].filter(Boolean)}const Yi={},Zi=()=>ls({[$e]:Yi});let value;set._bgSet=(key,val)=>{const e=Ee[key];if(val===e||val&&"object"==typeof e&&T(val,e)){if(!(key in Yi))return;delete Yi[key]}else Yi[key]=val;return He||g(Zi),!0},Re.push(cs($e).then(e=>{var val;return Se.set("object"==typeof(val=e=e[$e])&&val?I(e):{},{}),T(e,Yi)||He.then(Zi),Se}));const key=is.usercssTemplate;async function ec(){return value??=ds(key),value.then&&(value=await value),value}ie.addListener(e=>{(e=e[key])&&(value=us(e.newValue))});const tc="editorScrollInfo",nc={headers:{"cache-control":"no-cache"}},sc=`${function(e){Object.assign(this.clientData,e)}}`,rc={edit(e){const t=+e.searchParams.get("id"),n=aa(t),s=n?"usercssData"in n:_e.newStyleAsUsercss,r=tc+t;return{style:n,isUC:s,si:n&&dn.get(r),template:!n&&s&&(value||ec())}},manage(e){const t=e.searchParams,n=t.get("search")||void 0;return{badFavs:_e["manage.newUI"]&&_e["manage.newUI.favicons"]&&un.get("badFavs"),ids:n&&_i({query:n,mode:t.get("searchMode")||_e["manage.searchMode"]}),styles:Ni({sections:!0,size:!0}),sync:Ga(!0)}},options:()=>{const e=Ga(),{drive:t}=e;return{sync:e,syncOpts:t?ei(t):{},wrb:nr}},popup:()=>({popup:Me.pop("popup")||Gi()})};async function oc({dark:e,url:t}={}){Dn(e),He&&await He;const n=new URL(t),s=n.pathname.slice(1,-5),r=Object.assign({apply:Wi(t,null,!0),dark:Pn,favicon:P||Be,prefs:Yi},rc[s]?.(n)),results=await Promise.all(Object.values(r));return Object.keys(r).forEach((e,t)=>r[e]=results[t]),new Response(`(${sc})(${JSON.stringify(r)})`,nc)}Object.assign(API,{saveScroll(e,t){dn.put(t,tc+e)}});const ac="styleManager",ic="openManage",cc="openOptions",lc="reload",uc="styleDisableAll",dc=()=>ao(),fc=()=>ao({options:!0}),pc=()=>chrome.runtime.reload(),hc=e=>Se.then(()=>set("disableAll",e?e.checked:!_e.disableAll)),mc={[ic]:dc,[cc]:fc,[lc]:pc,[uc]:hc},wc=chrome.contextMenus,gc=wc?Object.assign({"show-badge":[function(e){set(e.menuItemId,e.checked)},{title:"menuShowBadge"}],disableAll:[hc,{title:"disableAllStyles"}],[ac]:[dc],[cc]:[fc],[lc]:[pc]},R&&{"editor.contextDelete":[(e,t)=>{qt(t.id,{method:"editDeleteText"})},{title:"editDeleteText",type:"normal",contexts:["editable"],documentUrlPatterns:[C+"*"]}]}):{};function yc(){function e(e,s){for(const r of e){const e=gc[r][1]??={};if(s&&(e.id=r,e.contexts??=["action"],e.title=w(e.title??r)),"boolean"==typeof Ee[r])if(e.type){if(s){Oe(r,n,!0);continue}}else e.type="checkbox",e.checked=_e[r],s&&Oe(r,t);wc.create(e,le)}}function t(e,t){wc.update(e,{checked:t},le)}function n(t,n){n?e([t]):wc.remove(t,le)}e(Object.keys(gc),!0)}chrome.commands?.onCommand.addListener(e=>mc[e]()),wc?.onClicked.addListener((e,t)=>gc[e.menuItemId][0](e,t));const bc=/^(.*?)-([-.0-9a-z]+)|$/i,vc=/^\d+$/;function kc(e,t){const[,n=e||"",s]=bc.exec(e),[,r=t||"",o]=bc.exec(t),a=xc(n,r)||!s-!o||s&&xc(s,o,!0);return Math.sign(a||0)}function xc(e,t,n){const s=e.split("."),r=t.split("."),o=s.length,a=r.length,i=(n?Math.min:Math.max)(o,a);let c;for(let e=0;!c&&e<i;e+=1){const t=s[e],o=r[e];c=n?vc.test(t)&&vc.test(o)?t-o:t>o||t<o&&-1:(parseInt(t,10)||0)-(parseInt(o,10)||0)}return c||n&&o-a}const Sc={},Ic=e=>`https://update.userstyles.org/${e}.md5`;function Ec(e){const t=Ac(e);return!!t&&Vi(t.id)}function Tc(e){const t=arguments[0],n=e.includes("@updateURL")&&(t?e:e.replace(h,"")).match(h);return n&&Do({sourceCode:n[0]}).catch(()=>null)}async function _c(e,t){const n=Ic(e),s=await _(n),r=await Ac(e,n),o=r?r.usercssData||r.originalMd5===s?2:1:0;return t?{dup:r,md5:s,md5Url:n,state:o}:o}function Dc(t,n){return clearTimeout(Sc[t]),delete Sc[t],n>0?e.keepAlive(new Promise(resolve=>Sc[t]=setTimeout(jc,n,t,resolve))):!1!==n?jc(t):void 0}async function $c(e,t,n,s,r,o){let a;s||(s=!1);const{updateUrl:i=G("usoa",e)}=s,c=[!s&&_c(e,!0).then(res=>({dup:s,md5:r,md5Url:o}=res)),!n&&Yr(i).then(res=>n=res)].filter(Boolean);c[0]&&await Promise.all(c);const{style:l}=await To({sourceCode:n,metaOnly:!0}),u=(a=t||s.updateUrl)&&Oc(l,a,{});if(s)return l;l.md5Url=o,l.originalMd5=r,l.updateUrl=i,await Ro(l,{dup:s,vars:u})}function Oc(e,src,t){src="string"==typeof src?new URLSearchParams(src.split("?")[1]):Object.entries(src);const{vars:n}=e.usercssData;if(n){for(let[key,val]of src){if(!key.startsWith("ik-"))continue;key=Rc(key.slice(3),t);const e=n[key];if(e)if(e.options){let s=val.startsWith("ik-")&&Pc(e,Rc(val.slice(3),t));s||(key+="-custom",s=Pc(e,key+"-dropdown"),s&&(n[key].value=val)),s&&(e.value=s.name)}else e.value=val}return e}}function Ac(e,t=Ic(e)){return Pi({md5Url:t})||Pi({installationUrl:K("usoa",e)})}async function jc(e,resolve){return await fetch(`${F}styles/install/${e}?source=stylish-ch`),resolve&&resolve(!0),!0}function Rc(key,e){let res=e[key];if(!res&&key!==(res=key.replace(/[^-\w]/g,"-"))){for(;res in e;)res+="-";e[key]=res}return res}function Pc(e,name){return e.options.find(e=>e.name===name)}const Uc={UPDATED:"updated",SKIPPED:"skipped",UNREACHABLE:"server unreachable",EDITED:"locally edited",MAYBE_EDITED:"may be locally edited",SAME_MD5:"up-to-date: MD5 is unchanged",SAME_CODE:"up-to-date: code sections are unchanged",SAME_VERSION:"up-to-date: version is unchanged",ERROR_MD5:"error: MD5 is invalid",ERROR_JSON:"error: JSON is invalid",ERROR_VERSION:"error: version is older than installed style"},Mc=()=>Uc,Cc=()=>{},Lc=t=>e.keepAlive(d(t)),Nc={responseHeaders:["etag"]},qc=new RegExp([/^(\d{4})/,/(0[1-9]|1(?:0|[12](?=\d\d))?|[2-9])/,/(0[1-9]|[1-2][0-9]?|3[0-1]?|[4-9])/,/\.([01][0-9]?|2[0-3]?|[3-9])/,/\.([0-5][0-9]?|[6-9])$/].map(e=>e.source).join("")),Wc="scheduledUpdate",Fc=6e4,Bc=[503,429],Hc=1e3,Vc={};let zc,Jc=!1,Xc=[],Kc=0;async function Gc({save:e=!0,ignoreDigest:t,observe:n,onlyEnabled:s=_e.updateOnlyEnabled}={}){sl(),Jc=!0;const r=n&&chrome.runtime.connect({name:"updater"}),o=Ui().filter(e=>e.updateUrl&&!1!==e.updatable&&(!s||e.enabled));r&&r.postMessage({count:o.length}),log(""),log(`${e?"Scheduled":"Manual"} update check for ${o.length} styles`),await Promise.all(o.map(n=>Qc({style:n,port:r,save:e,ignoreDigest:t}))),r&&r.postMessage({done:!0}),r&&r.disconnect(),log(""),Jc=!1}async function Qc(opts){let{id:e}=opts;const{style:t=aa(e),ignoreDigest:n,port:s,save:r}=opts;e||(e=t.id);const{md5Url:o}=t;let res,a,{usercssData:i,updateUrl:c}=t;try{await async function(){if(!n&&t.originalDigest&&t.originalDigest!==await Yn(t))return Promise.reject(Uc.EDITED)}(),res={style:await(i&&!o?l:async function(){const e=await Yc(o);if(!e||32!==e.length)return Promise.reject(Uc.ERROR_MD5);if(e===t.originalMd5&&t.originalDigest&&!n)return Promise.reject(Uc.SAME_MD5);const s=+o.match(/\/(\d+)/)[1];let r="";i||(i={},r=c);c=t.updateUrl=`${B}Css/${s}`;const{result:a}=await Yc(c,{responseType:"json"}),u=await l(a)||await $c(s,r,a,t,e,o);return u.originalMd5=e,u})().then(async function(s){s.id=e,delete s.customName,delete s.enabled;const o=Object.assign({},t,s);if(o.updateDate=el(o)||Date.now(),!i&&Jn(s,t))return t.originalDigest=(await Bi(o)).originalDigest,Promise.reject(Uc.SAME_CODE);if(!t.originalDigest&&!n)return Promise.reject(Uc.MAYBE_EDITED);return r?i?Ro(o,{dup:t}):Bi(o):o}),updated:!0},a=Uc.UPDATED}catch(e){const error=0===e&&Uc.UNREACHABLE||e&&e.message||e;res={error,style:t,STATES:Uc},a=`${Uc.SKIPPED} (${Array.isArray(e)?e[0].message:error})`}return log(`${a} #${e} ${t.customName||t.name}`),s&&s.postMessage(res),res;async function l(e){let s=i.version,r=t.etag;const o=(e||J(c))&&await Tc(e||t.sourceCode);if(o&&o.updateUrl)c=o.updateUrl,s=o.usercssData.version||"0",r="";else if(e)return;if(r&&r===await Zc(c))return Promise.reject(Uc.SAME_CODE);const{headers:{etag:a},response:l}=await Yc(c,Nc),u=await Do({sourceCode:l,etag:a,updateUrl:c}),d=kc(u.usercssData.version,s);let err;return d||n||(err=l===t.sourceCode?Uc.SAME_CODE:!Z(c)&&Uc.SAME_VERSION),d<0&&(err=Uc.ERROR_VERSION),err&&a&&!t.etag&&(t.etag=a,await cn.put(t)),err?Promise.reject(err):u}}async function Yc(e,t,{retryDelay:n=Hc}={}){for(;;){let s,r;try{return t=I(t||{},{headers:{"Cache-Control":"no-cache"}}),s=l(e),r=Vc[s],r=Vc[s]=(r?r.catch(Cc).then(()=>Lc(Hc/(ee(e)?4:1))):Promise.resolve()).then(()=>Yr(e,t)),await r}catch(e){if(!Bc.includes(e)||n>Fc)throw e}finally{Vc[s]===r&&delete Vc[s]}n*=1.25,await Lc(n)}}async function Zc(e){return(await Yc(e,{method:"HEAD",...Nc})).headers.etag}function el(e){const t=qc.exec(e.usercssData?.version);if(t)return t[2]--,new Date(...t.slice(1)).getTime()}function tl(){const e=60*_e.updateInterval*60*1e3;if(e>0){const t=Math.max(0,Date.now()-zc);chrome.alarms.create(Wc,{when:Date.now()+Math.max(Fc,e-t)})}else chrome.alarms.clear(Wc,le)}async function nl({name}){name===Wc&&(He&&await He,e.keepAlive(Gc()))}function sl(){Bt.set({lastUpdateTime:zc=Date.now()}),tl()}function log(e){Xc.push({text:e,time:(new Date).toLocaleString()}),g(rl,e&&Jc?1e3:0)}async function rl(e){if(!e)return void rl(await Bt.getValue("updateLog")||[]);const t=Date.now()-Kc>11e3?Xc[0].time+" ":"";Xc[0]&&!Xc[0].text&&(Xc.shift(),e[e.length-1]&&e.push("")),e.splice(0,e.length-1e3),e.push(t+(Xc[0]&&Xc[0].text||"")),e.push(...Xc.slice(1).map(e=>e.text)),Bt.set({updateLog:e}),Kc=Date.now(),Xc=[]}async function ol(){await Or(),await d(1e3);const e=Date.now()-432e5;for(const t of await ln.getAllKeys()){const{date:n}=await ln.get(t)||{};n<e&&ln.delete(t)}}He.then(async()=>{zc=await Bt.getValue("lastUpdateTime")||Date.now(),Oe("updateInterval",tl,!0),chrome.alarms.onAlarm.addListener(nl)}),Object.assign(API,{data:Me,download:Yr,openEditor:async function(e){const t=new URL(chrome.runtime.getURL("edit.html"));t.search=new URLSearchParams(e);const n=ae&&_e.openEditInWindow,s=n&&_e.windowPosition,r=n&&_e["openEditInWindow.popup"]?{type:"popup"}:{},o=n&&P;for(let e,a=0;a<(s?2:1);++a)try{return e=e||await io({url:`${t}`,currentWindow:null,newWindow:n&&Object.assign({},r,!o&&!a&&s)}),o&&!a&&await ae.update(e.windowId,s),e}catch{}},openManager:ao,openURL:io,pingTab:Nt,setPrefs:e=>{for(const t in e)set(t,e[t])},setSystemDark:Dn,updateIconBadge:jr,styles:o,sync:n,updater:i,usercss:t,uso:a,usw:r},!1,!1),chrome.runtime.onInstalled.addListener(({reason:e,previousVersion:t})=>{R&&(Bn(),yc()),"install"===e&&(U&&set("manage.newUI",!1),M&&set("editor.keyMap","sublime")),"1.5.30"===t&&un.delete("badFavs"),(Re.length?Re:Pe).push(Rs()),(Re.length?Re:Pe).push(dn.clear(),vs.getDynamicRules().then(e=>ks(void 0,Is(e))),vs.getSessionRules().then(e=>xs(void 0,Is(e)))),Or(),(async()=>{He&&await He,_e[ho]&&go(!0),yn(na)})()}),chrome.storage.session.get("init",async({init})=>{init||(chrome.storage.session.set({init:!0}),ol(),await He,Bn())}),onMessage.set((e,t)=>{if("invokeAPI"===e.method){let res=API;for(const t of e.path.split("."))res=res&&res[t];if(!res)throw new Error(`Unknown API.${e.path}`);return res=res.apply({msg:e,sender:t},e.args),res??null}},!0),(async()=>{const e=Re.length;await Promise.all(Re),await Promise.all(Re.slice(e)),Re.length=0,await Promise.all(Pe.map(e=>"function"==typeof e?e():e)),He.resolve()})(),e.oninstall=evt=>{evt.addRoutes({condition:{urlPattern:`${C}*.html?clientData*`},source:"fetch-event"}),evt.addRoutes({condition:{not:{urlPattern:`${C}*.user.css`,requestDestination:"document"}},source:"network"})},e.onfetch=evt=>{const e=evt.request.url;if(e.startsWith(C))if(e.includes("?clientData")){const t=new URL(e).searchParams,n=!!+t.get("dark"),s=t.get("url"),r=oc({dark:n,url:s});Ue.set(s,r),r.finally(()=>Ue.delete(s)),evt.respondWith(r)}else/\.user.css#(\d+)$/.test(e)&&evt.respondWith(Response.redirect("edit.html?id="+RegExp.$1))},e.onmessage=be.bind(ot),wt.webdav=async e=>{const res=await _t.webdavInit(e),t=_t.webdav;for(const e in res)res[e]??=t.bind(null,e);return res},chrome.webRequest.onBeforeRequest.addListener(()=>{},{urls:[C+"*.html*"],types:["main_frame","sub_frame"]})})()})()}